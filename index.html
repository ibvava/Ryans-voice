<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ryan's AAC">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="description" content="Ryan's personalised communication app">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>Ryan's Voice</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=DM+Serif+Display&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #0f0f1a;
            --bg-card: #1a1a2e;
            --bg-surface: #16213e;
            --bg-elevated: #1f2b47;
            --accent-primary: #6c63ff;
            --accent-glow: #7c74ff;
            --accent-warm: #ff6b6b;
            --accent-success: #4ecdc4;
            --accent-gold: #ffd93d;
            --text-primary: #e8e8f0;
            --text-secondary: #8b8ba3;
            --text-muted: #5a5a7a;
            --border-subtle: rgba(108, 99, 255, 0.15);
            --border-active: rgba(108, 99, 255, 0.4);
            --shadow-card: 0 8px 32px rgba(0, 0, 0, 0.3);
            --radius-sm: 12px; --radius-md: 18px; --radius-lg: 24px; --radius-xl: 32px;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; -webkit-touch-callout:none; }
        html, body { height:100%; overflow:hidden; }
        body { font-family:'DM Sans',-apple-system,BlinkMacSystemFont,sans-serif; background:var(--bg-deep); color:var(--text-primary); display:flex; flex-direction:column; height:100vh; height:100dvh; user-select:none; -webkit-user-select:none; }

        /* HEADER */
        .header { padding:calc(var(--safe-top) + 8px) 20px 12px; display:flex; justify-content:space-between; align-items:center; background:var(--bg-card); border-bottom:1px solid var(--border-subtle); flex-shrink:0; z-index:100; }
        .header-left { display:flex; align-items:center; gap:12px; }
        .header-title { font-family:'DM Serif Display',serif; font-size:22px; letter-spacing:-0.3px; }
        .context-badge { background:rgba(108,99,255,0.15); color:var(--accent-glow); padding:6px 14px; border-radius:20px; font-size:13px; font-weight:600; border:1px solid rgba(108,99,255,0.25); }
        .back-btn { display:none; background:rgba(108,99,255,0.12); border:1px solid rgba(108,99,255,0.2); color:var(--accent-glow); width:40px; height:40px; border-radius:12px; font-size:20px; cursor:pointer; align-items:center; justify-content:center; transition:all 0.2s; }
        .back-btn:active { transform:scale(0.92); }
        .back-btn.visible { display:flex; }

        /* SCREENS */
        .screen { display:none; flex-direction:column; flex:1; overflow:hidden; }
        .screen.active { display:flex; }

        /* HOME */
        .home-scroll { flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch; padding:24px 20px calc(var(--safe-bottom) + 20px); }
        .home-greeting { font-family:'DM Serif Display',serif; font-size:28px; margin-bottom:6px; }
        .home-subtitle { color:var(--text-secondary); font-size:15px; margin-bottom:20px; }
        .section-label { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:1.2px; color:var(--text-muted); margin:20px 0 10px; }
        .section-label:first-of-type { margin-top:0; }
        .context-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
        .context-tile { background:var(--bg-card); border:1px solid var(--border-subtle); border-radius:var(--radius-lg); padding:22px 16px; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; cursor:pointer; transition:all 0.2s; min-height:130px; position:relative; overflow:hidden; }
        .context-tile::before { content:''; position:absolute; inset:0; background:radial-gradient(ellipse at 50% 0%,rgba(108,99,255,0.06),transparent 70%); pointer-events:none; }
        .context-tile:active { transform:scale(0.96); border-color:var(--border-active); }
        .context-tile .tile-icon { font-size:36px; margin-bottom:10px; }
        .context-tile .tile-label { font-size:14px; font-weight:600; line-height:1.35; }
        .context-tile .tile-count { font-size:11px; color:var(--text-muted); margin-top:4px; }
        .context-tile.coming-soon { opacity:0.45; }
        .context-tile.coming-soon .tile-label::after { content:' (soon)'; color:var(--text-muted); font-weight:400; font-size:11px; }
        .context-grid.urgent-grid { grid-template-columns:1fr; }
        .context-tile.urgent-tile { border-color:rgba(255,107,107,0.4); background:linear-gradient(135deg,rgba(255,107,107,0.08),rgba(255,160,60,0.06)); min-height:90px; flex-direction:row; gap:14px; padding:18px 22px; }
        .context-tile.urgent-tile .tile-icon { font-size:32px; margin:0; }
        .context-tile.urgent-tile .tile-label { color:var(--accent-warm); font-size:16px; }
        .context-tile.urgent-tile .tile-count { color:rgba(255,107,107,0.6); margin:0; }
        .context-tile.urgent-tile:active { border-color:var(--accent-warm); background:rgba(255,107,107,0.12); }

        /* CARD SWIPE */
        .swipe-area { flex:1; display:flex; flex-direction:column; overflow:hidden; }
        .card-viewport { flex:1; position:relative; display:flex; align-items:center; justify-content:center; padding:16px; touch-action:pan-y; }
        .phrase-card { width:100%; max-width:600px; background:var(--bg-card); border:2px solid var(--border-subtle); border-radius:var(--radius-xl); padding:36px 24px 28px; display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:280px; position:relative; box-shadow:var(--shadow-card); transition:border-color 0.3s; will-change:transform; }
        .phrase-card::before { content:''; position:absolute; top:0; left:50%; transform:translateX(-50%); width:60%; height:1px; background:linear-gradient(90deg,transparent,var(--accent-primary),transparent); opacity:0.4; }
        .phrase-card.speaking { border-color:var(--accent-success); }
        .card-category-tag { position:absolute; top:14px; right:14px; font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:var(--text-muted); background:rgba(108,99,255,0.08); padding:3px 8px; border-radius:6px; }
        .card-freq-badge { position:absolute; top:14px; left:14px; font-size:10px; font-weight:700; color:var(--accent-gold); background:rgba(255,217,61,0.1); padding:3px 8px; border-radius:6px; display:none; }
        .card-freq-badge.visible { display:block; }
        .phrase-text { font-family:'DM Serif Display',serif; font-size:26px; line-height:1.45; text-align:center; margin-bottom:28px; max-width:520px; }
        .phrase-sub { font-size:13px; color:var(--text-muted); margin-top:-20px; margin-bottom:24px; font-style:italic; }
        .speak-btn { background:var(--accent-primary); color:white; border:none; padding:16px 44px; border-radius:50px; font-family:'DM Sans',sans-serif; font-size:17px; font-weight:700; cursor:pointer; transition:all 0.15s; box-shadow:0 4px 20px rgba(108,99,255,0.35); }
        .speak-btn:active { transform:scale(0.95); }
        .speak-btn.speaking { background:var(--accent-success); box-shadow:0 4px 20px rgba(78,205,196,0.35); }

        /* Card nav */
        .card-nav { display:flex; align-items:center; justify-content:center; gap:14px; padding:6px 20px 2px; }
        .card-arrow { background:var(--bg-elevated); border:1px solid var(--border-subtle); color:var(--text-secondary); width:44px; height:44px; border-radius:50%; font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.15s; flex-shrink:0; }
        .card-arrow:active { transform:scale(0.9); background:var(--accent-primary); color:white; }
        .card-arrow:disabled { opacity:0.2; pointer-events:none; }
        .card-dots { display:flex; gap:5px; align-items:center; overflow:hidden; max-width:180px; }
        .dot { width:7px; height:7px; border-radius:50%; background:var(--text-muted); opacity:0.35; transition:all 0.3s; flex-shrink:0; }
        .dot.active { background:var(--accent-primary); opacity:1; width:20px; border-radius:4px; }
        .card-counter { text-align:center; font-size:12px; color:var(--text-muted); padding:2px 0 8px; font-weight:500; }

        /* Category bar */
        .category-bar { display:flex; gap:7px; padding:10px 14px; overflow-x:auto; -webkit-overflow-scrolling:touch; border-top:1px solid var(--border-subtle); background:var(--bg-card); flex-shrink:0; scrollbar-width:none; }
        .category-bar::-webkit-scrollbar { display:none; }
        .cat-btn { background:var(--bg-elevated); border:1px solid var(--border-subtle); color:var(--text-secondary); padding:8px 16px; border-radius:25px; font-family:'DM Sans',sans-serif; font-size:13px; font-weight:600; cursor:pointer; white-space:nowrap; transition:all 0.2s; flex-shrink:0; }
        .cat-btn.active { background:var(--accent-primary); color:white; border-color:var(--accent-primary); }
        .cat-btn:active { transform:scale(0.95); }

        /* Bottom nav */
        .bottom-nav { display:flex; border-top:1px solid var(--border-subtle); background:var(--bg-card); padding-bottom:var(--safe-bottom); flex-shrink:0; }
        .nav-btn { flex:1; padding:12px 6px 8px; background:transparent; border:none; color:var(--text-muted); font-family:'DM Sans',sans-serif; font-size:11px; font-weight:600; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:3px; }
        .nav-btn .nav-icon { font-size:20px; }
        .nav-btn.active { color:var(--accent-primary); }
        .nav-btn:active { color:var(--accent-glow); }

        /* Settings */
        .settings-scroll { flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch; padding:24px 20px calc(var(--safe-bottom) + 80px); }
        .settings-section { margin-bottom:24px; }
        .settings-section-title { font-family:'DM Serif Display',serif; font-size:20px; margin-bottom:4px; }
        .settings-section-desc { font-size:13px; color:var(--text-muted); margin-bottom:14px; }
        .voice-group-label { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:1.2px; color:var(--text-muted); margin:16px 0 8px; }
        .voice-option { display:flex; align-items:center; gap:12px; background:var(--bg-card); border:2px solid var(--border-subtle); border-radius:var(--radius-md); padding:12px 14px; margin-bottom:7px; cursor:pointer; transition:all 0.15s; }
        .voice-option:active { transform:scale(0.98); }
        .voice-option.selected { border-color:var(--accent-primary); background:rgba(108,99,255,0.08); }
        .voice-radio { width:20px; height:20px; border-radius:50%; border:2px solid var(--text-muted); flex-shrink:0; display:flex; align-items:center; justify-content:center; }
        .voice-option.selected .voice-radio { border-color:var(--accent-primary); }
        .voice-radio-dot { width:10px; height:10px; border-radius:50%; background:var(--accent-primary); opacity:0; }
        .voice-option.selected .voice-radio-dot { opacity:1; }
        .voice-info { flex:1; min-width:0; }
        .voice-name { font-size:15px; font-weight:600; }
        .voice-detail { font-size:11px; color:var(--text-secondary); margin-top:1px; }
        .voice-preview-btn { background:var(--bg-elevated); border:1px solid var(--border-subtle); color:var(--text-secondary); width:38px; height:38px; border-radius:50%; font-size:16px; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
        .voice-preview-btn:active { background:var(--accent-primary); color:white; transform:scale(0.9); }
        .speed-control { display:flex; align-items:center; gap:12px; background:var(--bg-card); border:1px solid var(--border-subtle); border-radius:var(--radius-md); padding:14px; }
        .speed-label { font-size:13px; color:var(--text-secondary); font-weight:600; min-width:40px; }
        .speed-slider { flex:1; -webkit-appearance:none; height:6px; border-radius:3px; background:var(--bg-elevated); outline:none; }
        .speed-slider::-webkit-slider-thumb { -webkit-appearance:none; width:24px; height:24px; border-radius:50%; background:var(--accent-primary); cursor:pointer; }
        .speed-value { font-size:13px; color:var(--accent-glow); font-weight:700; min-width:36px; text-align:right; }
        .settings-bottom-nav { position:fixed; bottom:0; left:0; right:0; border-top:1px solid var(--border-subtle); background:var(--bg-card); padding-bottom:var(--safe-bottom); z-index:50; }
        .settings-home-btn { width:100%; padding:14px; background:transparent; border:none; color:var(--accent-glow); font-family:'DM Sans',sans-serif; font-size:15px; font-weight:700; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; }

        /* Stats bar */
        .stats-bar { display:flex; gap:12px; padding:10px 14px; background:var(--bg-card); border-bottom:1px solid var(--border-subtle); flex-shrink:0; overflow-x:auto; scrollbar-width:none; }
        .stats-bar::-webkit-scrollbar { display:none; }
        .stat-chip { background:var(--bg-elevated); border:1px solid var(--border-subtle); border-radius:20px; padding:5px 12px; font-size:11px; font-weight:600; color:var(--text-secondary); white-space:nowrap; flex-shrink:0; }
        .stat-chip .stat-val { color:var(--accent-gold); }

        /* Modal */
        .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px); z-index:500; align-items:flex-end; justify-content:center; }
        .modal-overlay.open { display:flex; }
        .modal-sheet { background:var(--bg-card); width:100%; max-width:600px; border-radius:var(--radius-xl) var(--radius-xl) 0 0; padding:24px 20px calc(var(--safe-bottom) + 20px); animation:slideUp 0.3s ease; }
        @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
        .modal-handle { width:40px; height:4px; background:var(--text-muted); border-radius:2px; margin:0 auto 20px; opacity:0.5; }
        .modal-title { font-family:'DM Serif Display',serif; font-size:22px; margin-bottom:6px; }
        .modal-desc { color:var(--text-secondary); font-size:14px; margin-bottom:16px; }
        .modal-input { width:100%; background:var(--bg-deep); border:2px solid var(--border-subtle); color:var(--text-primary); font-family:'DM Sans',sans-serif; font-size:18px; padding:14px; border-radius:var(--radius-md); outline:none; resize:none; min-height:70px; }
        .modal-input:focus { border-color:var(--accent-primary); }
        .modal-input::placeholder { color:var(--text-muted); }
        .modal-category-select { display:flex; gap:7px; flex-wrap:wrap; margin:14px 0 18px; }
        .modal-cat-opt { background:var(--bg-elevated); border:1px solid var(--border-subtle); color:var(--text-secondary); padding:7px 12px; border-radius:20px; font-family:'DM Sans',sans-serif; font-size:12px; font-weight:600; cursor:pointer; }
        .modal-cat-opt.selected { background:var(--accent-primary); color:white; border-color:var(--accent-primary); }
        .modal-actions { display:flex; gap:12px; }
        .modal-btn { flex:1; padding:14px; border-radius:var(--radius-md); font-family:'DM Sans',sans-serif; font-size:15px; font-weight:700; cursor:pointer; border:none; }
        .modal-btn.cancel { background:var(--bg-elevated); color:var(--text-secondary); border:1px solid var(--border-subtle); }
        .modal-btn.save { background:var(--accent-primary); color:white; }
        .modal-btn:active { transform:scale(0.97); }

        /* Toast */
        .toast { position:fixed; top:calc(var(--safe-top) + 60px); left:50%; transform:translateX(-50%) translateY(-20px); background:var(--bg-elevated); color:var(--text-primary); padding:10px 22px; border-radius:var(--radius-md); font-size:14px; font-weight:600; opacity:0; transition:all 0.3s; pointer-events:none; z-index:1000; border:1px solid var(--border-active); box-shadow:var(--shadow-card); }
        .toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
        .toast.success { border-color:rgba(78,205,196,0.4); }

        /* Install banner */
        .install-banner { display:none; background:var(--bg-elevated); border:1px solid var(--border-active); border-radius:var(--radius-md); padding:12px 14px; margin-bottom:16px; align-items:center; gap:10px; }
        .install-banner.visible { display:flex; }
        .install-banner-text { flex:1; font-size:12px; color:var(--text-secondary); line-height:1.4; }
        .install-banner-text strong { color:var(--text-primary); }
        .install-dismiss { background:none; border:none; color:var(--text-muted); font-size:18px; cursor:pointer; padding:4px; }

        .swipe-hint { text-align:center; color:var(--text-muted); font-size:12px; padding:3px; opacity:0.6; }

        /* ===== LISTENING BAR ===== */
        .listen-bar { display:flex; align-items:center; gap:10px; padding:10px 14px; background:var(--bg-card); border-bottom:1px solid var(--border-subtle); flex-shrink:0; }
        .listen-toggle { display:flex; align-items:center; gap:8px; background:var(--bg-elevated); border:1.5px solid var(--border-subtle); border-radius:25px; padding:10px 18px 10px 14px; cursor:pointer; transition:all 0.2s; font-family:'DM Sans',sans-serif; font-size:15px; font-weight:600; color:var(--text-secondary); flex-shrink:0; min-height:44px; }
        .listen-toggle:active { transform:scale(0.96); }
        .listen-toggle.active { background:rgba(255,107,107,0.12); border-color:rgba(255,107,107,0.3); color:var(--accent-warm); }
        .listen-pulse { width:10px; height:10px; border-radius:50%; background:var(--text-muted); flex-shrink:0; transition:all 0.3s; }
        .listen-toggle.active .listen-pulse { background:var(--accent-warm); animation:pulse 1.5s infinite; }
        @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.5;transform:scale(1.3)} }
        .listen-topic { flex:1; min-width:0; overflow:hidden; }
        .listen-topic-text { font-size:14px; color:var(--text-muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .listen-topic-text.has-topic { color:var(--accent-glow); }
        .listen-transcript-toggle { background:none; border:none; color:var(--text-muted); font-size:22px; cursor:pointer; padding:8px; flex-shrink:0; min-width:44px; min-height:44px; display:flex; align-items:center; justify-content:center; }

        /* Transcript panel */
        .transcript-panel { display:none; max-height:0; overflow:hidden; background:var(--bg-surface); border-bottom:1px solid var(--border-subtle); padding:0 14px; transition:max-height 0.3s ease, padding 0.3s ease; }
        .transcript-panel.open { display:block; max-height:120px; padding:10px 14px; overflow-y:auto; }
        .transcript-text { font-size:12px; color:var(--text-secondary); line-height:1.5; font-family:monospace; }
        .transcript-text .keyword { color:var(--accent-gold); font-weight:700; }

        /* Suggested cards strip */
        .suggested-strip { display:none; padding:10px 14px 12px; background:rgba(108,99,255,0.04); border-bottom:1px solid var(--border-subtle); flex-shrink:0; }
        .suggested-strip.visible { display:block; }
        .suggested-label { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:var(--accent-glow); margin-bottom:8px; }
        .suggested-cards { display:flex; gap:10px; overflow-x:auto; scrollbar-width:none; -webkit-overflow-scrolling:touch; padding-bottom:4px; }
        .suggested-cards::-webkit-scrollbar { display:none; }
        .suggested-card { background:var(--bg-card); border:2px solid var(--accent-primary); border-radius:var(--radius-lg); padding:16px 20px; font-family:'DM Sans',sans-serif; font-size:17px; font-weight:600; color:var(--text-primary); cursor:pointer; white-space:nowrap; flex-shrink:0; transition:all 0.12s; max-width:320px; overflow:hidden; text-overflow:ellipsis; min-height:56px; display:flex; align-items:center; gap:8px; }
        .suggested-card:active { transform:scale(0.95); background:var(--accent-primary); color:white; }
        .suggested-card .match-score { font-size:11px; color:var(--accent-gold); margin-left:4px; flex-shrink:0; }

        /* ===== YES/NO BAR ‚Äî persistent on all screens ===== */
        .yesno-bar { display:flex; gap:10px; padding:8px 14px; background:var(--bg-card); border-bottom:1px solid var(--border-subtle); flex-shrink:0; z-index:90; }
        .yesno-btn { flex:1; padding:14px 8px; border-radius:var(--radius-md); font-family:'DM Sans',sans-serif; font-size:18px; font-weight:800; cursor:pointer; border:2px solid transparent; text-align:center; transition:all 0.12s; letter-spacing:0.5px; }
        .yesno-btn:active { transform:scale(0.94); }
        .yesno-yes { background:rgba(78,205,196,0.12); color:#4ecdc4; border-color:rgba(78,205,196,0.3); }
        .yesno-yes:active { background:rgba(78,205,196,0.3); }
        .yesno-no { background:rgba(255,107,107,0.12); color:#ff6b6b; border-color:rgba(255,107,107,0.3); }
        .yesno-no:active { background:rgba(255,107,107,0.3); }
        .yesno-maybe { background:rgba(255,217,61,0.10); color:#ffd93d; border-color:rgba(255,217,61,0.25); }
        .yesno-maybe:active { background:rgba(255,217,61,0.25); }
        .yesno-wait { background:rgba(108,99,255,0.10); color:var(--accent-glow); border-color:rgba(108,99,255,0.25); }
        .yesno-wait:active { background:rgba(108,99,255,0.25); }

        /* ===== SOS DASHBOARD ===== */
        .sos-scroll { flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch; padding:12px 14px calc(var(--safe-bottom) + 70px); }
        .sos-group { margin-bottom:18px; }
        .sos-group-label { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:1.2px; margin-bottom:8px; padding-left:4px; }
        .sos-group-label.sound { color:#ff6b6b; }
        .sos-group-label.smell { color:#ff9f43; }
        .sos-group-label.light { color:#ffd93d; }
        .sos-group-label.touch { color:#ee5a24; }
        .sos-group-label.overwhelm { color:#ff4757; }
        .sos-group-label.needs { color:#4ecdc4; }
        .sos-group-label.explain { color:#a29bfe; }
        .sos-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
        .sos-btn { background:var(--bg-card); border:1.5px solid var(--border-subtle); border-radius:var(--radius-md); padding:14px 12px; font-family:'DM Sans',sans-serif; font-size:14px; font-weight:600; color:var(--text-primary); cursor:pointer; text-align:left; line-height:1.35; transition:all 0.12s; display:flex; align-items:center; gap:8px; }
        .sos-btn:active { transform:scale(0.96); background:var(--bg-elevated); }
        .sos-btn .sos-icon { font-size:20px; flex-shrink:0; }
        .sos-btn.speaking-active { border-color:var(--accent-success); background:rgba(78,205,196,0.08); }
        .sos-btn.full-width { grid-column:1/-1; }
        /* Color-coded borders per group */
        .sos-group.sound .sos-btn { border-color:rgba(255,107,107,0.2); }
        .sos-group.sound .sos-btn:active { border-color:rgba(255,107,107,0.5); background:rgba(255,107,107,0.06); }
        .sos-group.smell .sos-btn { border-color:rgba(255,159,67,0.2); }
        .sos-group.smell .sos-btn:active { border-color:rgba(255,159,67,0.5); background:rgba(255,159,67,0.06); }
        .sos-group.light .sos-btn { border-color:rgba(255,217,61,0.2); }
        .sos-group.overwhelm .sos-btn { border-color:rgba(255,71,87,0.25); }
        .sos-group.overwhelm .sos-btn:active { border-color:rgba(255,71,87,0.5); background:rgba(255,71,87,0.06); }
        .sos-group.needs .sos-btn { border-color:rgba(78,205,196,0.2); }
        .sos-group.needs .sos-btn:active { border-color:rgba(78,205,196,0.5); background:rgba(78,205,196,0.06); }
        .sos-group.explain .sos-btn { border-color:rgba(162,155,254,0.2); }

        @media(max-width:480px) {
            .phrase-text { font-size:22px; }
            .phrase-card { padding:28px 18px 24px; min-height:240px; }
            .speak-btn { font-size:15px; padding:14px 36px; }
            .context-tile { min-height:115px; padding:18px 12px; }
            .context-tile .tile-icon { font-size:30px; margin-bottom:8px; }
            .context-tile .tile-label { font-size:13px; }
        }
        @media(min-width:768px) {
            .phrase-text { font-size:32px; }
            .phrase-card { min-height:360px; padding:48px 36px 36px; }
        }
    </style>
</head>
<body>

<div class="header">
    <div class="header-left">
        <button class="back-btn" id="backBtn" onclick="app.goHome()">‚Äπ</button>
        <div class="header-title">Ryan's Voice</div>
    </div>
    <div class="context-badge" id="contextBadge">Home</div>
</div>

<!-- YES/NO BAR ‚Äî always visible -->
<div class="yesno-bar" id="yesnoBar">
    <button class="yesno-btn yesno-yes" onclick="app.quickSpeak('Yes')">‚úì Yes</button>
    <button class="yesno-btn yesno-no" onclick="app.quickSpeak('No')">‚úó No</button>
    <button class="yesno-btn yesno-maybe" onclick="app.quickSpeak('Maybe')">~ Maybe</button>
    <button class="yesno-btn yesno-wait" onclick="app.quickSpeak('Wait, I\\'m thinking')">‚è≥ Wait</button>
</div>

<!-- HOME -->
<div class="screen active" id="homeScreen">
    <div class="home-scroll">
        <div class="home-greeting">What are you doing?</div>
        <div class="home-subtitle">Pick an activity to load your phrases</div>
        <div id="installBanner" class="install-banner">
            <div class="install-banner-text"><strong>Add to Home Screen</strong> for full-screen app. Tap Share ‚Üí Add to Home Screen.</div>
            <button class="install-dismiss" onclick="dismissInstall()">‚úï</button>
        </div>
        <div id="contextGrid"></div>
    </div>
</div>

<!-- CARD SWIPE -->
<div class="screen" id="swipeScreen">
    <div class="stats-bar" id="statsBar"></div>
    <!-- Listening bar -->
    <div class="listen-bar" id="listenBar">
        <button class="listen-toggle" id="listenToggle" onclick="app.toggleListening()">
            <div class="listen-pulse"></div>
            <span id="listenLabel">Listen</span>
        </button>
        <div class="listen-topic">
            <div class="listen-topic-text" id="listenTopic">Tap Listen to hear the conversation</div>
        </div>
        <button class="listen-transcript-toggle" id="transcriptToggleBtn" onclick="app.toggleTranscript()">üìù</button>
    </div>
    <!-- Transcript -->
    <div class="transcript-panel" id="transcriptPanel">
        <div class="transcript-text" id="transcriptText">Transcript will appear here...</div>
    </div>
    <!-- Suggested cards from listening -->
    <div class="suggested-strip" id="suggestedStrip">
        <div class="suggested-label">üéØ Suggested for you</div>
        <div class="suggested-cards" id="suggestedCards"></div>
    </div>
    <div class="swipe-area">
        <div class="swipe-hint" id="swipeHint">‚Üê swipe or tap arrows ‚Üí</div>
        <div class="card-viewport" id="cardViewport">
            <div class="phrase-card" id="phraseCard">
                <div class="card-freq-badge" id="cardFreqBadge">‚≠ê Favourite</div>
                <div class="card-category-tag" id="cardCatTag"></div>
                <div class="phrase-text" id="phraseText">Loading...</div>
                <div class="phrase-sub" id="phraseSub"></div>
                <button class="speak-btn" id="speakBtn" onclick="app.speak()">TAP TO SPEAK</button>
            </div>
        </div>
        <div class="card-nav">
            <button class="card-arrow" id="prevArrow" onclick="app.prev()">‚Äπ</button>
            <div class="card-dots" id="cardDots"></div>
            <button class="card-arrow" id="nextArrow" onclick="app.next()">‚Ä∫</button>
        </div>
        <div class="card-counter" id="cardCounter"></div>
    </div>
    <div class="category-bar" id="categoryBar"></div>
    <div class="bottom-nav">
        <button class="nav-btn" onclick="app.goHome()"><span class="nav-icon">üè†</span>Home</button>
        <button class="nav-btn" onclick="app.openAddPhrase()"><span class="nav-icon">Ôºã</span>Add</button>
        <button class="nav-btn" onclick="showToast('Writing mode coming soon!')"><span class="nav-icon">‚úçÔ∏è</span>Write</button>
    </div>
</div>

<!-- SOS DASHBOARD -->
<div class="screen" id="sosScreen">
    <div class="sos-scroll" id="sosContent"></div>
    <div class="bottom-nav">
        <button class="nav-btn" onclick="app.goHome()"><span class="nav-icon">üè†</span>Home</button>
        <button class="nav-btn" onclick="app.loadContext('sensory')"><span class="nav-icon">üìã</span>Browse All</button>
    </div>
</div>

<!-- SETTINGS -->
<div class="screen" id="settingsScreen">
    <div class="settings-scroll">
        <div class="settings-section">
            <div class="settings-section-title">Choose Your Voice</div>
            <div class="settings-section-desc">Pick the voice that sounds right. Tap ‚ñ∂ to preview.</div>
            <div class="voice-group-label">üë® Male Voices</div>
            <div id="maleVoices"></div>
            <div class="voice-group-label">üë© Female Voices</div>
            <div id="femaleVoices"></div>
        </div>
        <div class="settings-section">
            <div class="settings-section-title">Speaking Speed</div>
            <div class="settings-section-desc">Adjust how fast phrases are spoken.</div>
            <div class="speed-control">
                <div class="speed-label">Slow</div>
                <input type="range" class="speed-slider" id="speedSlider" min="0.5" max="1.3" step="0.05" value="0.92" oninput="app.updateSpeed(this.value)">
                <div class="speed-value" id="speedValue">0.92√ó</div>
                <div class="speed-label">Fast</div>
            </div>
        </div>
        <div class="settings-section">
            <div class="settings-section-title">Usage Stats</div>
            <div class="settings-section-desc">How you've been using the app.</div>
            <div id="usageStatsContent" style="color:var(--text-secondary);font-size:14px;">Loading...</div>
        </div>
        <div class="settings-section">
            <div class="settings-section-title">üìä Prediction Insights</div>
            <div class="settings-section-desc">How the app is learning your patterns.</div>
            <div id="predictionInsights" style="color:var(--text-secondary);font-size:14px;">Loading...</div>
        </div>
        <div class="settings-section">
            <div class="settings-section-title">üìã OT / Therapist Report</div>
            <div class="settings-section-desc">Export a detailed usage report for Ryan's OT or speech therapist. Includes phrase patterns, time-of-day data, sequences, and session history.</div>
            <button class="modal-btn save" style="max-width:250px;margin-bottom:10px;" onclick="app.exportOTReport()">üìã Generate & Copy Report</button>
            <button class="modal-btn cancel" style="max-width:250px;" onclick="app.downloadOTReport()">üíæ Download as File</button>
        </div>
        <div class="settings-section">
            <div class="settings-section-title">Reset Data</div>
            <div class="settings-section-desc">Clear all usage history and custom phrases.</div>
            <button class="modal-btn cancel" style="max-width:200px;" onclick="if(confirm('Reset all data? This cannot be undone.')){localStorage.removeItem('ryans-aac-data');showToast('Data reset','success');app.renderHome();}">Reset All Data</button>
        </div>
    </div>
    <div class="settings-bottom-nav">
        <button class="settings-home-btn" onclick="app.goHome()">üè† Back to Home</button>
    </div>
</div>

<!-- ADD PHRASE MODAL -->
<div class="modal-overlay" id="addPhraseModal">
    <div class="modal-sheet">
        <div class="modal-handle"></div>
        <div class="modal-title">Add New Phrase</div>
        <div class="modal-desc">Type a phrase in your words.</div>
        <textarea class="modal-input" id="phraseInput" placeholder="Type your phrase here..." rows="2"></textarea>
        <div class="modal-category-select" id="modalCategorySelect"></div>
        <div class="modal-actions">
            <button class="modal-btn cancel" onclick="app.closeAddPhrase()">Cancel</button>
            <button class="modal-btn save" onclick="app.savePhrase()">Add Phrase</button>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ============================================================
// CARD DATA ‚Äî 200+ phrases across 8 contexts
// ============================================================
const CARD_DATA = {
story: {
    label: "üìö Story / Pictures", icon: "üìö",
    categories: ["emotions","motivations","social","advice"],
    cards: [
        {text:"The character is jealous of the other one.",cat:"emotions"},
        {text:"He looks really surprised.",cat:"emotions"},
        {text:"He's in awe of someone.",cat:"emotions"},
        {text:"She seems disappointed by the outcome.",cat:"emotions"},
        {text:"He feels left out of the group.",cat:"emotions"},
        {text:"She looks proud of her accomplishment.",cat:"emotions"},
        {text:"He's feeling angry and frustrated.",cat:"emotions"},
        {text:"She's overwhelmed by everything happening.",cat:"emotions"},
        {text:"He looks genuinely content.",cat:"emotions"},
        {text:"There's a sense of longing in that expression.",cat:"emotions"},
        {text:"The big frog wants to be the boss.",cat:"motivations"},
        {text:"The boy is looking for a playmate.",cat:"motivations"},
        {text:"He thinks he's the boss of the animals.",cat:"motivations"},
        {text:"She wants to be left alone.",cat:"motivations"},
        {text:"He's trying to protect his territory.",cat:"motivations"},
        {text:"She's only thinking of herself.",cat:"motivations"},
        {text:"He wants to prove himself to the others.",cat:"motivations"},
        {text:"She's searching for acceptance.",cat:"motivations"},
        {text:"They realised he's being mean and selfish.",cat:"social"},
        {text:"He's totally lacking self-control.",cat:"social"},
        {text:"He's only thinking of himself.",cat:"social"},
        {text:"They're having a conflict about sharing.",cat:"social"},
        {text:"He's being a bully to the others.",cat:"social"},
        {text:"The group dynamics are changing.",cat:"social"},
        {text:"She's the peacemaker in this situation.",cat:"social"},
        {text:"They're excluding someone on purpose.",cat:"social"},
        {text:"Stop biting your friend. Use your kind words.",cat:"advice"},
        {text:"They need to learn cooperation.",cat:"advice"},
        {text:"They should take turns.",cat:"advice"},
        {text:"Everyone deserves respect.",cat:"advice"},
        {text:"Try to understand their feelings.",cat:"advice"},
        {text:"You need to share with others.",cat:"advice"},
        {text:"Think about how that makes them feel.",cat:"advice"},
        {text:"Actions have consequences.",cat:"advice"},
    ]
},
conversation: {
    label: "üí¨ Conversation", icon: "üí¨",
    categories: ["greetings","responses","feelings","requests","opinions","social"],
    cards: [
        // Greetings
        {text:"G'day.",cat:"greetings"},
        {text:"Hey, how's it going?",cat:"greetings"},
        {text:"What have you been up to?",cat:"greetings"},
        {text:"Long time no see.",cat:"greetings"},
        {text:"Good to see you again.",cat:"greetings"},
        {text:"How's your day been?",cat:"greetings"},
        {text:"Not bad, thanks. You?",cat:"greetings"},
        {text:"Yeah, going alright.",cat:"greetings"},
        {text:"Can't complain.",cat:"greetings"},
        {text:"Catch you later.",cat:"greetings"},
        // Responses
        {text:"Yes, I'd like to join.",cat:"responses"},
        {text:"No thanks, maybe later.",cat:"responses"},
        {text:"Yeah, for sure.",cat:"responses"},
        {text:"No worries.",cat:"responses"},
        {text:"Sounds good.",cat:"responses"},
        {text:"That makes sense.",cat:"responses"},
        {text:"I reckon so.",cat:"responses"},
        {text:"Fair enough.",cat:"responses"},
        {text:"That's a good point.",cat:"responses"},
        {text:"I'm not sure about that.",cat:"responses"},
        {text:"I don't think so.",cat:"responses"},
        {text:"Maybe, I'll think about it.",cat:"responses"},
        {text:"That's not really my thing.",cat:"responses"},
        {text:"Absolutely.",cat:"responses"},
        {text:"I hadn't thought of it that way.",cat:"responses"},
        {text:"Yeah, nah.",cat:"responses"},
        // Feelings
        {text:"I'm feeling good today.",cat:"feelings"},
        {text:"I'm a bit frustrated right now.",cat:"feelings"},
        {text:"That made me happy.",cat:"feelings"},
        {text:"I need a break right now.",cat:"feelings"},
        {text:"I'm excited about that.",cat:"feelings"},
        {text:"I'm thinking about it.",cat:"feelings"},
        {text:"That's bothering me.",cat:"feelings"},
        {text:"I'm feeling overwhelmed.",cat:"feelings"},
        {text:"I'm a bit tired.",cat:"feelings"},
        {text:"That actually made my day.",cat:"feelings"},
        {text:"That really annoys me.",cat:"feelings"},
        {text:"I'm bored. Can we do something?",cat:"feelings"},
        {text:"I'm worried about it.",cat:"feelings"},
        {text:"I'm disappointed by that.",cat:"feelings"},
        // Requests
        {text:"Can you repeat that?",cat:"requests"},
        {text:"Can we talk about something else?",cat:"requests"},
        {text:"Give me a moment to think.",cat:"requests"},
        {text:"Can you ask me a yes or no question?",cat:"requests"},
        {text:"I want to say something important.",cat:"requests"},
        {text:"Please wait, I'm composing my response.",cat:"requests"},
        {text:"Can you show me what you mean?",cat:"requests"},
        {text:"Can you slow down a bit?",cat:"requests"},
        {text:"Can you explain that differently?",cat:"requests"},
        {text:"I need help with something.",cat:"requests"},
        // Opinions
        {text:"I think that's a great idea.",cat:"opinions"},
        {text:"I'm not convinced about that.",cat:"opinions"},
        {text:"There's more to it than that.",cat:"opinions"},
        {text:"That's a bit over the top.",cat:"opinions"},
        {text:"I reckon that could work.",cat:"opinions"},
        {text:"I disagree, but I understand your point.",cat:"opinions"},
        {text:"That's exactly what I was thinking.",cat:"opinions"},
        {text:"I'd rather not, if that's okay.",cat:"opinions"},
        {text:"It depends on the situation.",cat:"opinions"},
        {text:"Can we look at it from a different angle?",cat:"opinions"},
        // Social
        {text:"What are you up to this weekend?",cat:"social"},
        {text:"Have you seen any good shows lately?",cat:"social"},
        {text:"Did you catch the game?",cat:"social"},
        {text:"What do you think about that?",cat:"social"},
        {text:"Tell me more about that.",cat:"social"},
        {text:"That's hilarious.",cat:"social"},
        {text:"I've been thinking about something.",cat:"social"},
        {text:"Can I ask you something?",cat:"social"},
        {text:"That reminds me of something.",cat:"social"},
        {text:"We should do that again sometime.",cat:"social"},
        {text:"Thanks for letting me know.",cat:"social"},
        {text:"Good on ya.",cat:"social"},
        {text:"Cheers for that.",cat:"social"},
        {text:"That was really funny.",cat:"social"},
        {text:"I appreciate you saying that.",cat:"social"},
        {text:"How was your day?",cat:"social"},
    ]
},
math: {
    label: "üî¢ Math", icon: "üî¢",
    categories: ["observations","operations","geometry","discussion"],
    cards: [
        {text:"That theorem is fascinating.",cat:"observations"},
        {text:"I see a pattern here.",cat:"observations"},
        {text:"The proof shows that...",cat:"observations"},
        {text:"That's an elegant solution.",cat:"observations"},
        {text:"There's a relationship between these numbers.",cat:"observations"},
        {text:"This reminds me of another problem.",cat:"observations"},
        {text:"Let me calculate that.",cat:"operations"},
        {text:"The equation needs to balance.",cat:"operations"},
        {text:"We need to find the common factor.",cat:"operations"},
        {text:"The answer is a fraction.",cat:"operations"},
        {text:"This requires a different approach.",cat:"operations"},
        {text:"The variable represents an unknown quantity.",cat:"operations"},
        {text:"That's geometrically impossible.",cat:"geometry"},
        {text:"The angles need to add up to 180 degrees.",cat:"geometry"},
        {text:"Look at the symmetry.",cat:"geometry"},
        {text:"The shapes are congruent.",cat:"geometry"},
        {text:"It's a transformation ‚Äî a rotation.",cat:"geometry"},
        {text:"Can you explain that step?",cat:"discussion"},
        {text:"I think there's an error in the working.",cat:"discussion"},
        {text:"Let me try a different method.",cat:"discussion"},
        {text:"That logic is sound.",cat:"discussion"},
        {text:"Can we go through it again?",cat:"discussion"},
        {text:"I need to think about this more.",cat:"discussion"},
    ]
},
gaming: {
    label: "üéÆ Gaming / Videos", icon: "üéÆ",
    categories: ["reactions","requests","commentary","social"],
    cards: [
        {text:"That was an amazing play!",cat:"reactions"},
        {text:"This game is really challenging.",cat:"reactions"},
        {text:"I like how that works.",cat:"reactions"},
        {text:"That was unexpected.",cat:"reactions"},
        {text:"The graphics are incredible.",cat:"reactions"},
        {text:"That was so satisfying.",cat:"reactions"},
        {text:"I can't believe that just happened.",cat:"reactions"},
        {text:"I want to try that level.",cat:"requests"},
        {text:"Can we watch something different?",cat:"requests"},
        {text:"Let me have a turn.",cat:"requests"},
        {text:"Can we restart?",cat:"requests"},
        {text:"Skip this part.",cat:"requests"},
        {text:"Turn up the volume.",cat:"requests"},
        {text:"The strategy should be different.",cat:"commentary"},
        {text:"They're making a mistake.",cat:"commentary"},
        {text:"This character is overpowered.",cat:"commentary"},
        {text:"The storyline is getting interesting.",cat:"commentary"},
        {text:"That mechanic is broken.",cat:"commentary"},
        {text:"The difficulty curve is too steep.",cat:"commentary"},
        {text:"Do you want to play together?",cat:"social"},
        {text:"Your turn next.",cat:"social"},
        {text:"Great teamwork.",cat:"social"},
        {text:"Let's try a different game.",cat:"social"},
        {text:"I'm done playing for now.",cat:"social"},
    ]
},
school: {
    label: "üè´ At School", icon: "üè´",
    categories: ["learning","requests","social","feelings"],
    cards: [
        {text:"I understand the concept.",cat:"learning"},
        {text:"Can you explain that again?",cat:"learning"},
        {text:"I have a question about this.",cat:"learning"},
        {text:"I think the answer is...",cat:"learning"},
        {text:"That doesn't seem right to me.",cat:"learning"},
        {text:"This is interesting.",cat:"learning"},
        {text:"I see the connection now.",cat:"learning"},
        {text:"That's a tricky question.",cat:"learning"},
        {text:"I need more time to finish.",cat:"requests"},
        {text:"Can I work on this at my own pace?",cat:"requests"},
        {text:"I've finished this part.",cat:"requests"},
        {text:"I'm stuck on this bit.",cat:"requests"},
        {text:"Can I use my app to answer?",cat:"requests"},
        {text:"I need a quieter space.",cat:"requests"},
        {text:"Can I take a break?",cat:"requests"},
        {text:"Do you want to work on this together?",cat:"social"},
        {text:"That was a good presentation.",cat:"social"},
        {text:"I liked your idea.",cat:"social"},
        {text:"Can I sit with you?",cat:"social"},
        {text:"What class do you have next?",cat:"social"},
        {text:"I had a good day at school.",cat:"feelings"},
        {text:"Today was really hard.",cat:"feelings"},
        {text:"I'm proud of what I did today.",cat:"feelings"},
        {text:"I felt left out today.",cat:"feelings"},
        {text:"I'm stressed about the assignment.",cat:"feelings"},
    ]
},
home: {
    label: "üè† At Home", icon: "üè°",
    categories: ["needs","family","feelings","requests"],
    cards: [
        {text:"What's for dinner?",cat:"needs"},
        {text:"I'm hungry.",cat:"needs"},
        {text:"I'm not hungry right now.",cat:"needs"},
        {text:"I'd like some water, please.",cat:"needs"},
        {text:"I'm tired. I want to rest.",cat:"needs"},
        {text:"Can I have a snack?",cat:"needs"},
        {text:"Thanks, Mum.",cat:"family"},
        {text:"Thanks, Dad.",cat:"family"},
        {text:"I love you.",cat:"family"},
        {text:"Can we watch something together?",cat:"family"},
        {text:"Can I stay up a bit longer?",cat:"family"},
        {text:"Something happened at school.",cat:"family"},
        {text:"I had a good day today.",cat:"family"},
        {text:"That's not fair.",cat:"feelings"},
        {text:"I don't want to do that right now.",cat:"feelings"},
        {text:"I need some time alone.",cat:"feelings"},
        {text:"I'm feeling happy.",cat:"feelings"},
        {text:"I'm upset about something.",cat:"feelings"},
        {text:"Can I choose what we do?",cat:"requests"},
        {text:"Can we go outside?",cat:"requests"},
        {text:"I want to play a game.",cat:"requests"},
        {text:"Can we go to the shops?",cat:"requests"},
        {text:"I don't feel well.",cat:"requests"},
    ]
},
sensory: {
    label: "‚ö° Quick SOS", icon: "‚ö°",
    categories: ["sensory","overwhelm","needs","explain"],
    cards: [
        // Sensory triggers ‚Äî smells
        {text:"That smell is really bothering me.",cat:"sensory"},
        {text:"Something smells bad. I need to move.",cat:"sensory"},
        {text:"The smell is making me feel sick.",cat:"sensory"},
        {text:"Can we go somewhere with fresh air?",cat:"sensory"},
        {text:"That perfume/spray is too strong.",cat:"sensory"},
        {text:"The food smell is overwhelming.",cat:"sensory"},
        // Sensory triggers ‚Äî sound
        {text:"It's too loud in here.",cat:"sensory"},
        {text:"That noise is hurting my ears.",cat:"sensory"},
        {text:"Can we go somewhere quieter?",cat:"sensory"},
        {text:"I need my headphones.",cat:"sensory"},
        {text:"Please stop making that sound.",cat:"sensory"},
        {text:"The background noise is too much.",cat:"sensory"},
        {text:"Can you turn the volume down?",cat:"sensory"},
        {text:"That sudden noise startled me.",cat:"sensory"},
        // Sensory triggers ‚Äî light/visual
        {text:"The light is too bright.",cat:"sensory"},
        {text:"The flickering light is bothering me.",cat:"sensory"},
        {text:"There's too much going on visually.",cat:"sensory"},
        {text:"I need to close my eyes for a moment.",cat:"sensory"},
        // Sensory triggers ‚Äî touch/texture
        {text:"This texture is really uncomfortable.",cat:"sensory"},
        {text:"Don't touch me right now, please.",cat:"sensory"},
        {text:"These clothes are bothering me.",cat:"sensory"},
        {text:"The seat feels wrong.",cat:"sensory"},
        // Overwhelm / meltdown
        {text:"I'm starting to feel overwhelmed.",cat:"overwhelm"},
        {text:"I need to leave right now.",cat:"overwhelm"},
        {text:"I'm about to have a meltdown.",cat:"overwhelm"},
        {text:"Everything is too much right now.",cat:"overwhelm"},
        {text:"I can't cope with this.",cat:"overwhelm"},
        {text:"I need space. Please step back.",cat:"overwhelm"},
        {text:"I'm shutting down. Give me time.",cat:"overwhelm"},
        {text:"I feel like I'm going to explode.",cat:"overwhelm"},
        {text:"I can't think clearly right now.",cat:"overwhelm"},
        {text:"Too many people. I need to get out.",cat:"overwhelm"},
        {text:"Please stop talking to me for a moment.",cat:"overwhelm"},
        {text:"I'm trying to calm down. Please wait.",cat:"overwhelm"},
        // Immediate needs
        {text:"I need a quiet space now.",cat:"needs"},
        {text:"I need a break. 5 minutes.",cat:"needs"},
        {text:"I need water.",cat:"needs"},
        {text:"I need to go to the bathroom.",cat:"needs"},
        {text:"I need to sit down.",cat:"needs"},
        {text:"I need to go home.",cat:"needs"},
        {text:"I need my comfort item.",cat:"needs"},
        {text:"I'm not feeling safe here.",cat:"needs"},
        {text:"I need someone I trust.",cat:"needs"},
        {text:"Can I go to a different room?",cat:"needs"},
        {text:"I need to do my calming routine.",cat:"needs"},
        {text:"I need to move around.",cat:"needs"},
        // Explain to others
        {text:"I'm autistic. I process things differently.",cat:"explain"},
        {text:"I'm not being rude, I'm overwhelmed.",cat:"explain"},
        {text:"Loud noises physically hurt me.",cat:"explain"},
        {text:"I need more time to respond.",cat:"explain"},
        {text:"I communicate using this app.",cat:"explain"},
        {text:"Strong smells make me feel sick.",cat:"explain"},
        {text:"I'm having a hard time, but I'll be okay.",cat:"explain"},
        {text:"Please be patient with me.",cat:"explain"},
        {text:"I can hear you, I just can't respond yet.",cat:"explain"},
        {text:"I'm not ignoring you. I'm processing.",cat:"explain"},
    ]
},
malayalam: {
    label: "üáÆüá≥ Malayalam", icon: "üáÆüá≥",
    categories: ["greetings","responses","feelings","family"],
    cards: [
        {text:"‡¥®‡¥Æ‡¥∏‡µç‡¥ï‡¥æ‡¥∞‡¥Ç",cat:"greetings",sub:"NamaskƒÅram ‚Äî Hello"},
        {text:"‡¥π‡¥≤‡µã",cat:"greetings",sub:"Hal≈ç ‚Äî Hello (casual)"},
        {text:"‡¥∏‡µÅ‡¥™‡µç‡¥∞‡¥≠‡¥æ‡¥§‡¥Ç",cat:"greetings",sub:"SuprabhƒÅtham ‚Äî Good morning"},
        {text:"‡¥∂‡µÅ‡¥≠ ‡¥∏‡¥®‡µç‡¥ß‡µç‡¥Ø",cat:"greetings",sub:"Shubha sandhya ‚Äî Good evening"},
        {text:"‡¥∂‡µÅ‡¥≠ ‡¥∞‡¥æ‡¥§‡µç‡¥∞‡¥ø",cat:"greetings",sub:"Shubha rƒÅthri ‚Äî Good night"},
        {text:"‡¥é‡¥®‡µç‡¥§‡µä‡¥ï‡µç‡¥ï‡µÜ‡¥Ø‡µÅ‡¥£‡µç‡¥ü‡µç?",cat:"greetings",sub:"Enthokke undu? ‚Äî How are you?"},
        {text:"‡¥∏‡µÅ‡¥ñ‡¥Æ‡¥æ‡¥£‡µã?",cat:"greetings",sub:"SukhamƒÅno? ‚Äî Are you well?"},
        {text:"‡¥é‡¥®‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥∏‡µÅ‡¥ñ‡¥Æ‡¥æ‡¥£‡µç",cat:"greetings",sub:"Enikku sukhamƒÅnu ‚Äî I am well"},
        {text:"‡¥ï‡¥£‡µç‡¥ü‡¥§‡¥ø‡µΩ ‡¥∏‡¥®‡µç‡¥§‡µã‡¥∑‡¥Ç",cat:"greetings",sub:"Kandathil santh≈çsham ‚Äî Nice to see you"},
        {text:"‡¥™‡¥ø‡¥®‡µç‡¥®‡µÜ ‡¥ï‡¥æ‡¥£‡¥æ‡¥Ç",cat:"greetings",sub:"Pinne kƒÅnƒÅm ‚Äî See you later"},
        {text:"‡¥Ö‡¥§‡µÜ",cat:"responses",sub:"Athe ‚Äî Yes"},
        {text:"‡¥Ö‡¥≤‡µç‡¥≤",cat:"responses",sub:"Alla ‚Äî No"},
        {text:"‡¥∂‡¥∞‡¥ø",cat:"responses",sub:"Shari ‚Äî Okay"},
        {text:"‡¥®‡¥®‡µç‡¥¶‡¥ø",cat:"responses",sub:"Nandi ‚Äî Thank you"},
        {text:"‡¥ï‡µç‡¥∑‡¥Æ‡¥ø‡¥ï‡µç‡¥ï‡¥£‡¥Ç",cat:"responses",sub:"Kshamikkanam ‚Äî Sorry"},
        {text:"‡¥∏‡¥æ‡¥∞‡¥Æ‡¥ø‡¥≤‡µç‡¥≤",cat:"responses",sub:"SƒÅramilla ‚Äî No problem"},
        {text:"‡¥∂‡¥∞‡¥ø‡¥Ø‡¥æ‡¥£‡µç",cat:"responses",sub:"ShariyƒÅnu ‚Äî That's right"},
        {text:"‡¥é‡¥®‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥Ö‡¥±‡¥ø‡¥Ø‡¥ø‡¥≤‡µç‡¥≤",cat:"responses",sub:"Enikku ariyilla ‚Äî I don't know"},
        {text:"‡¥í‡¥∞‡µÅ ‡¥®‡¥ø‡¥Æ‡¥ø‡¥∑‡¥Ç",cat:"responses",sub:"Oru nimisham ‚Äî One moment"},
        {text:"‡¥é‡¥®‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥∏‡¥®‡µç‡¥§‡µã‡¥∑‡¥Æ‡µÅ‡¥£‡µç‡¥ü‡µç",cat:"feelings",sub:"Enikku santh≈çsham undu ‚Äî I am happy"},
        {text:"‡¥é‡¥®‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥µ‡¥ø‡¥∑‡¥Æ‡¥Æ‡µÅ‡¥£‡µç‡¥ü‡µç",cat:"feelings",sub:"Enikku vishamam undu ‚Äî I am sad"},
        {text:"‡¥é‡¥®‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥¶‡µá‡¥∑‡µç‡¥Ø‡¥Ç ‡¥µ‡¥∞‡µÅ‡¥®‡µç‡¥®‡µÅ",cat:"feelings",sub:"Enikku dƒìshyam varunnu ‚Äî I am angry"},
        {text:"‡¥é‡¥®‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥ï‡µç‡¥∑‡µÄ‡¥£‡¥Æ‡µÅ‡¥£‡µç‡¥ü‡µç",cat:"feelings",sub:"Enikku ksheenam undu ‚Äî I am tired"},
        {text:"‡¥é‡¥®‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥µ‡¥ø‡¥∂‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ",cat:"feelings",sub:"Enikku vishakkunnu ‚Äî I am hungry"},
        {text:"‡¥é‡¥®‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥¶‡¥æ‡¥π‡¥ø‡¥ï‡µç‡¥ï‡µÅ‡¥®‡µç‡¥®‡µÅ",cat:"feelings",sub:"Enikku dƒÅhikkunnu ‚Äî I am thirsty"},
        {text:"‡¥é‡¥®‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥µ‡µá‡¥£‡µç‡¥ü",cat:"feelings",sub:"Enikku vƒìnda ‚Äî I don't want it"},
        {text:"‡¥é‡¥®‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥á‡¥∑‡µç‡¥ü‡¥Æ‡¥æ‡¥£‡µç",cat:"feelings",sub:"Enikku ishtamƒÅnu ‚Äî I like it"},
        {text:"‡¥Ö‡¥Æ‡µç‡¥Æ",cat:"family",sub:"Amma ‚Äî Mother"},
        {text:"‡¥Ö‡¥ö‡µç‡¥õ‡µª",cat:"family",sub:"Achan ‚Äî Father"},
        {text:"‡¥ö‡µá‡¥ü‡µç‡¥ü‡µª",cat:"family",sub:"Chƒìttan ‚Äî Elder brother"},
        {text:"‡¥ö‡µá‡¥ö‡µç‡¥ö‡¥ø",cat:"family",sub:"Chƒìchi ‚Äî Elder sister"},
        {text:"‡¥¶‡¥Ø‡¥µ‡¥æ‡¥Ø‡¥ø",cat:"family",sub:"DayavƒÅyi ‚Äî Please"},
        {text:"‡¥é‡¥®‡µç‡¥®‡µÜ ‡¥∏‡¥π‡¥æ‡¥Ø‡¥ø‡¥ï‡µç‡¥ï‡µÇ",cat:"family",sub:"Enne sahƒÅyikkoo ‚Äî Help me"},
        {text:"‡¥é‡¥®‡¥ø‡¥ï‡µç‡¥ï‡µç ‡¥µ‡µÜ‡¥≥‡µç‡¥≥‡¥Ç ‡¥µ‡µá‡¥£‡¥Ç",cat:"family",sub:"Enikku vellam vƒìnam ‚Äî I need water"},
    ]
}
};

const CONTEXTS = [
    {id:"sensory",     icon:"‚ö°", label:"Quick SOS",         group:"urgent"},
    {id:"conversation",icon:"üí¨", label:"Conversation",      group:"activities"},
    {id:"story",       icon:"üìö", label:"Story / Pictures",  group:"activities"},
    {id:"math",        icon:"üî¢", label:"Math",              group:"activities"},
    {id:"gaming",      icon:"üéÆ", label:"Gaming / Videos",   group:"activities"},
    {id:"school",      icon:"üè´", label:"At School",         group:"life"},
    {id:"home",        icon:"üè°", label:"At Home",           group:"life"},
    {id:"malayalam",   icon:"üáÆüá≥", label:"Malayalam",         group:"languages"},
    {id:"writing",     icon:"‚úçÔ∏è", label:"I want to write",   group:"tools", comingSoon:true},
    {id:"settings",    icon:"‚öôÔ∏è", label:"Settings",          group:"tools"},
];

// ============================================================
// PERSISTENCE & ADAPTIVE PREDICTION ENGINE (Phase 2D)
// ============================================================
const STORAGE_KEY = "ryans-aac-data";

function loadData() {
    try {
        const r = localStorage.getItem(STORAGE_KEY);
        const d = r ? JSON.parse(r) : {};
        if (!d.customCards) d.customCards = {};
        if (!d.preferences) d.preferences = {};
        if (!d.usage) d.usage = {};  // { "context:cardtext": { count, lastUsed, timestamps[] } }
        if (!d.totalSpoken) d.totalSpoken = 0;
        if (!d.sessionStart) d.sessionStart = Date.now();
        // Phase 2D additions
        if (!d.sequences) d.sequences = {};    // { "context:phraseA" : { "phraseB": count, "phraseC": count } }
        if (!d.hourBuckets) d.hourBuckets = {};// { "context:hour(0-23)": { "phraseText": count } }
        if (!d.catPrefs) d.catPrefs = {};      // { "context": { "emotions": count, "social": count } }
        if (!d.sessions) d.sessions = [];       // [{ start, end, context, cardCount, phrases[] }]
        if (!d.dailyPatterns) d.dailyPatterns = {}; // { "dayOfWeek(0-6)": { "context": count } }
        return d;
    } catch { return {customCards:{},preferences:{},usage:{},totalSpoken:0,sessionStart:Date.now(),sequences:{},hourBuckets:{},catPrefs:{},sessions:[],dailyPatterns:{}}; }
}

function saveData(d) {
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); } catch {}
}

// Last spoken phrase ‚Äî for sequence tracking
let lastSpokenKey = null;
let lastSpokenTime = 0;

function trackUsage(contextId, cardText, category) {
    const d = loadData();
    const key = contextId + ':' + cardText;
    const now = Date.now();
    const hour = new Date().getHours();
    const day = new Date().getDay();

    // 1. Basic usage (existing)
    if (!d.usage[key]) d.usage[key] = {count:0, lastUsed:0, timestamps:[]};
    d.usage[key].count++;
    d.usage[key].lastUsed = now;
    d.usage[key].timestamps.push(now);
    if (d.usage[key].timestamps.length > 50) d.usage[key].timestamps = d.usage[key].timestamps.slice(-50);
    d.totalSpoken = (d.totalSpoken || 0) + 1;

    // 2. Sequence tracking ‚Äî what does Ryan say AFTER this phrase?
    if (lastSpokenKey && (now - lastSpokenTime) < 120000) { // Within 2 minutes = same conversation flow
        if (!d.sequences[lastSpokenKey]) d.sequences[lastSpokenKey] = {};
        d.sequences[lastSpokenKey][cardText] = (d.sequences[lastSpokenKey][cardText] || 0) + 1;
    }
    lastSpokenKey = key;
    lastSpokenTime = now;

    // 3. Time-of-day patterns ‚Äî which phrases at which hour?
    const hourKey = contextId + ':' + hour;
    if (!d.hourBuckets[hourKey]) d.hourBuckets[hourKey] = {};
    d.hourBuckets[hourKey][cardText] = (d.hourBuckets[hourKey][cardText] || 0) + 1;

    // 4. Category preference per context
    if (category) {
        if (!d.catPrefs[contextId]) d.catPrefs[contextId] = {};
        d.catPrefs[contextId][category] = (d.catPrefs[contextId][category] || 0) + 1;
    }

    // 5. Day-of-week patterns
    const dayKey = day.toString();
    if (!d.dailyPatterns[dayKey]) d.dailyPatterns[dayKey] = {};
    d.dailyPatterns[dayKey][contextId] = (d.dailyPatterns[dayKey][contextId] || 0) + 1;

    // 6. Session tracking
    const lastSession = d.sessions[d.sessions.length - 1];
    if (lastSession && (now - lastSession.lastActivity) < 300000 && lastSession.context === contextId) {
        // Same session (within 5 min gap, same context)
        lastSession.lastActivity = now;
        lastSession.cardCount++;
        if (lastSession.phrases.length < 100) lastSession.phrases.push(cardText);
    } else {
        // New session
        d.sessions.push({start:now, lastActivity:now, context:contextId, cardCount:1, phrases:[cardText]});
        if (d.sessions.length > 200) d.sessions = d.sessions.slice(-200);
    }

    saveData(d);
}

// ---- ADAPTIVE SCORING ENGINE ----

function getCardScore(contextId, cardText) {
    const d = loadData();
    const key = contextId + ':' + cardText;
    const u = d.usage[key];
    if (!u) return 0;
    const hoursSinceUse = (Date.now() - u.lastUsed) / 3600000;
    const recency = Math.max(0, 1 - hoursSinceUse / 168);
    return u.count * (0.5 + 0.5 * recency);
}

function getAdaptiveScore(contextId, cardText, category) {
    const d = loadData();
    const now = Date.now();
    const hour = new Date().getHours();
    let score = 0;

    // 1. Base frequency + recency (existing logic)
    score += getCardScore(contextId, cardText);

    // 2. Sequence bonus ‚Äî if Ryan just said X, and he often follows X with this card
    if (lastSpokenKey && d.sequences[lastSpokenKey]) {
        const seqCount = d.sequences[lastSpokenKey][cardText] || 0;
        if (seqCount > 0) {
            score += seqCount * 3; // Strong signal ‚Äî he's done this pattern before
        }
    }

    // 3. Time-of-day bonus ‚Äî does Ryan use this phrase at this hour?
    const hourKey = contextId + ':' + hour;
    if (d.hourBuckets[hourKey] && d.hourBuckets[hourKey][cardText]) {
        score += d.hourBuckets[hourKey][cardText] * 1.5;
    }
    // Also check adjacent hours (+/- 1)
    const prevHour = contextId + ':' + ((hour + 23) % 24);
    const nextHour = contextId + ':' + ((hour + 1) % 24);
    if (d.hourBuckets[prevHour]?.[cardText]) score += d.hourBuckets[prevHour][cardText] * 0.5;
    if (d.hourBuckets[nextHour]?.[cardText]) score += d.hourBuckets[nextHour][cardText] * 0.5;

    // 4. Category preference bonus ‚Äî if Ryan prefers this category in this context
    if (category && d.catPrefs[contextId]) {
        const totalCatUse = Object.values(d.catPrefs[contextId]).reduce((s,v) => s+v, 0);
        if (totalCatUse > 5) { // Only after enough data
            const catShare = (d.catPrefs[contextId][category] || 0) / totalCatUse;
            if (catShare > 0.4) score += 2; // Strong preference for this category
            if (catShare > 0.6) score += 3; // Very strong
        }
    }

    // 5. Session fatigue detection ‚Äî surface "I need a break" after long sessions
    const sessions = d.sessions;
    if (sessions.length > 0) {
        const current = sessions[sessions.length - 1];
        const sessionMinutes = (now - current.start) / 60000;
        if (sessionMinutes > 15) {
            // Boost break/rest cards
            const breakPhrases = ['I need a break','I need a break. 5 minutes.','I\'m feeling overwhelmed.','I need a break right now.','I\'m a bit tired.'];
            if (breakPhrases.some(bp => cardText.toLowerCase().includes(bp.toLowerCase()))) {
                score += 4 + (sessionMinutes - 15) * 0.3; // Gets stronger over time
            }
        }
    }

    return score;
}

// Get sequence predictions ‚Äî "after Ryan said X, he usually says..."
function getSequencePredictions(contextId, limit) {
    const d = loadData();
    if (!lastSpokenKey || !d.sequences[lastSpokenKey]) return [];
    const seqs = d.sequences[lastSpokenKey];
    return Object.entries(seqs)
        .sort((a,b) => b[1] - a[1])
        .slice(0, limit || 3)
        .map(([text, count]) => ({text, count, type:'sequence'}));
}

// Get time-of-day predictions
function getTimeOfDayPredictions(contextId, limit) {
    const d = loadData();
    const hour = new Date().getHours();
    const hourKey = contextId + ':' + hour;
    if (!d.hourBuckets[hourKey]) return [];
    return Object.entries(d.hourBuckets[hourKey])
        .sort((a,b) => b[1] - a[1])
        .slice(0, limit || 3)
        .map(([text, count]) => ({text, count, type:'timeOfDay'}));
}

// Get preferred category for this context
function getPreferredCategory(contextId) {
    const d = loadData();
    if (!d.catPrefs[contextId]) return null;
    const entries = Object.entries(d.catPrefs[contextId]);
    if (entries.length === 0) return null;
    const total = entries.reduce((s,[,v]) => s+v, 0);
    if (total < 10) return null; // Need enough data
    const top = entries.sort((a,b) => b[1] - a[1])[0];
    const share = top[1] / total;
    if (share > 0.4) return {category:top[0], share:Math.round(share*100)};
    return null;
}

// Get session info
function getSessionInfo() {
    const d = loadData();
    const sessions = d.sessions;
    if (sessions.length === 0) return null;
    const current = sessions[sessions.length - 1];
    const now = Date.now();
    if ((now - current.lastActivity) > 300000) return null; // Session ended >5 min ago
    return {
        minutes: Math.round((now - current.start) / 60000),
        cardCount: current.cardCount,
        context: current.context,
        isLong: (now - current.start) > 900000, // >15 min
    };
}

// Generate prediction summary for the UI
function getPredictionSummary(contextId) {
    const predictions = [];
    
    // Sequence predictions
    const seqs = getSequencePredictions(contextId, 2);
    seqs.forEach(s => predictions.push({text:s.text, score:s.count*3, reason:'üîó You often say this next'}));

    // Time-of-day predictions
    const timePs = getTimeOfDayPredictions(contextId, 2);
    timePs.forEach(t => predictions.push({text:t.text, score:t.count*1.5, reason:'üïê Common at this time'}));

    // Category preference
    const catPref = getPreferredCategory(contextId);

    // Session awareness
    const session = getSessionInfo();

    return {predictions, catPref, session};
}

// ---- OT DATA EXPORT ----
function generateOTReport() {
    const d = loadData();
    const now = new Date();
    let report = `RYAN'S AAC USAGE REPORT\nGenerated: ${now.toLocaleDateString('en-AU')} ${now.toLocaleTimeString('en-AU')}\n`;
    report += `${'='.repeat(50)}\n\n`;

    // Overall stats
    report += `OVERALL STATISTICS\n`;
    report += `Total phrases spoken: ${d.totalSpoken}\n`;
    report += `Unique phrases used: ${Object.keys(d.usage).length}\n`;
    report += `Sessions recorded: ${d.sessions.length}\n\n`;

    // Top phrases
    report += `TOP 20 MOST USED PHRASES\n`;
    const topPhrases = Object.entries(d.usage).sort((a,b) => b[1].count - a[1].count).slice(0,20);
    topPhrases.forEach(([key, u], i) => {
        const [ctx, ...textParts] = key.split(':');
        const text = textParts.join(':');
        report += `${i+1}. [${ctx}] "${text}" ‚Äî ${u.count}√ó (last: ${new Date(u.lastUsed).toLocaleDateString('en-AU')})\n`;
    });
    report += '\n';

    // Time-of-day patterns
    report += `TIME-OF-DAY PATTERNS\n`;
    const hourTotals = {};
    Object.entries(d.hourBuckets).forEach(([key, phrases]) => {
        const hour = parseInt(key.split(':').pop());
        hourTotals[hour] = (hourTotals[hour] || 0) + Object.values(phrases).reduce((s,v) => s+v, 0);
    });
    for (let h = 6; h <= 22; h++) {
        const count = hourTotals[h] || 0;
        const bar = '‚ñà'.repeat(Math.min(count, 30));
        const label = h < 12 ? `${h}am` : h === 12 ? '12pm' : `${h-12}pm`;
        if (count > 0) report += `  ${label.padStart(4)}: ${bar} (${count})\n`;
    }
    report += '\n';

    // Category preferences
    report += `CATEGORY PREFERENCES BY CONTEXT\n`;
    Object.entries(d.catPrefs).forEach(([ctx, cats]) => {
        const total = Object.values(cats).reduce((s,v) => s+v, 0);
        report += `  ${ctx}:\n`;
        Object.entries(cats).sort((a,b) => b[1] - a[1]).forEach(([cat, count]) => {
            const pct = Math.round(count/total*100);
            report += `    ${cat}: ${pct}% (${count}√ó)\n`;
        });
    });
    report += '\n';

    // Sequence patterns
    report += `COMMON PHRASE SEQUENCES (says A ‚Üí then B)\n`;
    const seqEntries = Object.entries(d.sequences)
        .map(([key, followers]) => {
            const topFollower = Object.entries(followers).sort((a,b) => b[1] - a[1])[0];
            if (!topFollower || topFollower[1] < 2) return null;
            const [,phraseA] = key.split(':').length > 1 ? [key.split(':')[0], key.split(':').slice(1).join(':')] : ['?', key];
            return {a:phraseA, b:topFollower[0], count:topFollower[1]};
        })
        .filter(Boolean)
        .sort((a,b) => b.count - a.count)
        .slice(0, 15);
    seqEntries.forEach(s => {
        report += `  "${s.a.substring(0,40)}" ‚Üí "${s.b.substring(0,40)}" (${s.count}√ó)\n`;
    });
    report += '\n';

    // Session analysis
    report += `SESSION ANALYSIS (last 20 sessions)\n`;
    const recentSessions = d.sessions.slice(-20);
    recentSessions.forEach((s, i) => {
        const duration = Math.round((s.lastActivity - s.start) / 60000);
        const date = new Date(s.start);
        report += `  ${date.toLocaleDateString('en-AU')} ${date.toLocaleTimeString('en-AU',{hour:'2-digit',minute:'2-digit'})}: ${duration} min, ${s.cardCount} phrases [${s.context}]\n`;
    });
    report += '\n';

    // Average session
    if (recentSessions.length > 0) {
        const avgDuration = recentSessions.reduce((s,ss) => s + (ss.lastActivity - ss.start), 0) / recentSessions.length / 60000;
        const avgCards = recentSessions.reduce((s,ss) => s + ss.cardCount, 0) / recentSessions.length;
        report += `  Average session: ${Math.round(avgDuration)} min, ${Math.round(avgCards)} phrases\n\n`;
    }

    // Day-of-week patterns
    report += `DAY-OF-WEEK USAGE\n`;
    const dayNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
    for (let d2 = 0; d2 < 7; d2++) {
        const dayData = d.dailyPatterns[d2.toString()];
        if (dayData) {
            const total = Object.values(dayData).reduce((s,v) => s+v, 0);
            const contexts = Object.entries(dayData).sort((a,b) => b[1] - a[1]).map(([c,n]) => `${c}:${n}`).join(', ');
            report += `  ${dayNames[d2]}: ${total} total (${contexts})\n`;
        }
    }

    return report;
}

function getCardsForContext(contextId) {
    const base = CARD_DATA[contextId];
    if (!base) return [];
    const d = loadData();
    const custom = d.customCards[contextId] || [];
    let all = [...base.cards, ...custom];

    // Smart reorder: use adaptive score (Phase 2D)
    all.sort((a, b) => {
        const sa = getAdaptiveScore(contextId, a.text, a.cat);
        const sb = getAdaptiveScore(contextId, b.text, b.cat);
        return sb - sa;
    });

    return all;
}

function addCustomCard(contextId, text, category) {
    const d = loadData();
    if (!d.customCards[contextId]) d.customCards[contextId] = [];
    d.customCards[contextId].push({text, cat:category, custom:true});
    saveData(d);
}

function getUsageStats() {
    const d = loadData();
    const total = d.totalSpoken || 0;
    const contexts = Object.keys(d.usage).reduce((acc, key) => {
        const ctx = key.split(':')[0];
        acc[ctx] = (acc[ctx] || 0) + d.usage[key].count;
        return acc;
    }, {});
    const topCards = Object.entries(d.usage)
        .sort((a,b) => b[1].count - a[1].count)
        .slice(0, 5);
    return {total, contexts, topCards};
}

// ============================================================
// TTS ‚Äî Voice picker
// ============================================================
let allVoices = [], preferredVoice = null, speechRate = 0.92;

const VOICE_GENDER = {
    'Daniel':'male','Gordon':'male','James':'male','Aaron':'male','Arthur':'male','Fred':'male','Alex':'male','Tom':'male','Oliver':'male','Rishi':'male','Lee':'male','Ralph':'male','Albert':'male','Eddy':'male','Evan':'male','Liam':'male','Malcolm':'male',
    'Samantha':'female','Karen':'female','Moira':'female','Tessa':'female','Fiona':'female','Victoria':'female','Serena':'female','Kate':'female','Zoe':'female','Nicky':'female','Allison':'female','Ava':'female','Susan':'female','Sandy':'female','Shelley':'female','Martha':'female','Matilda':'female','Catherine':'female','Veena':'female','Reed':'female',
};

function classifyVoice(v) {
    for (const [n,g] of Object.entries(VOICE_GENDER)) { if (v.name.includes(n)) return g; }
    if (/\bMale\b/i.test(v.name)) return 'male';
    if (/\bFemale\b/i.test(v.name)) return 'female';
    return 'unknown';
}

function getEnglishVoices() { return allVoices.filter(v => v.lang.startsWith('en')); }

function initVoices() {
    allVoices = speechSynthesis.getVoices();
    const saved = loadData().preferences;
    if (saved.voiceRate) speechRate = saved.voiceRate;
    const english = getEnglishVoices();
    if (saved.voiceName) {
        const f = english.find(v => v.name === saved.voiceName);
        if (f) { preferredVoice = f; renderVoiceSettings(); return; }
    }
    for (const n of ['Daniel','Gordon','James','Aaron','Arthur','Fred','Alex']) {
        const f = english.find(v => v.name.includes(n));
        if (f) { preferredVoice = f; break; }
    }
    if (!preferredVoice && english.length) preferredVoice = english[0];
    renderVoiceSettings();
}

function renderVoiceSettings() {
    const english = getEnglishVoices();
    const males = english.filter(v => classifyVoice(v)==='male');
    const females = english.filter(v => classifyVoice(v)==='female');
    const unknowns = english.filter(v => classifyVoice(v)==='unknown');
    const maleEl = document.getElementById('maleVoices');
    const femaleEl = document.getElementById('femaleVoices');
    if (!maleEl) return;
    const voiceHTML = (v) => {
        const sel = preferredVoice && preferredVoice.name === v.name;
        const region = {'AU':'Australia','GB':'UK','US':'US','IE':'Ireland','IN':'India','ZA':'South Africa','NZ':'New Zealand'}[v.lang.replace('en-','').toUpperCase()] || v.lang;
        const dn = v.name.replace(/com\.apple\.\w+\./g,'').replace(/Microsoft\s+/g,'');
        const sn = v.name.replace(/'/g,"\\'");
        return `<div class="voice-option${sel?' selected':''}" onclick="app.selectVoice('${sn}')"><div class="voice-radio"><div class="voice-radio-dot"></div></div><div class="voice-info"><div class="voice-name">${dn}</div><div class="voice-detail">${region}</div></div><button class="voice-preview-btn" onclick="event.stopPropagation();app.previewVoice('${sn}')">‚ñ∂</button></div>`;
    };
    maleEl.innerHTML = [...males,...unknowns].map(voiceHTML).join('') || '<div style="color:var(--text-muted);font-size:12px;padding:8px">No male voices found.</div>';
    femaleEl.innerHTML = females.map(voiceHTML).join('') || '<div style="color:var(--text-muted);font-size:12px;padding:8px">No female voices found.</div>';
    const slider = document.getElementById('speedSlider');
    const val = document.getElementById('speedValue');
    if (slider) slider.value = speechRate;
    if (val) val.textContent = speechRate.toFixed(2) + '√ó';
}

if ('speechSynthesis' in window) { speechSynthesis.onvoiceschanged = initVoices; initVoices(); }

function speakText(text) {
    if (!('speechSynthesis' in window)) return false;
    speechSynthesis.cancel();
    const utt = new SpeechSynthesisUtterance(text);
    if (preferredVoice) utt.voice = preferredVoice;
    utt.rate = speechRate; utt.pitch = 0.95; utt.volume = 1;
    utt.onend = () => {
        document.getElementById('phraseCard').classList.remove('speaking');
        document.getElementById('speakBtn').classList.remove('speaking');
        document.getElementById('speakBtn').textContent = 'TAP TO SPEAK';
    };
    document.getElementById('phraseCard').classList.add('speaking');
    document.getElementById('speakBtn').classList.add('speaking');
    document.getElementById('speakBtn').textContent = 'üîä Speaking...';
    speechSynthesis.speak(utt);
    return true;
}

// TOAST
let toastTimer = null;
function showToast(msg, type) {
    const t = document.getElementById('toast');
    t.textContent = msg; t.className = 'toast show' + (type ? ' '+type : '');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => t.classList.remove('show'), 2200);
}

// INSTALL
function dismissInstall() {
    document.getElementById('installBanner').classList.remove('visible');
    try { localStorage.setItem('ryans-aac-install-dismissed','1'); } catch {}
}
function checkInstallBanner() {
    const standalone = window.matchMedia('(display-mode:standalone)').matches || window.navigator.standalone;
    if (!standalone && !localStorage.getItem('ryans-aac-install-dismissed')) document.getElementById('installBanner').classList.add('visible');
}

// ============================================================
// CONVERSATION LISTENING ENGINE (Phase 2C)
// ============================================================
let recognition = null;
let isListening = false;
let conversationTranscript = [];
let lastTranscriptUpdate = 0;
let detectedTopic = '';
let detectedKeywords = [];
let suggestedPhrases = [];

// Keyword ‚Üí topic mapping
const TOPIC_KEYWORDS = {
    story:   ['story','book','read','character','chapter','plot','page','author','picture','illustration','reading','wrote','writing','tale','narrative','hero','villain'],
    math:    ['math','maths','number','calculate','equation','multiply','divide','add','subtract','algebra','geometry','fraction','decimal','percent','angle','triangle','formula','theorem','proof','pattern','symmetry'],
    gaming:  ['game','play','video','level','score','player','team','controller','minecraft','roblox','fortnite','youtube','stream','watch','movie','show','episode','season','character','boss','quest'],
    school:  ['school','class','teacher','homework','assignment','test','exam','project','grade','lesson','subject','science','history','english','student','study','learn','lecture'],
    home:    ['dinner','breakfast','lunch','food','eat','cook','bed','sleep','shower','bath','clothes','clean','chore','family','mum','dad','brother','sister','parent'],
    sensory: ['loud','noise','smell','bright','light','touch','hot','cold','hurt','pain','sick','headache','dizzy','tired','uncomfortable'],
};

// Question patterns ‚Üí response type
const QUESTION_PATTERNS = [
    {pattern:/\b(how are you|how's it going|how you going|how ya going)\b/i, type:'feelings'},
    {pattern:/\b(do you want|would you like|wanna|want to)\b/i, type:'yesno'},
    {pattern:/\b(what do you think|what's your opinion|reckon)\b/i, type:'opinions'},
    {pattern:/\b(did you like|do you like|enjoy)\b/i, type:'preferences'},
    {pattern:/\b(what happened|what's going on|what's up)\b/i, type:'narrative'},
    {pattern:/\b(can you|could you|will you|would you)\b/i, type:'yesno'},
    {pattern:/\b(are you okay|you alright|you right)\b/i, type:'feelings'},
    {pattern:/\b(where|when|who|which)\b/i, type:'specific'},
    {pattern:/\b(why)\b/i, type:'explanation'},
    {pattern:/\b(is it|are they|was it|isn't|aren't|doesn't|don't)\b/i, type:'yesno'},
];

// Response type ‚Üí category + boost phrases
const RESPONSE_SUGGESTIONS = {
    feelings: {boostCats:['feelings','greetings'], boostPhrases:["I'm feeling good today.","I'm a bit tired.","I'm a bit frustrated right now.","I'm feeling overwhelmed.","Not bad, thanks. You?"]},
    yesno: {boostCats:['responses'], boostPhrases:["Yeah, for sure.","No thanks, maybe later.","Maybe, I'll think about it.","I'm not sure about that.","Sounds good."]},
    opinions: {boostCats:['opinions'], boostPhrases:["I think that's a great idea.","I'm not convinced about that.","Fair enough.","I reckon that could work.","It depends on the situation."]},
    preferences: {boostCats:['responses','feelings'], boostPhrases:["I like how that works.","That's not really my thing.","That was really funny.","That's a good point.","I hadn't thought of it that way."]},
    narrative: {boostCats:['social','feelings'], boostPhrases:["I've been thinking about something.","Something happened at school.","I had a good day today.","Tell me more about that."]},
    specific: {boostCats:['responses','requests'], boostPhrases:["I'm not sure about that.","Give me a moment to think.","Can you ask me a yes or no question?"]},
    explanation: {boostCats:['opinions','responses'], boostPhrases:["It depends on the situation.","There's more to it than that.","I reckon so.","Can we look at it from a different angle?"]},
};

function initSpeechRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) return null;
    const rec = new SpeechRecognition();
    rec.continuous = true;
    rec.interimResults = true;
    rec.lang = 'en-AU';
    rec.maxAlternatives = 1;

    rec.onresult = (event) => {
        let finalTranscript = '';
        let interimTranscript = '';
        for (let i = event.resultIndex; i < event.results.length; i++) {
            const t = event.results[i][0].transcript;
            if (event.results[i].isFinal) finalTranscript += t;
            else interimTranscript += t;
        }
        if (finalTranscript) {
            conversationTranscript.push({text:finalTranscript.trim(), time:Date.now()});
            // Keep last 20 utterances
            if (conversationTranscript.length > 20) conversationTranscript = conversationTranscript.slice(-20);
            processConversation(finalTranscript.trim());
        }
        // Update transcript display
        const recent = conversationTranscript.slice(-5).map(u => u.text).join(' ... ');
        updateTranscriptDisplay(recent + (interimTranscript ? ' ' + interimTranscript : ''));
    };

    rec.onerror = (event) => {
        if (event.error === 'no-speech') return; // Normal ‚Äî no one talking
        if (event.error === 'aborted') return;
        console.log('Speech recognition error:', event.error);
        if (event.error === 'not-allowed') {
            showToast('Microphone permission needed. Check Settings ‚Üí Safari.');
            stopListening();
        }
    };

    rec.onend = () => {
        // Auto-restart if still supposed to be listening
        if (isListening) {
            try { rec.start(); } catch(e) {}
        }
    };

    return rec;
}

function startListening() {
    if (!recognition) recognition = initSpeechRecognition();
    if (!recognition) {
        showToast('Speech recognition not available on this device');
        return;
    }
    try {
        recognition.start();
        isListening = true;
        document.getElementById('listenToggle').classList.add('active');
        document.getElementById('listenLabel').textContent = 'Listening...';
        document.getElementById('listenTopic').textContent = 'üé§ Hearing conversation...';
        document.getElementById('listenTopic').classList.remove('has-topic');
    } catch(e) {
        // Already started
        if (e.name === 'InvalidStateError') {
            isListening = true;
        }
    }
}

function stopListening() {
    isListening = false;
    if (recognition) {
        try { recognition.stop(); } catch(e) {}
    }
    document.getElementById('listenToggle').classList.remove('active');
    document.getElementById('listenLabel').textContent = 'Listen';
    document.getElementById('listenTopic').textContent = 'Tap Listen to hear the conversation';
    document.getElementById('listenTopic').classList.remove('has-topic');
}

function processConversation(text) {
    const lower = text.toLowerCase();

    // 1. Extract keywords
    const words = lower.replace(/[^\w\s]/g,'').split(/\s+/).filter(w => w.length > 2);
    detectedKeywords = [];
    for (const [topic, keywords] of Object.entries(TOPIC_KEYWORDS)) {
        for (const kw of keywords) {
            if (lower.includes(kw)) {
                detectedKeywords.push({word:kw, topic});
            }
        }
    }

    // 2. Detect topic
    const topicCounts = {};
    detectedKeywords.forEach(k => { topicCounts[k.topic] = (topicCounts[k.topic]||0) + 1; });
    const topTopic = Object.entries(topicCounts).sort((a,b) => b[1]-a[1])[0];
    if (topTopic) detectedTopic = topTopic[0];

    // 3. Detect question type
    let questionType = null;
    for (const q of QUESTION_PATTERNS) {
        if (q.pattern.test(lower)) { questionType = q.type; break; }
    }

    // 4. Score and suggest phrases
    scorePhrases(detectedKeywords, questionType, detectedTopic);

    // 5. Update UI
    updateListeningUI();
}

function scorePhrases(keywords, questionType, topic) {
    if (!app.currentContext) return;
    const allCards = getCardsForContext(app.currentContext);
    const scores = [];

    allCards.forEach((card, i) => {
        let score = 0;
        const cardLower = card.text.toLowerCase();

        // Keyword match ‚Äî each keyword match = +3
        keywords.forEach(kw => {
            if (cardLower.includes(kw.word)) score += 3;
        });

        // Question type match ‚Äî matching category = +5
        if (questionType && RESPONSE_SUGGESTIONS[questionType]) {
            const rs = RESPONSE_SUGGESTIONS[questionType];
            if (rs.boostCats.includes(card.cat)) score += 5;
            if (rs.boostPhrases.includes(card.text)) score += 8;
        }

        // Topic context match ‚Äî if topic matches a different context, suggest switching
        // For now, just boost cards in current context
        if (topic === app.currentContext) score += 2;

        // Usage history bonus
        const usageScore = getCardScore(app.currentContext, card.text);
        score += usageScore * 0.5;

        if (score > 0) scores.push({card, score, index:i});
    });

    // Also add cross-context suggestions if topic differs from current context
    if (topic && topic !== app.currentContext && CARD_DATA[topic]) {
        CARD_DATA[topic].cards.slice(0,5).forEach(card => {
            let score = 2;
            const cardLower = card.text.toLowerCase();
            keywords.forEach(kw => { if (cardLower.includes(kw.word)) score += 3; });
            if (questionType && RESPONSE_SUGGESTIONS[questionType]) {
                const rs = RESPONSE_SUGGESTIONS[questionType];
                if (rs.boostCats.includes(card.cat)) score += 4;
                if (rs.boostPhrases.includes(card.text)) score += 6;
            }
            if (score > 2) scores.push({card, score, crossContext:topic});
        });
    }

    // If question detected but no keyword matches, suggest based on question type alone
    if (scores.length === 0 && questionType && RESPONSE_SUGGESTIONS[questionType]) {
        const rs = RESPONSE_SUGGESTIONS[questionType];
        rs.boostPhrases.forEach(text => {
            const card = allCards.find(c => c.text === text);
            if (card) scores.push({card, score:5});
        });
    }

    scores.sort((a,b) => b.score - a.score);
    suggestedPhrases = scores.slice(0,6);
}

function updateListeningUI() {
    // Topic display
    const topicEl = document.getElementById('listenTopic');
    if (detectedKeywords.length) {
        const topicName = detectedTopic ? (CARD_DATA[detectedTopic]?.label || detectedTopic) : 'General';
        const kws = detectedKeywords.slice(0,3).map(k => k.word).join(', ');
        topicEl.textContent = `Topic: ${topicName} ¬∑ "${kws}"`;
        topicEl.classList.add('has-topic');
    }

    // Suggested cards strip
    const strip = document.getElementById('suggestedStrip');
    const container = document.getElementById('suggestedCards');
    if (suggestedPhrases.length > 0) {
        strip.classList.add('visible');
        container.innerHTML = suggestedPhrases.map(s => {
            const escaped = s.card.text.replace(/'/g, "\\'");
            const pct = Math.min(99, Math.round(s.score * 5));
            const cross = s.crossContext ? ` ¬∑ ${s.crossContext}` : '';
            return `<button class="suggested-card" onclick="app.speakSuggested('${escaped}')">${s.card.text}<span class="match-score">${pct}%${cross}</span></button>`;
        }).join('');
    } else {
        strip.classList.remove('visible');
    }

    // Also reorder the main card stack
    if (suggestedPhrases.length > 0 && app.currentContext) {
        reorderCardsFromSuggestions();
    }
}

function reorderCardsFromSuggestions() {
    // Move suggested cards to the front of filteredCards
    const suggestedTexts = new Set(suggestedPhrases.filter(s => !s.crossContext).map(s => s.card.text));
    const suggested = app.filteredCards.filter(c => suggestedTexts.has(c.text));
    const rest = app.filteredCards.filter(c => !suggestedTexts.has(c.text));
    app.filteredCards = [...suggested, ...rest];
    app.index = 0;
    app.updateCard();
}

function updateTranscriptDisplay(text) {
    const el = document.getElementById('transcriptText');
    if (!el) return;
    // Highlight keywords
    let html = text;
    detectedKeywords.forEach(kw => {
        const regex = new RegExp(`\\b(${kw.word})\\b`, 'gi');
        html = html.replace(regex, '<span class="keyword">$1</span>');
    });
    el.innerHTML = html || 'Listening...';
}

// ============================================================
// APP CONTROLLER
// ============================================================
const app = {
    currentContext: null,
    currentCategory: 'all',
    cards: [],
    filteredCards: [],
    index: 0,
    touchStartX: 0, touchStartY: 0, swiping: false,
    modalCategory: null,

    init() {
        this.renderHome();
        this.setupSwipe();
        checkInstallBanner();
    },

    // Quick speak ‚Äî for Yes/No bar, speaks immediately
    quickSpeak(text) {
        speakText(text);
        trackUsage('quick', text);
    },

    // Conversation Listening
    toggleListening() {
        if (isListening) stopListening();
        else startListening();
    },

    toggleTranscript() {
        const panel = document.getElementById('transcriptPanel');
        panel.classList.toggle('open');
    },

    speakSuggested(text) {
        speakText(text);
        if (this.currentContext) trackUsage(this.currentContext, text);
        this.renderStats();
    },

    // SOS Dashboard
    openSOS() {
        document.getElementById('contextBadge').textContent = '‚ö° Quick SOS';
        document.getElementById('backBtn').classList.add('visible');
        this.renderSOSDashboard();
        this.showScreen('sosScreen');
    },

    renderSOSDashboard() {
        const groups = [
            { id:'sound', label:'üîä Sound', icon:'üîä', color:'sound', phrases:[
                {icon:'üîá',text:'It\'s too loud in here.'},
                {icon:'üéß',text:'I need my headphones.'},
                {icon:'ü§´',text:'Please stop that noise.'},
                {icon:'üì¢',text:'Turn the volume down.'},
                {icon:'üò£',text:'That noise hurts my ears.'},
                {icon:'üèÉ',text:'Can we go somewhere quieter?'},
            ]},
            { id:'smell', label:'üëÉ Smell', icon:'üëÉ', color:'smell', phrases:[
                {icon:'ü§¢',text:'That smell is making me sick.'},
                {icon:'üí®',text:'I need fresh air.'},
                {icon:'üö´',text:'That perfume is too strong.'},
                {icon:'üç≥',text:'The food smell is too much.'},
                {icon:'üèÉ',text:'Can we move away from here?'},
            ]},
            { id:'light', label:'üí° Light & Visual', icon:'üí°', color:'light', phrases:[
                {icon:'üòé',text:'The light is too bright.'},
                {icon:'‚ö°',text:'That flickering is bothering me.'},
                {icon:'üôà',text:'Too much going on visually.'},
                {icon:'üëÅÔ∏è',text:'I need to close my eyes.'},
            ]},
            { id:'touch', label:'‚úã Touch & Texture', icon:'‚úã', color:'touch', phrases:[
                {icon:'üö´',text:'Don\'t touch me right now.'},
                {icon:'üëï',text:'These clothes are bothering me.'},
                {icon:'üí∫',text:'The seat feels wrong.'},
                {icon:'üòñ',text:'This texture is uncomfortable.'},
            ]},
            { id:'overwhelm', label:'üåä Overwhelmed', icon:'üåä', color:'overwhelm', phrases:[
                {icon:'üÜò',text:'Everything is too much right now.',full:true},
                {icon:'üö™',text:'I need to leave right now.',full:true},
                {icon:'üõë',text:'I\'m about to have a meltdown.',full:true},
                {icon:'‚ÜîÔ∏è',text:'I need space. Please step back.'},
                {icon:'‚è∏Ô∏è',text:'I\'m shutting down. Give me time.'},
                {icon:'ü§ê',text:'Stop talking to me for a moment.'},
                {icon:'üßò',text:'I\'m trying to calm down.'},
                {icon:'üß†',text:'I can\'t think clearly right now.'},
                {icon:'üë•',text:'Too many people.'},
            ]},
            { id:'needs', label:'üéØ I Need', icon:'üéØ', color:'needs', phrases:[
                {icon:'ü§´',text:'I need a quiet space.',full:true},
                {icon:'‚è∞',text:'I need a break. 5 minutes.'},
                {icon:'üíß',text:'I need water.'},
                {icon:'üöΩ',text:'I need the bathroom.'},
                {icon:'üè†',text:'I need to go home.'},
                {icon:'üß∏',text:'I need my comfort item.'},
                {icon:'üí∫',text:'I need to sit down.'},
                {icon:'üèÉ',text:'I need to move around.'},
                {icon:'üë§',text:'I need someone I trust.'},
                {icon:'üîÑ',text:'I need my calming routine.'},
            ]},
            { id:'explain', label:'üí¨ Explain to Others', icon:'üí¨', color:'explain', phrases:[
                {icon:'üß©',text:'I\'m autistic. I process differently.',full:true},
                {icon:'üíô',text:'I\'m not rude, I\'m overwhelmed.',full:true},
                {icon:'‚è≥',text:'I need more time to respond.'},
                {icon:'üì±',text:'I communicate using this app.'},
                {icon:'ü§ù',text:'Please be patient with me.'},
                {icon:'üëÇ',text:'I hear you. I can\'t respond yet.'},
                {icon:'üîá',text:'Loud noises physically hurt me.'},
                {icon:'üëÉ',text:'Strong smells make me feel sick.'},
            ]},
        ];

        let html = '';
        groups.forEach(g => {
            html += `<div class="sos-group ${g.color}">`;
            html += `<div class="sos-group-label ${g.color}">${g.label}</div>`;
            html += `<div class="sos-grid">`;
            g.phrases.forEach(p => {
                const escaped = p.text.replace(/'/g, "\\'");
                html += `<button class="sos-btn${p.full?' full-width':''}" onclick="app.sosTap(this,'${escaped}')"><span class="sos-icon">${p.icon}</span>${p.text}</button>`;
            });
            html += `</div></div>`;
        });
        document.getElementById('sosContent').innerHTML = html;
    },

    sosTap(el, text) {
        // Visual feedback
        document.querySelectorAll('.sos-btn').forEach(b => b.classList.remove('speaking-active'));
        el.classList.add('speaking-active');
        speakText(text);
        trackUsage('sensory', text);
        setTimeout(() => el.classList.remove('speaking-active'), 2000);
    },

    renderHome() {
        const grid = document.getElementById('contextGrid');
        const groups = {urgent:'‚ö° Quick Access', activities:'Activity Contexts', life:'Everyday Life', languages:'Languages', tools:'Tools'};
        let html = '';
        for (const [gid, glabel] of Object.entries(groups)) {
            const ctxs = CONTEXTS.filter(c => c.group === gid);
            if (!ctxs.length) continue;
            html += `<div class="section-label">${glabel}</div><div class="context-grid${gid==='urgent'?' urgent-grid':''}">`;
            html += ctxs.map(ctx => {
                const count = CARD_DATA[ctx.id] ? CARD_DATA[ctx.id].cards.length : 0;
                const customCount = (loadData().customCards[ctx.id] || []).length;
                const total = count + customCount;
                const isUrgent = gid === 'urgent';
                let action;
                if (ctx.comingSoon) action = `showToast('${ctx.label} ‚Äî coming soon!')`;
                else if (ctx.id === 'settings') action = `app.openSettings()`;
                else if (ctx.id === 'sensory') action = `app.openSOS()`;
                else action = `app.loadContext('${ctx.id}')`;
                return `<div class="context-tile${ctx.comingSoon?' coming-soon':''}${isUrgent?' urgent-tile':''}" onclick="${action}"><div class="tile-icon">${ctx.icon}</div><div style="${isUrgent?'text-align:left':''}"><div class="tile-label">${ctx.label}</div>${total?`<div class="tile-count">${total} phrases${isUrgent?' ‚Äî sensory, overwhelm, needs':''}</div>`:''}</div></div>`;
            }).join('');
            html += '</div>';
        }
        grid.innerHTML = html;
    },

    loadContext(id) {
        this.currentContext = id;
        this.currentCategory = 'all';
        this.cards = getCardsForContext(id);
        this.filteredCards = [...this.cards];
        this.index = 0;
        const ctx = CARD_DATA[id];
        document.getElementById('contextBadge').textContent = ctx.label;
        document.getElementById('backBtn').classList.add('visible');
        this.renderCategories(ctx.categories);
        this.renderStats();
        this.showScreen('swipeScreen');
        this.updateCard();
        this.updatePredictionHints();

        // Auto-suggest preferred category if strong preference detected
        const pref = getPreferredCategory(id);
        if (pref && pref.share > 55) {
            // Show a hint but don't auto-filter (respect user choice)
            showToast(`Tip: you often use ${pref.category} (${pref.share}%) here`);
        }
    },

    renderCategories(cats) {
        const bar = document.getElementById('categoryBar');
        bar.innerHTML = `<button class="cat-btn active" data-cat="all" onclick="app.filterCat('all',this)">All</button>` +
            cats.map(c => `<button class="cat-btn" data-cat="${c}" onclick="app.filterCat('${c}',this)">${c[0].toUpperCase()+c.slice(1)}</button>`).join('');
    },

    renderStats() {
        const bar = document.getElementById('statsBar');
        const stats = getUsageStats();
        const ctxCount = stats.contexts[this.currentContext] || 0;
        bar.innerHTML = `<div class="stat-chip">Total spoken: <span class="stat-val">${stats.total}</span></div>` +
            `<div class="stat-chip">This context: <span class="stat-val">${ctxCount}</span></div>` +
            `<div class="stat-chip">Cards: <span class="stat-val">${this.cards.length}</span></div>`;
    },

    filterCat(cat, el) {
        this.currentCategory = cat;
        this.filteredCards = cat === 'all' ? [...this.cards] : this.cards.filter(c => c.cat === cat);
        this.index = 0;
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        if (el) el.classList.add('active');
        this.updateCard();
    },

    updateCard() {
        const fc = this.filteredCards;
        const subEl = document.getElementById('phraseSub');
        const freqEl = document.getElementById('cardFreqBadge');
        subEl.style.display = 'none';
        freqEl.classList.remove('visible');

        if (!fc.length) {
            document.getElementById('phraseText').textContent = "No phrases here yet.";
            document.getElementById('cardCatTag').textContent = "";
            document.getElementById('cardCounter').textContent = "";
            document.getElementById('cardDots').innerHTML = "";
            document.getElementById('prevArrow').disabled = true;
            document.getElementById('nextArrow').disabled = true;
            return;
        }
        const card = fc[this.index];
        document.getElementById('phraseText').textContent = card.text;
        document.getElementById('cardCatTag').textContent = card.cat;
        document.getElementById('cardCounter').textContent = `${this.index+1} of ${fc.length}`;
        document.getElementById('prevArrow').disabled = this.index === 0;
        document.getElementById('nextArrow').disabled = this.index === fc.length - 1;

        // Show transliteration for Malayalam
        if (card.sub) {
            subEl.textContent = card.sub;
            subEl.style.display = 'block';
        }

        // Show adaptive prediction badges (Phase 2D)
        const adaptiveScore = getAdaptiveScore(this.currentContext, card.text, card.cat);
        const seqPredictions = getSequencePredictions(this.currentContext, 5);
        const isSequenceMatch = seqPredictions.some(s => s.text === card.text);
        const timePredictions = getTimeOfDayPredictions(this.currentContext, 5);
        const isTimeMatch = timePredictions.some(t => t.text === card.text);
        const baseScore = getCardScore(this.currentContext, card.text);

        if (isSequenceMatch) {
            freqEl.classList.add('visible');
            freqEl.textContent = 'üîó You usually say this next';
        } else if (isTimeMatch && baseScore < 3) {
            freqEl.classList.add('visible');
            freqEl.textContent = 'üïê Common at this time';
        } else if (baseScore >= 3) {
            freqEl.classList.add('visible');
            freqEl.textContent = '‚≠ê Favourite';
        } else if (baseScore >= 1) {
            freqEl.classList.add('visible');
            freqEl.textContent = 'üìä Used ' + Math.round(baseScore) + '√ó';
        }

        this.updateDots();
    },

    updateDots() {
        const total = this.filteredCards.length;
        const max = Math.min(total, 9);
        let html = '';
        for (let i = 0; i < max; i++) {
            html += `<div class="dot${i === Math.min(this.index, max-1) ? ' active' : ''}"></div>`;
        }
        document.getElementById('cardDots').innerHTML = html;
    },

    next() {
        if (this.index < this.filteredCards.length - 1) { this.index++; this.animateCard('left'); }
    },
    prev() {
        if (this.index > 0) { this.index--; this.animateCard('right'); }
    },
    animateCard(dir) {
        const c = document.getElementById('phraseCard');
        c.style.transition = 'transform 0.15s ease,opacity 0.15s ease';
        c.style.transform = `translateX(${dir==='left'?'-30':'30'}px)`; c.style.opacity = '0.5';
        setTimeout(() => {
            this.updateCard();
            c.style.transition = 'none';
            c.style.transform = `translateX(${dir==='left'?'30':'-30'}px)`; c.style.opacity = '0.5';
            requestAnimationFrame(() => {
                c.style.transition = 'transform 0.2s ease,opacity 0.2s ease';
                c.style.transform = 'translateX(0)'; c.style.opacity = '1';
            });
        }, 150);
    },

    setupSwipe() {
        const vp = document.getElementById('cardViewport');
        vp.addEventListener('touchstart', e => { this.touchStartX = e.changedTouches[0].clientX; this.touchStartY = e.changedTouches[0].clientY; this.swiping = false; }, {passive:true});
        vp.addEventListener('touchmove', e => { const dx = Math.abs(e.changedTouches[0].clientX - this.touchStartX); const dy = Math.abs(e.changedTouches[0].clientY - this.touchStartY); if (dx > 10 && dx > dy) this.swiping = true; }, {passive:true});
        vp.addEventListener('touchend', e => { if (!this.swiping) return; const dx = this.touchStartX - e.changedTouches[0].clientX; const dy = Math.abs(this.touchStartY - e.changedTouches[0].clientY); if (Math.abs(dx) > 40 && dy < 120) { dx > 0 ? this.next() : this.prev(); } }, {passive:true});
        document.addEventListener('keydown', e => { if (this.currentContext) { if (e.key==='ArrowLeft') this.prev(); if (e.key==='ArrowRight') this.next(); } });
    },

    speak() {
        const fc = this.filteredCards;
        const card = fc[this.index];
        const text = document.getElementById('phraseText').textContent;
        if (text && !['Loading...','No phrases here yet.'].includes(text)) {
            // Track usage with category for Phase 2D adaptive learning
            if (this.currentContext) trackUsage(this.currentContext, text, card?.cat);
            this.renderStats();
            this.updatePredictionHints();

            if (!speakText(text)) showToast('‚úì ' + text);
        }
    },

    // ADD PHRASE
    openAddPhrase() {
        if (!this.currentContext) return;
        const cats = CARD_DATA[this.currentContext].categories;
        this.modalCategory = cats[0];
        document.getElementById('modalCategorySelect').innerHTML = cats.map(c =>
            `<button class="modal-cat-opt${c===this.modalCategory?' selected':''}" onclick="app.setModalCat('${c}',this)">${c[0].toUpperCase()+c.slice(1)}</button>`
        ).join('');
        document.getElementById('phraseInput').value = '';
        document.getElementById('addPhraseModal').classList.add('open');
        setTimeout(() => document.getElementById('phraseInput').focus(), 350);
    },
    setModalCat(cat, el) { this.modalCategory = cat; document.querySelectorAll('.modal-cat-opt').forEach(b => b.classList.remove('selected')); el.classList.add('selected'); },
    closeAddPhrase() { document.getElementById('addPhraseModal').classList.remove('open'); },
    savePhrase() {
        const text = document.getElementById('phraseInput').value.trim();
        if (!text) { showToast('Please type a phrase first'); return; }
        addCustomCard(this.currentContext, text, this.modalCategory);
        this.cards = getCardsForContext(this.currentContext);
        this.filterCat(this.currentCategory, document.querySelector(`.cat-btn[data-cat="${this.currentCategory}"]`));
        this.closeAddPhrase();
        showToast('‚úì Phrase added!', 'success');
        this.renderHome();
    },

    // PREDICTION HINTS ‚Äî update the stats bar with adaptive insights
    updatePredictionHints() {
        if (!this.currentContext) return;
        const summary = getPredictionSummary(this.currentContext);
        const bar = document.getElementById('statsBar');
        const stats = getUsageStats();
        const ctxCount = stats.contexts[this.currentContext] || 0;
        let html = `<div class="stat-chip">Total: <span class="stat-val">${stats.total}</span></div>`;
        html += `<div class="stat-chip">This context: <span class="stat-val">${ctxCount}</span></div>`;
        
        // Session timer
        if (summary.session) {
            html += `<div class="stat-chip">Session: <span class="stat-val">${summary.session.minutes}m</span>${summary.session.isLong?' ‚ö†Ô∏è':''}</div>`;
        }
        
        // Category preference
        if (summary.catPref) {
            html += `<div class="stat-chip">Prefers: <span class="stat-val">${summary.catPref.category} (${summary.catPref.share}%)</span></div>`;
        }

        bar.innerHTML = html;
    },

    // SCREEN NAV
    showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); },
    goHome() {
        this.currentContext = null;
        this.showScreen('homeScreen');
        document.getElementById('contextBadge').textContent = 'Home';
        document.getElementById('backBtn').classList.remove('visible');
        speechSynthesis.cancel();
        stopListening();
        document.getElementById('suggestedStrip').classList.remove('visible');
        document.getElementById('transcriptPanel').classList.remove('open');
        conversationTranscript = [];
        detectedKeywords = [];
        suggestedPhrases = [];
        this.renderHome();
    },

    // SETTINGS
    openSettings() {
        document.getElementById('contextBadge').textContent = '‚öôÔ∏è Settings';
        document.getElementById('backBtn').classList.add('visible');
        renderVoiceSettings();
        // Render usage stats
        const stats = getUsageStats();
        const el = document.getElementById('usageStatsContent');
        let html = `<p>Total phrases spoken: <strong style="color:var(--accent-gold)">${stats.total}</strong></p>`;
        if (stats.topCards.length) {
            html += '<p style="margin-top:10px">Top phrases:</p>';
            stats.topCards.forEach(([key, u]) => {
                const txt = key.split(':').slice(1).join(':');
                html += `<p style="margin:4px 0;padding:6px 10px;background:var(--bg-elevated);border-radius:8px;font-size:13px">"${txt.substring(0,50)}${txt.length>50?'...':''}" ‚Äî <span style="color:var(--accent-gold)">${u.count}√ó</span></p>`;
            });
        }
        el.innerHTML = html;

        // Render prediction insights (Phase 2D)
        const pi = document.getElementById('predictionInsights');
        let piHtml = '';
        const d = loadData();
        
        // Sequence patterns
        const seqCount = Object.keys(d.sequences).length;
        piHtml += `<p>üîó Sequence patterns learned: <strong style="color:var(--accent-gold)">${seqCount}</strong></p>`;
        
        // Time buckets
        const bucketCount = Object.keys(d.hourBuckets).length;
        piHtml += `<p>üïê Time-of-day patterns: <strong style="color:var(--accent-gold)">${bucketCount}</strong> data points</p>`;
        
        // Category preferences
        const catContexts = Object.keys(d.catPrefs).length;
        piHtml += `<p>üìÇ Category preferences tracked: <strong style="color:var(--accent-gold)">${catContexts}</strong> contexts</p>`;
        Object.entries(d.catPrefs).forEach(([ctx, cats]) => {
            const total = Object.values(cats).reduce((s,v) => s+v, 0);
            if (total >= 5) {
                const top = Object.entries(cats).sort((a,b) => b[1]-a[1])[0];
                const pct = Math.round(top[1]/total*100);
                piHtml += `<p style="margin:3px 0 3px 12px;font-size:12px;color:var(--text-muted)">‚Ä¢ ${ctx}: prefers <strong>${top[0]}</strong> (${pct}%)</p>`;
            }
        });

        // Sessions
        piHtml += `<p style="margin-top:8px">üìä Sessions tracked: <strong style="color:var(--accent-gold)">${d.sessions.length}</strong></p>`;
        if (d.sessions.length > 0) {
            const avgDuration = d.sessions.reduce((s,ss) => s + (ss.lastActivity - ss.start), 0) / d.sessions.length / 60000;
            piHtml += `<p style="margin:3px 0 3px 12px;font-size:12px;color:var(--text-muted)">‚Ä¢ Average session: ${Math.round(avgDuration)} minutes</p>`;
        }

        // Top sequences
        const topSeqs = Object.entries(d.sequences)
            .map(([key, followers]) => {
                const top = Object.entries(followers).sort((a,b) => b[1]-a[1])[0];
                if (!top || top[1] < 2) return null;
                return {a:key.split(':').slice(1).join(':'), b:top[0], count:top[1]};
            })
            .filter(Boolean)
            .sort((a,b) => b.count - a.count)
            .slice(0,5);
        if (topSeqs.length > 0) {
            piHtml += '<p style="margin-top:8px">üîó Top phrase sequences:</p>';
            topSeqs.forEach(s => {
                piHtml += `<p style="margin:3px 0;padding:5px 10px;background:var(--bg-elevated);border-radius:8px;font-size:12px">"${s.a.substring(0,35)}‚Ä¶" ‚Üí "${s.b.substring(0,35)}‚Ä¶" <span style="color:var(--accent-gold)">${s.count}√ó</span></p>`;
            });
        }

        pi.innerHTML = piHtml || '<p>Not enough data yet. Keep using the app!</p>';

        this.showScreen('settingsScreen');
    },

    // OT Report Export
    exportOTReport() {
        const report = generateOTReport();
        navigator.clipboard.writeText(report).then(() => {
            showToast('üìã Report copied to clipboard!', 'success');
        }).catch(() => {
            // Fallback ‚Äî show in a prompt
            const ta = document.createElement('textarea');
            ta.value = report; ta.style.position = 'fixed'; ta.style.left = '-9999px';
            document.body.appendChild(ta); ta.select();
            try { document.execCommand('copy'); showToast('üìã Report copied!', 'success'); }
            catch { showToast('Could not copy ‚Äî try Download instead'); }
            document.body.removeChild(ta);
        });
    },

    downloadOTReport() {
        const report = generateOTReport();
        const blob = new Blob([report], {type:'text/plain'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ryans-aac-report-${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a); a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast('üíæ Report downloaded!', 'success');
    },
    selectVoice(name) {
        const v = getEnglishVoices().find(v => v.name === name);
        if (!v) return;
        preferredVoice = v;
        const d = loadData(); d.preferences.voiceName = name; saveData(d);
        renderVoiceSettings();
        showToast('‚úì Voice: ' + name.replace(/com\.apple\.\w+\./g,'').replace(/Microsoft\s+/g,''), 'success');
    },
    previewVoice(name) {
        const v = getEnglishVoices().find(v => v.name === name);
        if (!v) return;
        speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance("Hi, I'm Ryan's voice. This is how I sound.");
        u.voice = v; u.rate = speechRate; u.pitch = 0.95;
        speechSynthesis.speak(u);
    },
    updateSpeed(val) {
        speechRate = parseFloat(val);
        document.getElementById('speedValue').textContent = speechRate.toFixed(2) + '√ó';
        const d = loadData(); d.preferences.voiceRate = speechRate; saveData(d);
    }
};

if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').catch(()=>{});
window.addEventListener('DOMContentLoaded', () => app.init());
</script>
</body>
</html>
