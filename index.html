<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Ryan's AAC">
    <meta name="theme-color" content="#1a1a2e">
    <meta name="description" content="Ryan's personalised communication app">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>Ryan's Voice</title>
    <meta name="version" content="2.9.0">
    <meta name="author" content="IV">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=DM+Serif+Display&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-deep: #0f0f1a;
            --bg-card: #1a1a2e;
            --bg-surface: #16213e;
            --bg-elevated: #1f2b47;
            --accent-primary: #6c63ff;
            --accent-glow: #7c74ff;
            --accent-warm: #ff6b6b;
            --accent-success: #4ecdc4;
            --accent-gold: #ffd93d;
            --text-primary: #e8e8f0;
            --text-secondary: #8b8ba3;
            --text-muted: #5a5a7a;
            --border-subtle: rgba(108, 99, 255, 0.15);
            --border-active: rgba(108, 99, 255, 0.4);
            --shadow-card: 0 8px 32px rgba(0, 0, 0, 0.3);
            --radius-sm: 12px; --radius-md: 18px; --radius-lg: 24px; --radius-xl: 32px;
            --safe-top: env(safe-area-inset-top, 20px);
            --safe-bottom: env(safe-area-inset-bottom, 20px);
        }
        * { margin:0; padding:0; box-sizing:border-box; -webkit-tap-highlight-color:transparent; -webkit-touch-callout:none; }
        html, body { height:100%; overflow:hidden; }
        body { font-family:'DM Sans',-apple-system,BlinkMacSystemFont,sans-serif; background:var(--bg-deep); color:var(--text-primary); display:flex; flex-direction:column; height:100vh; height:100dvh; user-select:none; -webkit-user-select:none; }

        /* HEADER */
        .header { padding:calc(var(--safe-top) + 8px) 20px 12px; display:flex; justify-content:space-between; align-items:center; background:var(--bg-card); border-bottom:1px solid var(--border-subtle); flex-shrink:0; z-index:100; }
        .header-left { display:flex; align-items:center; gap:12px; }
        .header-title { font-family:'DM Serif Display',serif; font-size:22px; letter-spacing:-0.3px; }
        .context-badge { background:rgba(108,99,255,0.15); color:var(--accent-glow); padding:6px 14px; border-radius:20px; font-size:13px; font-weight:600; border:1px solid rgba(108,99,255,0.25); }
        .back-btn { display:none; background:rgba(108,99,255,0.12); border:1px solid rgba(108,99,255,0.2); color:var(--accent-glow); width:40px; height:40px; border-radius:12px; font-size:20px; cursor:pointer; align-items:center; justify-content:center; transition:all 0.2s; }
        .back-btn:active { transform:scale(0.92); }
        .back-btn.visible { display:flex; }

        /* SCREENS */
        .screen { display:none; flex-direction:column; flex:1; overflow:hidden; }
        .screen.active { display:flex; }

        /* HOME */
        .home-scroll { flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch; padding:24px 20px calc(var(--safe-bottom) + 20px); }
        .home-greeting { font-family:'DM Serif Display',serif; font-size:28px; margin-bottom:6px; }
        .home-subtitle { color:var(--text-secondary); font-size:15px; margin-bottom:20px; }
        .section-label { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:1.2px; color:var(--text-muted); margin:20px 0 10px; }
        .section-label:first-of-type { margin-top:0; }
        .context-grid { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
        .context-tile { background:var(--bg-card); border:1px solid var(--border-subtle); border-radius:var(--radius-lg); padding:22px 16px; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; cursor:pointer; transition:all 0.2s; min-height:130px; position:relative; overflow:hidden; }
        .context-tile::before { content:''; position:absolute; inset:0; background:radial-gradient(ellipse at 50% 0%,rgba(108,99,255,0.06),transparent 70%); pointer-events:none; }
        .context-tile:active { transform:scale(0.96); border-color:var(--border-active); }
        .context-tile .tile-icon { font-size:36px; margin-bottom:10px; }
        .context-tile .tile-label { font-size:14px; font-weight:600; line-height:1.35; }
        .context-tile .tile-count { font-size:11px; color:var(--text-muted); margin-top:4px; }
        .context-tile.coming-soon { opacity:0.45; }
        .context-tile.coming-soon .tile-label::after { content:' (soon)'; color:var(--text-muted); font-weight:400; font-size:11px; }
        .context-grid.urgent-grid { grid-template-columns:1fr; }
        .context-tile.urgent-tile { border-color:rgba(255,107,107,0.4); background:linear-gradient(135deg,rgba(255,107,107,0.08),rgba(255,160,60,0.06)); min-height:90px; flex-direction:row; gap:14px; padding:18px 22px; }
        .context-tile.urgent-tile .tile-icon { font-size:32px; margin:0; }
        .context-tile.urgent-tile .tile-label { color:var(--accent-warm); font-size:16px; }
        .context-tile.urgent-tile .tile-count { color:rgba(255,107,107,0.6); margin:0; }
        .context-tile.urgent-tile:active { border-color:var(--accent-warm); background:rgba(255,107,107,0.12); }

        /* CARD SWIPE */
        .swipe-area { flex:1; display:flex; flex-direction:column; overflow:hidden; }
        .card-viewport { flex:1; position:relative; display:flex; align-items:center; justify-content:center; padding:16px; touch-action:pan-y; }
        .phrase-card { width:100%; max-width:600px; background:var(--bg-card); border:2px solid var(--border-subtle); border-radius:var(--radius-xl); padding:36px 24px 28px; display:flex; flex-direction:column; align-items:center; justify-content:center; min-height:280px; position:relative; box-shadow:var(--shadow-card); transition:border-color 0.3s; will-change:transform; }
        .phrase-card::before { content:''; position:absolute; top:0; left:50%; transform:translateX(-50%); width:60%; height:1px; background:linear-gradient(90deg,transparent,var(--accent-primary),transparent); opacity:0.4; }
        .phrase-card.speaking { border-color:var(--accent-success); }
        .card-category-tag { position:absolute; top:14px; right:14px; font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:var(--text-muted); background:rgba(108,99,255,0.08); padding:3px 8px; border-radius:6px; }
        .card-freq-badge { position:absolute; top:14px; left:14px; font-size:10px; font-weight:700; color:var(--accent-gold); background:rgba(255,217,61,0.1); padding:3px 8px; border-radius:6px; display:none; }
        .card-freq-badge.visible { display:block; }
        .phrase-text { font-family:'DM Serif Display',serif; font-size:26px; line-height:1.45; text-align:center; margin-bottom:28px; max-width:520px; }
        .phrase-sub { font-size:13px; color:var(--text-muted); margin-top:-20px; margin-bottom:24px; font-style:italic; }
        .speak-btn { background:var(--accent-primary); color:white; border:none; padding:16px 44px; border-radius:50px; font-family:'DM Sans',sans-serif; font-size:17px; font-weight:700; cursor:pointer; transition:all 0.15s; box-shadow:0 4px 20px rgba(108,99,255,0.35); }
        .speak-btn:active { transform:scale(0.95); }
        .speak-btn.speaking { background:var(--accent-success); box-shadow:0 4px 20px rgba(78,205,196,0.35); }

        /* Card nav */
        .card-nav { display:flex; align-items:center; justify-content:center; gap:14px; padding:6px 20px 2px; }
        .card-arrow { background:var(--bg-elevated); border:1px solid var(--border-subtle); color:var(--text-secondary); width:44px; height:44px; border-radius:50%; font-size:20px; cursor:pointer; display:flex; align-items:center; justify-content:center; transition:all 0.15s; flex-shrink:0; }
        .card-arrow:active { transform:scale(0.9); background:var(--accent-primary); color:white; }
        .card-arrow:disabled { opacity:0.2; pointer-events:none; }
        .card-dots { display:flex; gap:5px; align-items:center; overflow:hidden; max-width:180px; }
        .dot { width:7px; height:7px; border-radius:50%; background:var(--text-muted); opacity:0.35; transition:all 0.3s; flex-shrink:0; }
        .dot.active { background:var(--accent-primary); opacity:1; width:20px; border-radius:4px; }
        .card-counter { text-align:center; font-size:12px; color:var(--text-muted); padding:2px 0 8px; font-weight:500; }

        /* Category bar */
        .category-bar { display:flex; gap:7px; padding:10px 14px; overflow-x:auto; -webkit-overflow-scrolling:touch; border-top:1px solid var(--border-subtle); background:var(--bg-card); flex-shrink:0; scrollbar-width:none; }
        .category-bar::-webkit-scrollbar { display:none; }
        .cat-btn { background:var(--bg-elevated); border:1px solid var(--border-subtle); color:var(--text-secondary); padding:8px 16px; border-radius:25px; font-family:'DM Sans',sans-serif; font-size:13px; font-weight:600; cursor:pointer; white-space:nowrap; transition:all 0.2s; flex-shrink:0; }
        .cat-btn.active { background:var(--accent-primary); color:white; border-color:var(--accent-primary); }
        .cat-btn:active { transform:scale(0.95); }

        /* Bottom nav */
        .bottom-nav { display:flex; border-top:1px solid var(--border-subtle); background:var(--bg-card); padding-bottom:var(--safe-bottom); flex-shrink:0; }
        .nav-btn { flex:1; padding:12px 6px 8px; background:transparent; border:none; color:var(--text-muted); font-family:'DM Sans',sans-serif; font-size:11px; font-weight:600; cursor:pointer; display:flex; flex-direction:column; align-items:center; gap:3px; }
        .nav-btn .nav-icon { font-size:20px; }
        .nav-btn.active { color:var(--accent-primary); }
        .nav-btn:active { color:var(--accent-glow); }

        /* Settings */
        .settings-scroll { flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch; padding:24px 20px calc(var(--safe-bottom) + 80px); }

        /* Version & copyright footer */
        .app-version-footer { text-align:center; padding:30px 20px 10px; margin-top:20px; border-top:1px solid var(--border-subtle); }
        .app-version-footer .version-name { font-family:'DM Serif Display',serif; font-size:20px; color:var(--text-primary); margin-bottom:4px; }
        .app-version-footer .version-number { font-family:'DM Sans',sans-serif; font-size:13px; font-weight:600; color:var(--accent-primary); margin-bottom:4px; }
        .app-version-footer .version-copyright { font-size:11px; color:var(--text-muted); margin-bottom:10px; }
        .app-version-footer .version-changelog { font-size:12px; color:var(--accent-glow); cursor:pointer; font-weight:600; margin-bottom:6px; }
        .app-version-footer .version-changelog:active { opacity:0.6; }
        .version-changelog-content { display:none; text-align:left; font-size:11px; color:var(--text-secondary); line-height:1.6; padding:10px; background:var(--bg-deep); border-radius:var(--radius-md); margin-top:6px; }
        .version-changelog-content.visible { display:block; }
        .version-changelog-content .vlog-entry { margin-bottom:10px; }
        .version-changelog-content .vlog-ver { font-weight:700; color:var(--accent-primary); }
        .version-changelog-content .vlog-date { color:var(--text-muted); margin-left:6px; }
        .settings-section { margin-bottom:24px; }
        .settings-section-title { font-family:'DM Serif Display',serif; font-size:20px; margin-bottom:4px; }
        .settings-section-desc { font-size:13px; color:var(--text-muted); margin-bottom:14px; }
        .voice-group-label { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:1.2px; color:var(--text-muted); margin:16px 0 8px; }
        .voice-option { display:flex; align-items:center; gap:12px; background:var(--bg-card); border:2px solid var(--border-subtle); border-radius:var(--radius-md); padding:12px 14px; margin-bottom:7px; cursor:pointer; transition:all 0.15s; }
        .voice-option:active { transform:scale(0.98); }
        .voice-option.selected { border-color:var(--accent-primary); background:rgba(108,99,255,0.08); }
        .voice-radio { width:20px; height:20px; border-radius:50%; border:2px solid var(--text-muted); flex-shrink:0; display:flex; align-items:center; justify-content:center; }
        .voice-option.selected .voice-radio { border-color:var(--accent-primary); }
        .voice-radio-dot { width:10px; height:10px; border-radius:50%; background:var(--accent-primary); opacity:0; }
        .voice-option.selected .voice-radio-dot { opacity:1; }
        .voice-info { flex:1; min-width:0; }
        .voice-name { font-size:15px; font-weight:600; }
        .voice-detail { font-size:11px; color:var(--text-secondary); margin-top:1px; }
        .voice-preview-btn { background:var(--bg-elevated); border:1px solid var(--border-subtle); color:var(--text-secondary); width:38px; height:38px; border-radius:50%; font-size:16px; cursor:pointer; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
        .voice-preview-btn:active { background:var(--accent-primary); color:white; transform:scale(0.9); }
        .speed-control { display:flex; align-items:center; gap:12px; background:var(--bg-card); border:1px solid var(--border-subtle); border-radius:var(--radius-md); padding:14px; }
        .speed-label { font-size:13px; color:var(--text-secondary); font-weight:600; min-width:40px; }
        .speed-slider { flex:1; -webkit-appearance:none; height:6px; border-radius:3px; background:var(--bg-elevated); outline:none; }
        .speed-slider::-webkit-slider-thumb { -webkit-appearance:none; width:24px; height:24px; border-radius:50%; background:var(--accent-primary); cursor:pointer; }
        .speed-value { font-size:13px; color:var(--accent-glow); font-weight:700; min-width:36px; text-align:right; }
        .settings-bottom-nav { position:fixed; bottom:0; left:0; right:0; border-top:1px solid var(--border-subtle); background:var(--bg-card); padding-bottom:var(--safe-bottom); z-index:50; }
        .settings-home-btn { width:100%; padding:14px; background:transparent; border:none; color:var(--accent-glow); font-family:'DM Sans',sans-serif; font-size:15px; font-weight:700; cursor:pointer; display:flex; align-items:center; justify-content:center; gap:8px; }

        /* Stats bar */
        .stats-bar { display:flex; gap:12px; padding:10px 14px; background:var(--bg-card); border-bottom:1px solid var(--border-subtle); flex-shrink:0; overflow-x:auto; scrollbar-width:none; }
        .stats-bar::-webkit-scrollbar { display:none; }
        .stat-chip { background:var(--bg-elevated); border:1px solid var(--border-subtle); border-radius:20px; padding:5px 12px; font-size:11px; font-weight:600; color:var(--text-secondary); white-space:nowrap; flex-shrink:0; }
        .stat-chip .stat-val { color:var(--accent-gold); }

        /* Modal */
        .modal-overlay { display:none; position:fixed; inset:0; background:rgba(0,0,0,0.7); backdrop-filter:blur(8px); -webkit-backdrop-filter:blur(8px); z-index:500; align-items:flex-end; justify-content:center; }
        .modal-overlay.open { display:flex; }
        .modal-sheet { background:var(--bg-card); width:100%; max-width:600px; border-radius:var(--radius-xl) var(--radius-xl) 0 0; padding:24px 20px calc(var(--safe-bottom) + 20px); animation:slideUp 0.3s ease; }
        @keyframes slideUp { from{transform:translateY(100%)} to{transform:translateY(0)} }
        .modal-handle { width:40px; height:4px; background:var(--text-muted); border-radius:2px; margin:0 auto 20px; opacity:0.5; }
        .modal-title { font-family:'DM Serif Display',serif; font-size:22px; margin-bottom:6px; }
        .modal-desc { color:var(--text-secondary); font-size:14px; margin-bottom:16px; }
        .modal-input { width:100%; background:var(--bg-deep); border:2px solid var(--border-subtle); color:var(--text-primary); font-family:'DM Sans',sans-serif; font-size:18px; padding:14px; border-radius:var(--radius-md); outline:none; resize:none; min-height:70px; }
        .modal-input:focus { border-color:var(--accent-primary); }
        .modal-input::placeholder { color:var(--text-muted); }
        .modal-category-select { display:flex; gap:7px; flex-wrap:wrap; margin:14px 0 18px; }
        .modal-cat-opt { background:var(--bg-elevated); border:1px solid var(--border-subtle); color:var(--text-secondary); padding:7px 12px; border-radius:20px; font-family:'DM Sans',sans-serif; font-size:12px; font-weight:600; cursor:pointer; }
        .modal-cat-opt.selected { background:var(--accent-primary); color:white; border-color:var(--accent-primary); }
        .modal-actions { display:flex; gap:12px; }
        .modal-btn { flex:1; padding:14px; border-radius:var(--radius-md); font-family:'DM Sans',sans-serif; font-size:15px; font-weight:700; cursor:pointer; border:none; }
        .modal-btn.cancel { background:var(--bg-elevated); color:var(--text-secondary); border:1px solid var(--border-subtle); }
        .modal-btn.save { background:var(--accent-primary); color:white; }
        .modal-btn.delete { background:rgba(255,107,107,0.12); color:#ff6b6b; border:1.5px solid rgba(255,107,107,0.3); }
        .modal-btn.delete:active { background:rgba(255,107,107,0.25); }
        .modal-btn:active { transform:scale(0.97); }

        /* Custom bubble indicator — small dot */
        .bubble.custom-phrase::before { content:'✎'; position:absolute; top:-2px; right:4px; font-size:9px; opacity:0.5; width:auto; height:auto; border-radius:0; background:none; }
        /* Long press hint ring */
        .bubble.hold-active { box-shadow:0 0 0 3px rgba(108,99,255,0.3), 0 4px 12px rgba(0,0,0,0.15), inset 0 1px 1px rgba(255,255,255,0.15); }

        /* Toast */
        .toast { position:fixed; top:calc(var(--safe-top) + 60px); left:50%; transform:translateX(-50%) translateY(-20px); background:var(--bg-elevated); color:var(--text-primary); padding:10px 22px; border-radius:var(--radius-md); font-size:14px; font-weight:600; opacity:0; transition:all 0.3s; pointer-events:none; z-index:1000; border:1px solid var(--border-active); box-shadow:var(--shadow-card); }
        .toast.show { opacity:1; transform:translateX(-50%) translateY(0); }
        .toast.success { border-color:rgba(78,205,196,0.4); }

        /* Install banner */
        .install-banner { display:none; background:var(--bg-elevated); border:1px solid var(--border-active); border-radius:var(--radius-md); padding:12px 14px; margin-bottom:16px; align-items:center; gap:10px; }
        .install-banner.visible { display:flex; }
        .install-banner-text { flex:1; font-size:12px; color:var(--text-secondary); line-height:1.4; }
        .install-banner-text strong { color:var(--text-primary); }
        .install-dismiss { background:none; border:none; color:var(--text-muted); font-size:18px; cursor:pointer; padding:4px; }

        .swipe-hint { text-align:center; color:var(--text-muted); font-size:12px; padding:3px; opacity:0.6; }

        /* ===== LISTENING BAR ===== */
        .listen-bar { display:flex; align-items:center; gap:10px; padding:10px 14px; background:var(--bg-card); border-bottom:1px solid var(--border-subtle); flex-shrink:0; }
        .listen-toggle { display:flex; align-items:center; gap:8px; background:var(--bg-elevated); border:1.5px solid var(--border-subtle); border-radius:25px; padding:10px 18px 10px 14px; cursor:pointer; transition:all 0.2s; font-family:'DM Sans',sans-serif; font-size:15px; font-weight:600; color:var(--text-secondary); flex-shrink:0; min-height:44px; }
        .listen-toggle:active { transform:scale(0.96); }
        .listen-toggle.active { background:rgba(255,107,107,0.12); border-color:rgba(255,107,107,0.3); color:var(--accent-warm); }
        .listen-pulse { width:10px; height:10px; border-radius:50%; background:var(--text-muted); flex-shrink:0; transition:all 0.3s; }
        .listen-toggle.active .listen-pulse { background:var(--accent-warm); animation:pulse 1.5s infinite; }
        @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.5;transform:scale(1.3)} }
        .listen-topic { flex:1; min-width:0; overflow:hidden; }
        .listen-topic-text { font-size:14px; color:var(--text-muted); white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .listen-topic-text.has-topic { color:var(--accent-glow); }
        .listen-transcript-toggle { background:none; border:none; color:var(--text-muted); font-size:22px; cursor:pointer; padding:8px; flex-shrink:0; min-width:44px; min-height:44px; display:flex; align-items:center; justify-content:center; }

        /* Transcript panel */
        .transcript-panel { display:none; max-height:0; overflow:hidden; background:var(--bg-surface); border-bottom:1px solid var(--border-subtle); padding:0 14px; transition:max-height 0.3s ease, padding 0.3s ease; }
        .transcript-panel.open { display:block; max-height:120px; padding:10px 14px; overflow-y:auto; }
        .transcript-text { font-size:12px; color:var(--text-secondary); line-height:1.5; font-family:monospace; }
        .transcript-text .keyword { color:var(--accent-gold); font-weight:700; }

        /* Suggested cards strip */
        .suggested-strip { display:none; padding:10px 14px 12px; background:rgba(108,99,255,0.04); border-bottom:1px solid var(--border-subtle); flex-shrink:0; }
        .suggested-strip.visible { display:block; }
        .suggested-label { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:var(--accent-glow); margin-bottom:8px; }
        /* Suggestion strip — horizontal scrollable, tap-to-speak (NOT drag) */
        .suggested-strip .bubble-field { touch-action:pan-x; }
        .suggested-strip .bubble { touch-action:pan-x; cursor:pointer; }
        .suggested-wrap { position:relative; display:inline-flex; flex-direction:column; align-items:center; flex-shrink:0; gap:4px; }
        .suggested-wrap .fb-row { display:flex; gap:4px; }
        .suggested-wrap .fb-btn { width:28px; height:28px; border-radius:50%; border:1.5px solid var(--border-subtle); background:var(--bg-card); font-size:13px; display:flex; align-items:center; justify-content:center; cursor:pointer; transition:all 0.12s; }
        .suggested-wrap .fb-btn:active { transform:scale(0.85); }
        .suggested-wrap .fb-btn.fb-up:active { border-color:rgba(78,205,196,0.5); background:rgba(78,205,196,0.15); }
        .suggested-wrap .fb-btn.fb-down:active { border-color:rgba(255,107,107,0.5); background:rgba(255,107,107,0.15); }
        .suggested-wrap .fb-done { font-size:11px; color:var(--text-muted); font-weight:600; }

        /* ===== BUBBLE SYSTEM ===== */
        @keyframes bubbleInflate { 0% { transform:scale(0); opacity:0; } 50% { transform:scale(1.12); } 70% { transform:scale(0.96); } 100% { transform:scale(1); opacity:1; } }
        @keyframes bubblePop { 0% { transform:scale(1); opacity:1; } 20% { transform:scale(1.3); opacity:0.8; } 100% { transform:scale(0); opacity:0; } }
        @keyframes particleBurst { 0% { transform:scale(0.8); opacity:1; } 100% { transform:scale(3); opacity:0; } }
        @keyframes popGhost { 0% { opacity:0.8; transform:translateY(0) scale(1); } 100% { opacity:0; transform:translateY(-40px) scale(0.8); } }
        @keyframes shimmer { 0% { background-position:200% center; } 100% { background-position:-200% center; } }
        @keyframes comboFlash { 0%,100% { opacity:1; } 50% { opacity:0.5; transform:scale(1.05); } }
        @keyframes milestoneGlow { 0% { box-shadow:0 0 0 0 rgba(255,217,61,0.4); } 50% { box-shadow:0 0 20px 8px rgba(255,217,61,0.15); } 100% { box-shadow:0 0 0 0 rgba(255,217,61,0); } }
        @keyframes speakZonePulse { 0%,100% { box-shadow:inset 0 0 15px rgba(78,205,196,0.1), 0 0 0 0 rgba(78,205,196,0); } 50% { box-shadow:inset 0 0 20px rgba(78,205,196,0.2), 0 0 12px 4px rgba(78,205,196,0.08); } }
        @keyframes speakZoneReady { 0%,100% { box-shadow:inset 0 0 25px rgba(78,205,196,0.3), 0 0 20px 6px rgba(78,205,196,0.15); border-color:rgba(78,205,196,0.6); } 50% { box-shadow:inset 0 0 30px rgba(78,205,196,0.4), 0 0 25px 8px rgba(78,205,196,0.2); border-color:rgba(78,205,196,0.8); } }
        @keyframes fitSnap { 0% { transform:scale(1); } 40% { transform:scale(1.15); } 100% { transform:scale(0); opacity:0; } }

        .bubble-field { display:flex; flex-wrap:wrap; gap:10px; padding:12px 14px; align-items:center; justify-content:center; min-height:60px; overflow:visible; position:relative; }
        .bubble-field.scroll-horizontal { flex-wrap:nowrap; overflow-x:auto; justify-content:flex-start; scrollbar-width:none; -webkit-overflow-scrolling:touch; padding-bottom:6px; }
        .bubble-field.scroll-horizontal::-webkit-scrollbar { display:none; }

        /* === THE BUBBLE — glossy, translucent, STATIONARY, draggable === */
        .bubble {
            position:relative; display:inline-flex; align-items:center; justify-content:center; text-align:center;
            padding:14px 20px; border-radius:50px;
            font-family:'DM Sans',sans-serif; font-size:14px; font-weight:600;
            color:var(--text-primary); cursor:pointer; user-select:none; -webkit-user-select:none;
            /* Glassy translucent look */
            background:radial-gradient(ellipse at 30% 20%, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.03) 50%, transparent 70%);
            border:1.5px solid rgba(255,255,255,0.12);
            backdrop-filter:blur(4px); -webkit-backdrop-filter:blur(4px);
            box-shadow:
                0 4px 12px rgba(0,0,0,0.15),
                inset 0 1px 1px rgba(255,255,255,0.15),
                0 1px 3px rgba(0,0,0,0.1);
            /* Entry animation — stationary after inflate */
            animation:bubbleInflate 0.4s cubic-bezier(0.34,1.56,0.64,1) both;
            transition:transform 0.15s, box-shadow 0.15s, opacity 0.15s;
            white-space:nowrap; flex-shrink:0; overflow:hidden;
        }
        /* Glossy highlight */
        .bubble::before {
            content:''; position:absolute; top:3px; left:15%; width:40%; height:35%;
            border-radius:50%;
            background:linear-gradient(180deg, rgba(255,255,255,0.25) 0%, rgba(255,255,255,0.05) 60%, transparent 100%);
            pointer-events:none;
        }
        /* Subtle shimmer */
        .bubble::after {
            content:''; position:absolute; inset:0; border-radius:50px;
            background:linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.08) 45%, rgba(255,255,255,0.12) 50%, rgba(255,255,255,0.08) 55%, transparent 100%);
            background-size:200% 100%;
            animation:shimmer 6s ease-in-out infinite;
            pointer-events:none;
        }

        /* States */
        .bubble.dragging { cursor:grabbing; transform:scale(1.08); box-shadow:0 8px 25px rgba(0,0,0,0.25), inset 0 1px 2px rgba(255,255,255,0.2); z-index:100; opacity:0.9; transition:none; }
        .bubble.nearby { transform:scale(1.1); box-shadow:0 6px 20px rgba(0,0,0,0.2), inset 0 1px 2px rgba(255,255,255,0.2), 0 0 12px rgba(108,99,255,0.15); }
        .bubble.dimmed { opacity:0.5; transform:scale(0.95); }
        .bubble.popping { animation:bubblePop 0.35s ease-out forwards !important; pointer-events:none; }
        .bubble.fitting { animation:fitSnap 0.4s ease-out forwards !important; pointer-events:none; }

        /* Stagger entry */
        .bubble:nth-child(1) { animation-delay:0s; }
        .bubble:nth-child(2) { animation-delay:0.05s; }
        .bubble:nth-child(3) { animation-delay:0.1s; }
        .bubble:nth-child(4) { animation-delay:0.15s; }
        .bubble:nth-child(5) { animation-delay:0.2s; }
        .bubble:nth-child(6) { animation-delay:0.25s; }
        .bubble:nth-child(7) { animation-delay:0.3s; }
        .bubble:nth-child(8) { animation-delay:0.35s; }

        /* Size by confidence */
        .bubble.confidence-high { padding:16px 24px; font-size:16px; }
        .bubble.confidence-med { padding:13px 18px; font-size:14px; }
        .bubble.confidence-low { padding:10px 14px; font-size:13px; opacity:0.85; }

        /* Colour tints — radial gradient under the glass */
        .bubble.theme-suggestion { background:radial-gradient(ellipse at 30% 20%, rgba(255,255,255,0.15), rgba(108,99,255,0.12) 60%, rgba(108,99,255,0.06)); border-color:rgba(108,99,255,0.25); }
        .bubble.theme-match { background:radial-gradient(ellipse at 30% 20%, rgba(255,255,255,0.15), rgba(78,205,196,0.15) 60%, rgba(78,205,196,0.06)); border-color:rgba(78,205,196,0.3); }
        .bubble.theme-memory { background:radial-gradient(ellipse at 30% 20%, rgba(255,255,255,0.15), rgba(255,217,61,0.12) 60%, rgba(255,217,61,0.05)); border-color:rgba(255,217,61,0.3); }
        .bubble.theme-context { background:radial-gradient(ellipse at 30% 20%, rgba(255,255,255,0.15), rgba(139,92,246,0.12) 60%, rgba(139,92,246,0.06)); border-color:rgba(139,92,246,0.3); }
        .bubble.theme-learned { background:radial-gradient(ellipse at 30% 20%, rgba(255,255,255,0.15), rgba(255,159,67,0.12) 60%, rgba(255,159,67,0.05)); border-color:rgba(255,159,67,0.3); }
        .bubble.theme-sos-needs { background:radial-gradient(ellipse at 30% 20%, rgba(255,255,255,0.15), rgba(78,205,196,0.15) 60%, rgba(78,205,196,0.06)); border-color:rgba(78,205,196,0.3); }
        .bubble.theme-sos-overwhelm { background:radial-gradient(ellipse at 30% 20%, rgba(255,255,255,0.15), rgba(255,71,87,0.15) 60%, rgba(255,71,87,0.06)); border-color:rgba(255,71,87,0.3); }
        .bubble.theme-sos-sound { background:radial-gradient(ellipse at 30% 20%, rgba(255,255,255,0.15), rgba(255,107,107,0.12) 60%, rgba(255,107,107,0.06)); border-color:rgba(255,107,107,0.3); }
        .bubble.theme-sos-smell { background:radial-gradient(ellipse at 30% 20%, rgba(255,255,255,0.15), rgba(255,159,67,0.12) 60%, rgba(255,159,67,0.05)); border-color:rgba(255,159,67,0.3); }
        .bubble.theme-sos-light { background:radial-gradient(ellipse at 30% 20%, rgba(255,255,255,0.15), rgba(255,217,61,0.12) 60%, rgba(255,217,61,0.05)); border-color:rgba(255,217,61,0.3); }
        .bubble.theme-sos-touch { background:radial-gradient(ellipse at 30% 20%, rgba(255,255,255,0.15), rgba(238,90,36,0.12) 60%, rgba(238,90,36,0.05)); border-color:rgba(238,90,36,0.3); }
        .bubble.theme-sos-explain { background:radial-gradient(ellipse at 30% 20%, rgba(255,255,255,0.15), rgba(162,155,254,0.12) 60%, rgba(162,155,254,0.06)); border-color:rgba(162,155,254,0.3); }
        .bubble.theme-starter { background:radial-gradient(ellipse at 30% 20%, rgba(255,255,255,0.15), rgba(108,99,255,0.1) 60%, rgba(108,99,255,0.04)); border-color:rgba(108,99,255,0.2); }
        .bubble.theme-card { background:radial-gradient(ellipse at 30% 20%, rgba(255,255,255,0.12), rgba(108,99,255,0.06) 60%, rgba(30,28,50,0.3)); border-color:rgba(255,255,255,0.1); }

        /* Levelled — used 10+ times, golden ring */
        .bubble.levelled { border-color:rgba(255,217,61,0.5); box-shadow:0 4px 12px rgba(0,0,0,0.15), inset 0 1px 1px rgba(255,255,255,0.15), 0 0 8px rgba(255,217,61,0.1); }
        .bubble.levelled::after { background:linear-gradient(90deg, transparent 0%, rgba(255,217,61,0.1) 45%, rgba(255,217,61,0.15) 50%, rgba(255,217,61,0.1) 55%, transparent 100%); background-size:200% 100%; animation:shimmer 4s ease-in-out infinite; }

        /* === SPEAK ZONE — drag target at bottom === */
        .speak-zone { 
            display:flex; align-items:center; justify-content:center; gap:8px;
            margin:8px 14px 0; padding:16px; border-radius:20px;
            border:2px dashed rgba(78,205,196,0.3);
            background:radial-gradient(ellipse at 50% 50%, rgba(78,205,196,0.04) 0%, transparent 70%);
            color:rgba(78,205,196,0.5); font-size:14px; font-weight:600;
            min-height:56px; transition:all 0.2s;
            animation:speakZonePulse 3s ease-in-out infinite;
        }
        .speak-zone.drag-hover {
            border-color:rgba(78,205,196,0.6); border-style:solid;
            background:radial-gradient(ellipse at 50% 50%, rgba(78,205,196,0.12) 0%, rgba(78,205,196,0.03) 70%);
            color:rgba(78,205,196,0.9);
            animation:speakZoneReady 1s ease-in-out infinite;
            transform:scale(1.02);
        }
        .speak-zone .zone-icon { font-size:22px; }

        /* === SENTENCE BUILDER — chain phrases by dragging right === */
        .sentence-builder { display:none; padding:8px 14px; background:rgba(108,99,255,0.04); border-bottom:1px solid var(--border-subtle); }
        .sentence-builder.visible { display:block; }
        .sentence-builder-label { font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:var(--accent-glow); margin-bottom:6px; }
        .sentence-builder-phrases { display:flex; flex-wrap:wrap; gap:6px; min-height:32px; }
        .sentence-phrase { background:rgba(108,99,255,0.1); border:1px solid rgba(108,99,255,0.2); border-radius:14px; padding:6px 12px; font-size:12px; color:var(--text-primary); font-weight:600; cursor:pointer; }
        .sentence-phrase:active { opacity:0.5; }
        .sentence-actions { display:flex; gap:8px; margin-top:8px; }
        .sentence-action-btn { background:rgba(78,205,196,0.1); border:1px solid rgba(78,205,196,0.3); border-radius:14px; padding:8px 16px; font-size:12px; font-weight:700; color:#4ecdc4; cursor:pointer; }
        .sentence-action-btn.clear { background:rgba(255,107,107,0.08); border-color:rgba(255,107,107,0.2); color:#ff6b6b; }

        /* Pop ghost */
        .pop-ghost { position:fixed; pointer-events:none; font-size:13px; color:var(--accent-glow); font-weight:600; animation:popGhost 1.2s ease-out forwards; z-index:999; white-space:nowrap; text-shadow:0 0 8px rgba(108,99,255,0.3); }

        /* Contextual suggestions injected into bubble field */
        .contextual-section { width:100%; }
        .contextual-label { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:1px; color:var(--accent-primary); padding:4px 6px 8px; }
        .contextual-bubbles { background:rgba(108,99,255,0.04); border-radius:16px; padding:10px !important; margin-bottom:4px; }
        .contextual-divider { height:1px; background:linear-gradient(90deg, transparent, var(--border-subtle), transparent); margin:8px 0; }
        /* Particle ring burst */
        .pop-particles { position:absolute; inset:-10px; border-radius:50%; border:2px solid rgba(255,255,255,0.3); animation:particleBurst 0.5s ease-out forwards; pointer-events:none; }

        /* === GAMIFICATION === */
        .bubble-counter { position:fixed; top:70px; right:16px; background:rgba(30,28,50,0.85); backdrop-filter:blur(8px); border:1px solid rgba(108,99,255,0.2); border-radius:20px; padding:6px 14px; font-size:12px; font-weight:700; color:var(--accent-glow); z-index:100; display:none; transition:all 0.3s; }
        .bubble-counter.visible { display:flex; align-items:center; gap:6px; }
        .bubble-counter .counter-num { font-size:16px; color:var(--accent-gold); }
        .combo-badge { position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); font-size:28px; font-weight:800; color:var(--accent-gold); text-shadow:0 0 20px rgba(255,217,61,0.4); pointer-events:none; z-index:1000; animation:popGhost 1.5s ease-out forwards; }
        .milestone-toast { position:fixed; bottom:120px; left:50%; transform:translateX(-50%); background:linear-gradient(135deg, rgba(255,217,61,0.15), rgba(108,99,255,0.1)); border:1px solid rgba(255,217,61,0.3); backdrop-filter:blur(10px); border-radius:20px; padding:10px 24px; font-size:14px; font-weight:700; color:var(--accent-gold); z-index:1000; animation:milestoneGlow 2s ease-out, popGhost 3s ease-out 1s forwards; pointer-events:none; white-space:nowrap; }

        /* ===== YES/NO BAR — persistent on all screens ===== */
        .yesno-bar { display:flex; gap:10px; padding:8px 14px; background:var(--bg-card); border-bottom:1px solid var(--border-subtle); flex-shrink:0; z-index:90; }
        .yesno-btn { flex:1; padding:14px 8px; border-radius:var(--radius-md); font-family:'DM Sans',sans-serif; font-size:18px; font-weight:800; cursor:pointer; border:2px solid transparent; text-align:center; transition:all 0.12s; letter-spacing:0.5px; }
        .yesno-btn:active { transform:scale(0.94); }
        .yesno-yes { background:rgba(78,205,196,0.12); color:#4ecdc4; border-color:rgba(78,205,196,0.3); }
        .yesno-yes:active { background:rgba(78,205,196,0.3); }
        .yesno-no { background:rgba(255,107,107,0.12); color:#ff6b6b; border-color:rgba(255,107,107,0.3); }
        .yesno-no:active { background:rgba(255,107,107,0.3); }
        .yesno-maybe { background:rgba(255,217,61,0.10); color:#ffd93d; border-color:rgba(255,217,61,0.25); }
        .yesno-maybe:active { background:rgba(255,217,61,0.25); }
        .yesno-wait { background:rgba(108,99,255,0.10); color:var(--accent-glow); border-color:rgba(108,99,255,0.25); }
        .yesno-wait:active { background:rgba(108,99,255,0.25); }

        /* ===== SOS DASHBOARD ===== */
        .sos-scroll { flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch; padding:12px 14px calc(var(--safe-bottom) + 70px); }
        .sos-group { margin-bottom:18px; }
        .sos-group-label { font-size:11px; font-weight:700; text-transform:uppercase; letter-spacing:1.2px; margin-bottom:8px; padding-left:4px; }
        .sos-group-label.sound { color:#ff6b6b; }
        .sos-group-label.smell { color:#ff9f43; }
        .sos-group-label.light { color:#ffd93d; }
        .sos-group-label.touch { color:#ee5a24; }
        .sos-group-label.overwhelm { color:#ff4757; }
        .sos-group-label.needs { color:#4ecdc4; }
        .sos-group-label.explain { color:#a29bfe; }
        .sos-grid { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
        .sos-btn { background:var(--bg-card); border:1.5px solid var(--border-subtle); border-radius:var(--radius-md); padding:14px 12px; font-family:'DM Sans',sans-serif; font-size:14px; font-weight:600; color:var(--text-primary); cursor:pointer; text-align:left; line-height:1.35; transition:all 0.12s; display:flex; align-items:center; gap:8px; }
        .sos-btn:active { transform:scale(0.96); background:var(--bg-elevated); }
        .sos-btn .sos-icon { font-size:20px; flex-shrink:0; }
        .sos-btn.speaking-active { border-color:var(--accent-success); background:rgba(78,205,196,0.08); }
        .sos-btn.full-width { grid-column:1/-1; }
        /* Color-coded borders per group */
        .sos-group.sound .sos-btn { border-color:rgba(255,107,107,0.2); }
        .sos-group.sound .sos-btn:active { border-color:rgba(255,107,107,0.5); background:rgba(255,107,107,0.06); }
        .sos-group.smell .sos-btn { border-color:rgba(255,159,67,0.2); }
        .sos-group.smell .sos-btn:active { border-color:rgba(255,159,67,0.5); background:rgba(255,159,67,0.06); }
        .sos-group.light .sos-btn { border-color:rgba(255,217,61,0.2); }
        .sos-group.overwhelm .sos-btn { border-color:rgba(255,71,87,0.25); }
        .sos-group.overwhelm .sos-btn:active { border-color:rgba(255,71,87,0.5); background:rgba(255,71,87,0.06); }
        .sos-group.needs .sos-btn { border-color:rgba(78,205,196,0.2); }
        .sos-group.needs .sos-btn:active { border-color:rgba(78,205,196,0.5); background:rgba(78,205,196,0.06); }
        .sos-group.explain .sos-btn { border-color:rgba(162,155,254,0.2); }

        /* ===== TOPIC LAUNCHER ===== */
        .topic-launch-scroll { flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch; padding:16px 14px calc(var(--safe-bottom) + 70px); }
        .topic-launch-header { font-family:'DM Serif Display',serif; font-size:22px; text-align:center; margin-bottom:4px; color:var(--text-primary); }
        .topic-launch-sub { font-size:13px; color:var(--text-secondary); text-align:center; margin-bottom:18px; }
        .topic-grid { display:grid; grid-template-columns:repeat(4, 1fr); gap:10px; margin-bottom:18px; }
        .topic-tile { background:var(--bg-card); border:1.5px solid var(--border-subtle); border-radius:var(--radius-md); padding:14px 8px; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; cursor:pointer; transition:all 0.15s; min-height:80px; }
        .topic-tile:active { transform:scale(0.94); }
        .topic-tile.active { border-color:var(--accent-primary); background:rgba(108,99,255,0.1); box-shadow:0 0 20px rgba(108,99,255,0.15); }
        .topic-tile .topic-icon { font-size:28px; margin-bottom:4px; }
        .topic-tile .topic-name { font-size:11px; font-weight:600; line-height:1.25; color:var(--text-secondary); }
        .topic-tile.active .topic-name { color:var(--accent-glow); }
        .topic-group-label { font-size:10px; font-weight:700; text-transform:uppercase; letter-spacing:1.2px; color:var(--text-muted); margin:14px 0 8px 4px; grid-column:1/-1; }
        .starter-panel { display:none; }
        .starter-panel.visible { display:block; }
        .starter-header { font-size:15px; font-weight:700; color:var(--accent-glow); margin-bottom:10px; padding:0 4px; }
        .starter-cards { display:grid; grid-template-columns:1fr; gap:8px; }
        .starter-btn { background:var(--bg-card); border:1.5px solid var(--border-subtle); border-radius:var(--radius-md); padding:16px 18px; font-family:'DM Sans',sans-serif; font-size:16px; font-weight:600; color:var(--text-primary); cursor:pointer; text-align:left; line-height:1.4; transition:all 0.12s; display:flex; align-items:center; gap:10px; }
        .starter-btn:active { transform:scale(0.97); background:var(--accent-primary); color:white; border-color:var(--accent-primary); }
        .starter-btn .starter-icon { font-size:20px; flex-shrink:0; }
        .starter-btn .starter-hint { font-size:11px; color:var(--text-muted); margin-left:auto; flex-shrink:0; }

        /* ===== HERO TILES (full-width, centered) ===== */
        .sos-hero, .talk-hero, .convo-hero { display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:18px 22px; border-radius:var(--radius-lg); margin-bottom:10px; cursor:pointer; transition:transform 0.12s; min-height:76px; }
        .sos-hero:active, .talk-hero:active, .convo-hero:active { transform:scale(0.97); }
        .hero-icon { font-size:28px; margin-bottom:4px; }
        .hero-label { font-family:'DM Serif Display',serif; font-size:18px; font-weight:700; }
        .hero-sub { font-size:11px; margin-top:2px; }

        .sos-hero { background:linear-gradient(135deg,rgba(255,107,107,0.08),rgba(255,160,60,0.06)); border:1.5px solid rgba(255,107,107,0.4); }
        .sos-hero:active { border-color:var(--accent-warm); background:rgba(255,107,107,0.12); }
        .sos-hero .hero-label { color:var(--accent-warm); }
        .sos-hero .hero-sub { color:rgba(255,107,107,0.6); }

        .talk-hero { background:linear-gradient(135deg,rgba(108,99,255,0.08),rgba(139,92,246,0.06)); border:1.5px solid rgba(108,99,255,0.3); }
        .talk-hero:active { border-color:var(--accent-primary); background:rgba(108,99,255,0.12); }
        .talk-hero .hero-label { color:var(--accent-primary); }
        .talk-hero .hero-sub { color:rgba(108,99,255,0.5); }

        .convo-hero { background:linear-gradient(135deg,rgba(72,187,120,0.08),rgba(56,178,172,0.06)); border:1.5px solid rgba(72,187,120,0.3); }
        .convo-hero:active { border-color:#48bb78; background:rgba(72,187,120,0.12); }
        .convo-hero .hero-label { color:#48bb78; }
        .convo-hero .hero-sub { color:rgba(72,187,120,0.5); }

        /* ===== FEEDBACK BUTTONS ===== */
        .suggested-card-wrap { display:flex; align-items:stretch; gap:4px; flex-shrink:0; }
        .suggested-card-wrap .suggested-card { flex:1; }
        .feedback-btns { display:flex; flex-direction:column; gap:2px; flex-shrink:0; }
        .fb-btn { width:28px; height:24px; border:1px solid var(--border-subtle); border-radius:6px; background:var(--bg-card); cursor:pointer; font-size:12px; display:flex; align-items:center; justify-content:center; transition:all 0.12s; padding:0; }
        .fb-btn:active { transform:scale(0.9); }
        .fb-btn.fb-up:active { background:rgba(78,205,196,0.2); border-color:var(--accent-success); }
        .fb-btn.fb-down:active { background:rgba(255,107,107,0.2); border-color:var(--accent-warm); }
        .match-source { display:block; font-size:9px; opacity:0.5; margin-top:2px; }

        /* ===== OT REPORT SCREEN ===== */
        .report-scroll { flex:1; overflow-y:auto; -webkit-overflow-scrolling:touch; padding:16px 14px calc(var(--safe-bottom) + 70px); }
        .report-header { font-family:'DM Serif Display',serif; font-size:20px; margin-bottom:4px; }
        .report-sub { font-size:13px; color:var(--text-secondary); margin-bottom:16px; }
        .report-section { background:var(--bg-card); border:1px solid var(--border-subtle); border-radius:var(--radius-md); padding:16px; margin-bottom:12px; }
        .report-section-title { font-size:14px; font-weight:700; color:var(--accent-glow); margin-bottom:8px; display:flex; align-items:center; gap:6px; }
        .report-stat { display:flex; justify-content:space-between; padding:6px 0; border-bottom:1px solid rgba(108,99,255,0.08); font-size:13px; }
        .report-stat:last-child { border-bottom:none; }
        .report-stat-label { color:var(--text-secondary); }
        .report-stat-value { font-weight:600; color:var(--text-primary); }
        .report-log-entry { padding:8px 0; border-bottom:1px solid rgba(108,99,255,0.08); font-size:12px; line-height:1.5; }
        .report-log-entry:last-child { border-bottom:none; }
        .report-log-time { color:var(--text-muted); font-size:11px; }
        .report-log-heard { color:var(--accent-gold); }
        .report-log-chosen { color:var(--accent-success); }
        .report-log-error { color:var(--accent-warm); }
        .report-actions { display:flex; gap:10px; margin-bottom:16px; flex-wrap:wrap; }
        .report-action-btn { background:var(--bg-card); border:1.5px solid var(--border-subtle); border-radius:var(--radius-md); padding:12px 18px; font-family:'DM Sans',sans-serif; font-size:13px; font-weight:600; color:var(--text-primary); cursor:pointer; transition:all 0.12s; flex:1; min-width:140px; text-align:center; }
        .report-action-btn:active { transform:scale(0.96); border-color:var(--accent-primary); }
        .report-action-btn.primary { background:var(--accent-primary); color:white; border-color:var(--accent-primary); }
        .report-period-btns { display:flex; gap:6px; margin-bottom:14px; }
        .report-period-btn { background:var(--bg-elevated); border:1px solid var(--border-subtle); border-radius:20px; padding:6px 14px; font-size:12px; font-weight:600; color:var(--text-secondary); cursor:pointer; }
        .report-period-btn.active { background:var(--accent-primary); color:white; border-color:var(--accent-primary); }
        .carer-note-input { background:var(--bg-elevated); border:1px solid var(--border-subtle); border-radius:var(--radius-sm); padding:10px; width:100%; font-family:'DM Sans',sans-serif; font-size:13px; color:var(--text-primary); resize:none; }
        .carer-note-btn { background:var(--accent-primary); color:white; border:none; border-radius:var(--radius-sm); padding:8px 16px; font-size:12px; font-weight:600; cursor:pointer; margin-top:6px; }

        @media(max-width:480px) {
            .phrase-text { font-size:22px; }
            .phrase-card { padding:28px 18px 24px; min-height:240px; }
            .speak-btn { font-size:15px; padding:14px 36px; }
            .context-tile { min-height:115px; padding:18px 12px; }
            .context-tile .tile-icon { font-size:30px; margin-bottom:8px; }
            .context-tile .tile-label { font-size:13px; }
        }
        @media(min-width:768px) {
            .phrase-text { font-size:32px; }
            .phrase-card { min-height:360px; padding:48px 36px 36px; }
        }
    </style>
</head>
<body>

<div class="header">
    <div class="header-left">
        <button class="back-btn" id="backBtn" onclick="app.goHome()">‹</button>
        <div class="header-title">Ryan's Voice</div>
    </div>
    <div class="context-badge" id="contextBadge">Home</div>
</div>

<!-- YES/NO BAR — always visible -->
<div class="yesno-bar" id="yesnoBar">
    <button class="yesno-btn yesno-yes" onclick="app.quickSpeak('Yes')">✓ Yes</button>
    <button class="yesno-btn yesno-no" onclick="app.quickSpeak('No')">✗ No</button>
    <button class="yesno-btn yesno-maybe" onclick="app.quickSpeak('Maybe')">~ Maybe</button>
    <button class="yesno-btn yesno-wait" onclick="app.quickSpeak('Wait, I\\'m thinking')">⏳ Wait</button>
</div>

<!-- HOME -->
<div class="screen active" id="homeScreen">
    <div class="home-scroll">
        <div class="home-greeting">What are you doing?</div>
        <div class="home-subtitle">Pick an activity to load your phrases</div>
        <div id="installBanner" class="install-banner">
            <div class="install-banner-text"><strong>Add to Home Screen</strong> for full-screen app. Tap Share → Add to Home Screen.</div>
            <button class="install-dismiss" onclick="dismissInstall()">✕</button>
        </div>
        <div id="contextGrid"></div>
    </div>
</div>

<!-- CARD SWIPE -->
<div class="screen" id="swipeScreen">
    <div class="stats-bar" id="statsBar"></div>
    <!-- Listening bar -->
    <div class="listen-bar" id="listenBar">
        <button class="listen-toggle" id="listenToggle" onclick="app.toggleListening()">
            <div class="listen-pulse"></div>
            <span id="listenLabel">Listen</span>
        </button>
        <div class="listen-topic">
            <div class="listen-topic-text" id="listenTopic">Tap Listen to hear the conversation</div>
        </div>
        <button class="listen-transcript-toggle" id="transcriptToggleBtn" onclick="app.toggleTranscript()">📝</button>
    </div>
    <!-- Transcript -->
    <div class="transcript-panel" id="transcriptPanel">
        <div class="transcript-text" id="transcriptText">Transcript will appear here...</div>
    </div>
    <!-- Suggested bubbles from listening -->
    <div class="suggested-strip" id="suggestedStrip">
        <div class="suggested-label" id="suggestedLabel">✨ Suggestions</div>
        <div class="bubble-field scroll-horizontal" id="suggestedCards"></div>
    </div>
    <div class="swipe-area">
        <!-- SENTENCE BUILDER — shows chained phrases -->
        <div class="sentence-builder" id="sentenceBuilder">
            <div class="sentence-builder-label">📝 Building sentence</div>
            <div class="sentence-builder-phrases" id="sentencePhrases"></div>
            <div class="sentence-actions">
                <button class="sentence-action-btn" onclick="app.speakSentence()">🔊 Speak All</button>
                <button class="sentence-action-btn clear" onclick="app.clearSentence()">✕ Clear</button>
            </div>
        </div>
        <!-- BUBBLE VIEW — default, shows all phrases as draggable bubbles -->
        <div class="bubble-browse" id="bubbleBrowse">
            <div class="bubble-field" id="cardBubbleField" style="align-content:flex-start; overflow-y:auto; max-height:45vh; padding:14px;"></div>
        </div>
        <!-- SPEAK ZONE — drag target -->
        <div class="speak-zone" id="speakZone">
            <span class="zone-icon">🔊</span>
            <span>Drag here to speak</span>
        </div>
        <!-- SWIPE VIEW — single card, hidden by default -->
        <div class="swipe-view" id="swipeView" style="display:none;">
            <div class="swipe-hint" id="swipeHint">← swipe or tap arrows →</div>
            <div class="card-viewport" id="cardViewport">
                <div class="phrase-card" id="phraseCard">
                    <div class="card-freq-badge" id="cardFreqBadge">⭐ Favourite</div>
                    <div class="card-category-tag" id="cardCatTag"></div>
                    <div class="phrase-text" id="phraseText">Loading...</div>
                    <div class="phrase-sub" id="phraseSub"></div>
                    <button class="speak-btn" id="speakBtn" onclick="app.speak()">TAP TO SPEAK</button>
                </div>
            </div>
            <div class="card-nav">
                <button class="card-arrow" id="prevArrow" onclick="app.prev()">‹</button>
                <div class="card-dots" id="cardDots"></div>
                <button class="card-arrow" id="nextArrow" onclick="app.next()">›</button>
            </div>
            <div class="card-counter" id="cardCounter"></div>
        </div>
    </div>
    <div class="category-bar" id="categoryBar"></div>
    <div class="bottom-nav">
        <button class="nav-btn" onclick="app.goHome()"><span class="nav-icon">🏠</span>Home</button>
        <button class="nav-btn" onclick="app.openTopicLauncher()"><span class="nav-icon">🗣️</span>Start</button>
        <button class="nav-btn" onclick="app.openAddPhrase()"><span class="nav-icon">＋</span>Add</button>
        <button class="nav-btn" onclick="showToast('Writing mode coming soon!')"><span class="nav-icon">✍️</span>Write</button>
    </div>
</div>

<!-- SOS DASHBOARD -->
<div class="screen" id="sosScreen">
    <div class="sos-scroll" id="sosContent"></div>
    <div class="bottom-nav">
        <button class="nav-btn" onclick="app.goHome()"><span class="nav-icon">🏠</span>Home</button>
        <button class="nav-btn" onclick="app.loadContext('sensory')"><span class="nav-icon">📋</span>Browse All</button>
    </div>
</div>

<!-- TOPIC LAUNCHER -->
<div class="screen" id="topicLaunchScreen">
    <div class="topic-launch-scroll">
        <div class="topic-launch-header">What do you want to talk about?</div>
        <div class="topic-launch-sub">Tap a topic → pick a starter → speak it</div>
        <div id="topicGrid" class="topic-grid"></div>
        <div id="starterPanel" class="starter-panel">
            <div class="starter-header" id="starterHeader"></div>
            <div class="starter-cards" id="starterCards"></div>
        </div>
    </div>
    <div class="bottom-nav">
        <button class="nav-btn" onclick="app.goHome()"><span class="nav-icon">🏠</span>Home</button>
        <button class="nav-btn" onclick="app.openTopicLauncher()"><span class="nav-icon">🗣️</span>Topics</button>
    </div>
</div>

<!-- OT REPORT -->
<div class="screen" id="reportScreen">
    <div class="report-scroll">
        <div class="report-header">🛠️ Developer Report</div>
        <div class="report-sub" id="reportSub">Usage data, conversation logs, and error tracking → ibvava@gmail.com</div>

        <div class="report-period-btns">
            <button class="report-period-btn active" onclick="app.renderReport('today',this)">Today</button>
            <button class="report-period-btn" onclick="app.renderReport('week',this)">This Week</button>
            <button class="report-period-btn" onclick="app.renderReport('all',this)">All Time</button>
        </div>

        <div id="reportContent"></div>

        <div class="report-section">
            <div class="report-section-title">📝 Add Carer Note</div>
            <textarea class="carer-note-input" id="carerNoteInput" rows="2" placeholder="Quick note about this session..."></textarea>
            <button class="carer-note-btn" onclick="app.saveCarerNote()">Save Note</button>
        </div>

        <div class="report-actions">
            <button class="report-action-btn primary" onclick="app.exportReport()">📋 Copy Report</button>
            <button class="report-action-btn" onclick="app.downloadReport()">💾 Download</button>
            <button class="report-action-btn" onclick="app.emailReport()">📧 Email to Dev</button>
        </div>
    </div>
    <div class="bottom-nav">
        <button class="nav-btn" onclick="app.goHome()"><span class="nav-icon">🏠</span>Home</button>
        <button class="nav-btn" onclick="app.openSettings()"><span class="nav-icon">⚙️</span>Settings</button>
    </div>
</div>

<!-- SETTINGS -->
<div class="screen" id="settingsScreen">
    <div class="settings-scroll">
        <div class="settings-section">
            <div class="settings-section-title">Choose Your Voice</div>
            <div class="settings-section-desc">Pick the voice that sounds right. Tap ▶ to preview.</div>
            <div class="voice-group-label">👨 Male Voices</div>
            <div id="maleVoices"></div>
            <div class="voice-group-label">👩 Female Voices</div>
            <div id="femaleVoices"></div>
        </div>
        <div class="settings-section">
            <div class="settings-section-title">Speaking Speed</div>
            <div class="settings-section-desc">Adjust how fast phrases are spoken.</div>
            <div class="speed-control">
                <div class="speed-label">Slow</div>
                <input type="range" class="speed-slider" id="speedSlider" min="0.5" max="1.3" step="0.05" value="0.92" oninput="app.updateSpeed(this.value)">
                <div class="speed-value" id="speedValue">0.92×</div>
                <div class="speed-label">Fast</div>
            </div>
        </div>
        <div class="settings-section">
            <div class="settings-section-title">Usage Stats</div>
            <div class="settings-section-desc">How you've been using the app.</div>
            <div id="usageStatsContent" style="color:var(--text-secondary);font-size:14px;">Loading...</div>
        </div>
        <div class="settings-section">
            <div class="settings-section-title">📊 Prediction Insights</div>
            <div class="settings-section-desc">How the app is learning your patterns.</div>
            <div id="predictionInsights" style="color:var(--text-secondary);font-size:14px;">Loading...</div>
        </div>
        <div class="settings-section">
            <div class="settings-section-title">🛠️ Developer Report</div>
            <div class="settings-section-desc">View usage data, errors, and conversation logs. Email reports to ibvava@gmail.com.</div>
            <button class="modal-btn save" style="max-width:250px;margin-bottom:8px;" onclick="app.openReport()">📊 View Report</button>
            <button class="modal-btn save" style="max-width:250px;margin-bottom:8px;" onclick="app.emailReport()">📧 Email Report</button>
            <button class="modal-btn cancel" style="max-width:250px;" onclick="app.downloadReport()">💾 Download Report</button>
        </div>
        <div class="settings-section">
            <div class="settings-section-title">Reset Data</div>
            <div class="settings-section-desc">Clear all usage history and custom phrases.</div>
            <button class="modal-btn cancel" style="max-width:200px;" onclick="if(confirm('Reset all data? This cannot be undone.')){localStorage.removeItem('ryans-aac-data');showToast('Data reset','success');app.renderHome();}">Reset All Data</button>
        </div>
        <div class="app-version-footer">
            <div class="version-name">Ryan's Voice</div>
            <div class="version-number" id="versionDisplay"></div>
            <div class="version-copyright" id="copyrightDisplay"></div>
            <div class="version-changelog" id="changelogToggle" onclick="document.getElementById('changelogContent').classList.toggle('visible')">View changelog ▾</div>
            <div class="version-changelog-content" id="changelogContent"></div>
        </div>
    </div>
    <div class="settings-bottom-nav">
        <button class="settings-home-btn" onclick="app.goHome()">🏠 Back to Home</button>
    </div>
</div>

<!-- ADD PHRASE MODAL -->
<div class="modal-overlay" id="addPhraseModal">
    <div class="modal-sheet">
        <div class="modal-handle"></div>
        <div class="modal-title">Add New Phrase</div>
        <div class="modal-desc">Type a phrase in your words.</div>
        <textarea class="modal-input" id="phraseInput" placeholder="Type your phrase here..." rows="2"></textarea>
        <div class="modal-category-select" id="modalCategorySelect"></div>
        <div class="modal-actions">
            <button class="modal-btn cancel" onclick="app.closeAddPhrase()">Cancel</button>
            <button class="modal-btn save" onclick="app.savePhrase()">Add Phrase</button>
        </div>
    </div>
</div>

<!-- EDIT/DELETE PHRASE MODAL -->
<div class="modal-overlay" id="editPhraseModal">
    <div class="modal-sheet">
        <div class="modal-handle"></div>
        <div class="modal-title" id="editModalTitle">Edit Phrase</div>
        <div class="modal-desc" id="editModalDesc">Tap to edit, or delete this phrase.</div>
        <textarea class="modal-input" id="editPhraseInput" rows="2"></textarea>
        <div class="modal-category-select" id="editCategorySelect"></div>
        <div class="modal-actions" style="gap:8px;">
            <button class="modal-btn cancel" onclick="app.closeEditPhrase()">Cancel</button>
            <button class="modal-btn delete" onclick="app.deletePhrase()">🗑️ Delete</button>
            <button class="modal-btn save" onclick="app.saveEditPhrase()">✓ Save</button>
        </div>
    </div>
</div>

<div class="toast" id="toast"></div>

<script>
// ============================================================
// APP VERSION & COPYRIGHT
// ============================================================
const APP_VERSION = {
    name: "Ryan's Voice",
    version: "2.9.0",
    build: "2026.02.14c",
    copyright: "© 2026 IV. All rights reserved.",
    license: "Built with love for Ryan.",
    changelog: [
        { ver:"2.9.0", date:"2026-02-14", notes:"Decline/refusal detection: new question types 'decline' and 'decline_delay' for when people say 'I'm tired', 'not now', 'maybe later'. Slot-fill blacklist prevents garbage phrases from verbs/adjectives (120+ blocked words). Slot-fill score reduced from 18→14. Topic-specific decline responses for gaming, outings, friends, activities." },
        { ver:"2.8.0", date:"2026-02-14", notes:"100% contextual coverage: filled 107 missing topic×questionType gaps across all 39 topics. Every topic now handles yesno, choice, preference, opinion, status, and review. Expanded from 188 to 303 response entries." },
        { ver:"2.7.0", date:"2026-02-14", notes:"Drag-to-speak interaction model. Contextual suggestion injection into bubble field. Expanded shopping & topic responses. Phrase edit/delete via long-press. Sentence builder. Version & copyright system." },
        { ver:"2.6.0", date:"2026-02-13", notes:"Glassy bubble UI with translucent aesthetics. Gamification: pop counter, sparkles, combos, milestones, levelled bubbles. Bubbles everywhere: suggestions, SOS, topic launcher, card browse." },
        { ver:"2.5.0", date:"2026-02-12", notes:"Prediction engine v2: n-gram sequences, time-of-day patterns, category preferences, session fatigue detection. Cross-context suggestions. Feedback 👍👎 system." },
        { ver:"2.4.0", date:"2026-02-11", notes:"Speech correction engine (3-level: phrase, word, phonetic). Conversation memory with topic anchoring. Slot-filled virtual suggestions." },
        { ver:"2.3.0", date:"2026-02-10", notes:"Contextual response matrix (40+ topics × 8 question types). Topic launcher with starter phrases. Question type classification." },
        { ver:"2.2.0", date:"2026-02-09", notes:"SOS dashboard with 7 sensory categories. Dev report with email/download. Carer feedback form. Error logging." },
        { ver:"2.1.0", date:"2026-02-09", notes:"Listening mode with Web Speech API. Topic detection. Suggestion strip. Male voice TTS selection." },
        { ver:"2.0.0", date:"2026-02-08", notes:"Complete rebuild as single HTML file. Dark theme. 8 contexts, 200+ phrases. Adaptive scoring. Custom phrase editor." },
        { ver:"1.0.0", date:"2026-02-07", notes:"Initial prototype. Card swipe interface. 4 contexts. Basic TTS. Deployed to GitHub Pages." },
    ]
};

// ============================================================
// CARD DATA — 200+ phrases across 8 contexts
// ============================================================
const CARD_DATA = {
story: {
    label: "📚 Story / Pictures", icon: "📚",
    categories: ["emotions","motivations","social","advice"],
    cards: [
        {text:"The character is jealous of the other one.",cat:"emotions"},
        {text:"He looks really surprised.",cat:"emotions"},
        {text:"He's in awe of someone.",cat:"emotions"},
        {text:"She seems disappointed by the outcome.",cat:"emotions"},
        {text:"He feels left out of the group.",cat:"emotions"},
        {text:"She looks proud of her accomplishment.",cat:"emotions"},
        {text:"He's feeling angry and frustrated.",cat:"emotions"},
        {text:"She's overwhelmed by everything happening.",cat:"emotions"},
        {text:"He looks genuinely content.",cat:"emotions"},
        {text:"There's a sense of longing in that expression.",cat:"emotions"},
        {text:"The big frog wants to be the boss.",cat:"motivations"},
        {text:"The boy is looking for a playmate.",cat:"motivations"},
        {text:"He thinks he's the boss of the animals.",cat:"motivations"},
        {text:"She wants to be left alone.",cat:"motivations"},
        {text:"He's trying to protect his territory.",cat:"motivations"},
        {text:"She's only thinking of herself.",cat:"motivations"},
        {text:"He wants to prove himself to the others.",cat:"motivations"},
        {text:"She's searching for acceptance.",cat:"motivations"},
        {text:"They realised he's being mean and selfish.",cat:"social"},
        {text:"He's totally lacking self-control.",cat:"social"},
        {text:"He's only thinking of himself.",cat:"social"},
        {text:"They're having a conflict about sharing.",cat:"social"},
        {text:"He's being a bully to the others.",cat:"social"},
        {text:"The group dynamics are changing.",cat:"social"},
        {text:"She's the peacemaker in this situation.",cat:"social"},
        {text:"They're excluding someone on purpose.",cat:"social"},
        {text:"Stop biting your friend. Use your kind words.",cat:"advice"},
        {text:"They need to learn cooperation.",cat:"advice"},
        {text:"They should take turns.",cat:"advice"},
        {text:"Everyone deserves respect.",cat:"advice"},
        {text:"Try to understand their feelings.",cat:"advice"},
        {text:"You need to share with others.",cat:"advice"},
        {text:"Think about how that makes them feel.",cat:"advice"},
        {text:"Actions have consequences.",cat:"advice"},
    ]
},
conversation: {
    label: "💬 Conversation", icon: "💬",
    categories: ["greetings","responses","feelings","requests","opinions","social","choices"],
    cards: [
        // Greetings
        {text:"G'day.",cat:"greetings"},
        {text:"Hey, how's it going?",cat:"greetings"},
        {text:"What have you been up to?",cat:"greetings"},
        {text:"Long time no see.",cat:"greetings"},
        {text:"Good to see you again.",cat:"greetings"},
        {text:"How's your day been?",cat:"greetings"},
        {text:"Not bad, thanks. You?",cat:"greetings"},
        {text:"Yeah, going alright.",cat:"greetings"},
        {text:"Can't complain.",cat:"greetings"},
        {text:"Catch you later.",cat:"greetings"},
        // Responses
        {text:"Yes, I'd like to join.",cat:"responses"},
        {text:"No thanks, maybe later.",cat:"responses"},
        {text:"Yeah, for sure.",cat:"responses"},
        {text:"No worries.",cat:"responses"},
        {text:"Sounds good.",cat:"responses"},
        {text:"That makes sense.",cat:"responses"},
        {text:"I reckon so.",cat:"responses"},
        {text:"Fair enough.",cat:"responses"},
        {text:"That's a good point.",cat:"responses"},
        {text:"I'm not sure about that.",cat:"responses"},
        {text:"I don't think so.",cat:"responses"},
        {text:"Maybe, I'll think about it.",cat:"responses"},
        {text:"That's not really my thing.",cat:"responses"},
        {text:"Absolutely.",cat:"responses"},
        {text:"I hadn't thought of it that way.",cat:"responses"},
        {text:"Yeah, nah.",cat:"responses"},
        // Feelings
        {text:"I'm feeling good today.",cat:"feelings"},
        {text:"I'm a bit frustrated right now.",cat:"feelings"},
        {text:"That made me happy.",cat:"feelings"},
        {text:"I need a break right now.",cat:"feelings"},
        {text:"I'm excited about that.",cat:"feelings"},
        {text:"I'm thinking about it.",cat:"feelings"},
        {text:"That's bothering me.",cat:"feelings"},
        {text:"I'm feeling overwhelmed.",cat:"feelings"},
        {text:"I'm a bit tired.",cat:"feelings"},
        {text:"That actually made my day.",cat:"feelings"},
        {text:"That really annoys me.",cat:"feelings"},
        {text:"I'm bored. Can we do something?",cat:"feelings"},
        {text:"I'm worried about it.",cat:"feelings"},
        {text:"I'm disappointed by that.",cat:"feelings"},
        // Requests
        {text:"Can you repeat that?",cat:"requests"},
        {text:"Can we talk about something else?",cat:"requests"},
        {text:"Give me a moment to think.",cat:"requests"},
        {text:"Can you ask me a yes or no question?",cat:"requests"},
        {text:"I want to say something important.",cat:"requests"},
        {text:"Please wait, I'm composing my response.",cat:"requests"},
        {text:"Can you show me what you mean?",cat:"requests"},
        {text:"Can you slow down a bit?",cat:"requests"},
        {text:"Can you explain that differently?",cat:"requests"},
        {text:"I need help with something.",cat:"requests"},
        // Opinions
        {text:"I think that's a great idea.",cat:"opinions"},
        {text:"I'm not convinced about that.",cat:"opinions"},
        {text:"There's more to it than that.",cat:"opinions"},
        {text:"That's a bit over the top.",cat:"opinions"},
        {text:"I reckon that could work.",cat:"opinions"},
        {text:"I disagree, but I understand your point.",cat:"opinions"},
        {text:"That's exactly what I was thinking.",cat:"opinions"},
        {text:"I'd rather not, if that's okay.",cat:"opinions"},
        {text:"It depends on the situation.",cat:"opinions"},
        {text:"Can we look at it from a different angle?",cat:"opinions"},
        // Social
        {text:"What are you up to this weekend?",cat:"social"},
        {text:"Have you seen any good shows lately?",cat:"social"},
        {text:"Did you catch the game?",cat:"social"},
        {text:"What do you think about that?",cat:"social"},
        {text:"Tell me more about that.",cat:"social"},
        {text:"That's hilarious.",cat:"social"},
        {text:"I've been thinking about something.",cat:"social"},
        {text:"Can I ask you something?",cat:"social"},
        {text:"That reminds me of something.",cat:"social"},
        {text:"We should do that again sometime.",cat:"social"},
        {text:"Thanks for letting me know.",cat:"social"},
        {text:"Good on ya.",cat:"social"},
        {text:"Cheers for that.",cat:"social"},
        {text:"That was really funny.",cat:"social"},
        {text:"I appreciate you saying that.",cat:"social"},
        {text:"How was your day?",cat:"social"},
        // Choices — food, drink, activity, general preferences
        {text:"Pizza, please.",cat:"choices"},
        {text:"Pasta would be good.",cat:"choices"},
        {text:"Chicken and rice.",cat:"choices"},
        {text:"I'd like a sandwich.",cat:"choices"},
        {text:"Can I have noodles?",cat:"choices"},
        {text:"Something simple.",cat:"choices"},
        {text:"Something warm.",cat:"choices"},
        {text:"Something light.",cat:"choices"},
        {text:"I'm not fussy, you choose.",cat:"choices"},
        {text:"Whatever everyone else is having.",cat:"choices"},
        {text:"I don't feel like eating.",cat:"choices"},
        {text:"I'd like what I had last time.",cat:"choices"},
        {text:"Can I see the options?",cat:"choices"},
        {text:"Water, please.",cat:"choices"},
        {text:"Juice would be good.",cat:"choices"},
        {text:"Hot chocolate, please.",cat:"choices"},
        {text:"Can I have milk?",cat:"choices"},
        {text:"Something cold to drink.",cat:"choices"},
        {text:"I'm not thirsty.",cat:"choices"},
        {text:"I want to play a game.",cat:"choices"},
        {text:"Can we watch something?",cat:"choices"},
        {text:"I'd like to go outside.",cat:"choices"},
        {text:"Can I use the iPad?",cat:"choices"},
        {text:"I want to read.",cat:"choices"},
        {text:"Can we do something together?",cat:"choices"},
        {text:"I'd rather stay in.",cat:"choices"},
        {text:"Something fun.",cat:"choices"},
        {text:"Something quiet.",cat:"choices"},
        {text:"I want to draw.",cat:"choices"},
        {text:"The first one.",cat:"choices"},
        {text:"The second one.",cat:"choices"},
        {text:"That one, please.",cat:"choices"},
        {text:"I don't mind.",cat:"choices"},
        {text:"You choose for me.",cat:"choices"},
        {text:"I need a moment to decide.",cat:"choices"},
        {text:"Neither, thanks.",cat:"choices"},
        {text:"Both sound good.",cat:"choices"},
        {text:"I'd like something different.",cat:"choices"},
        {text:"Can we go to the park?",cat:"choices"},
        {text:"Can we go to the shops?",cat:"choices"},
        {text:"I want to stay home.",cat:"choices"},
        {text:"Somewhere quiet.",cat:"choices"},
        {text:"I don't mind, you pick.",cat:"choices"},
    ]
},
math: {
    label: "🔢 Math", icon: "🔢",
    categories: ["observations","operations","geometry","discussion"],
    cards: [
        {text:"That theorem is fascinating.",cat:"observations"},
        {text:"I see a pattern here.",cat:"observations"},
        {text:"The proof shows that...",cat:"observations"},
        {text:"That's an elegant solution.",cat:"observations"},
        {text:"There's a relationship between these numbers.",cat:"observations"},
        {text:"This reminds me of another problem.",cat:"observations"},
        {text:"Let me calculate that.",cat:"operations"},
        {text:"The equation needs to balance.",cat:"operations"},
        {text:"We need to find the common factor.",cat:"operations"},
        {text:"The answer is a fraction.",cat:"operations"},
        {text:"This requires a different approach.",cat:"operations"},
        {text:"The variable represents an unknown quantity.",cat:"operations"},
        {text:"That's geometrically impossible.",cat:"geometry"},
        {text:"The angles need to add up to 180 degrees.",cat:"geometry"},
        {text:"Look at the symmetry.",cat:"geometry"},
        {text:"The shapes are congruent.",cat:"geometry"},
        {text:"It's a transformation — a rotation.",cat:"geometry"},
        {text:"Can you explain that step?",cat:"discussion"},
        {text:"I think there's an error in the working.",cat:"discussion"},
        {text:"Let me try a different method.",cat:"discussion"},
        {text:"That logic is sound.",cat:"discussion"},
        {text:"Can we go through it again?",cat:"discussion"},
        {text:"I need to think about this more.",cat:"discussion"},
    ]
},
gaming: {
    label: "🎮 Gaming / Videos", icon: "🎮",
    categories: ["reactions","requests","commentary","social"],
    cards: [
        {text:"That was an amazing play!",cat:"reactions"},
        {text:"This game is really challenging.",cat:"reactions"},
        {text:"I like how that works.",cat:"reactions"},
        {text:"That was unexpected.",cat:"reactions"},
        {text:"The graphics are incredible.",cat:"reactions"},
        {text:"That was so satisfying.",cat:"reactions"},
        {text:"I can't believe that just happened.",cat:"reactions"},
        {text:"I want to try that level.",cat:"requests"},
        {text:"Can we watch something different?",cat:"requests"},
        {text:"Let me have a turn.",cat:"requests"},
        {text:"Can we restart?",cat:"requests"},
        {text:"Skip this part.",cat:"requests"},
        {text:"Turn up the volume.",cat:"requests"},
        {text:"The strategy should be different.",cat:"commentary"},
        {text:"They're making a mistake.",cat:"commentary"},
        {text:"This character is overpowered.",cat:"commentary"},
        {text:"The storyline is getting interesting.",cat:"commentary"},
        {text:"That mechanic is broken.",cat:"commentary"},
        {text:"The difficulty curve is too steep.",cat:"commentary"},
        {text:"Do you want to play together?",cat:"social"},
        {text:"Your turn next.",cat:"social"},
        {text:"Great teamwork.",cat:"social"},
        {text:"Let's try a different game.",cat:"social"},
        {text:"I'm done playing for now.",cat:"social"},
    ]
},
school: {
    label: "🏫 At School", icon: "🏫",
    categories: ["learning","requests","social","feelings"],
    cards: [
        {text:"I understand the concept.",cat:"learning"},
        {text:"Can you explain that again?",cat:"learning"},
        {text:"I have a question about this.",cat:"learning"},
        {text:"I think the answer is...",cat:"learning"},
        {text:"That doesn't seem right to me.",cat:"learning"},
        {text:"This is interesting.",cat:"learning"},
        {text:"I see the connection now.",cat:"learning"},
        {text:"That's a tricky question.",cat:"learning"},
        {text:"I need more time to finish.",cat:"requests"},
        {text:"Can I work on this at my own pace?",cat:"requests"},
        {text:"I've finished this part.",cat:"requests"},
        {text:"I'm stuck on this bit.",cat:"requests"},
        {text:"Can I use my app to answer?",cat:"requests"},
        {text:"I need a quieter space.",cat:"requests"},
        {text:"Can I take a break?",cat:"requests"},
        {text:"Do you want to work on this together?",cat:"social"},
        {text:"That was a good presentation.",cat:"social"},
        {text:"I liked your idea.",cat:"social"},
        {text:"Can I sit with you?",cat:"social"},
        {text:"What class do you have next?",cat:"social"},
        {text:"I had a good day at school.",cat:"feelings"},
        {text:"Today was really hard.",cat:"feelings"},
        {text:"I'm proud of what I did today.",cat:"feelings"},
        {text:"I felt left out today.",cat:"feelings"},
        {text:"I'm stressed about the assignment.",cat:"feelings"},
    ]
},
home: {
    label: "🏠 At Home", icon: "🏡",
    categories: ["needs","family","feelings","requests"],
    cards: [
        {text:"What's for dinner?",cat:"needs"},
        {text:"I'm hungry.",cat:"needs"},
        {text:"I'm not hungry right now.",cat:"needs"},
        {text:"I'd like some water, please.",cat:"needs"},
        {text:"I'm tired. I want to rest.",cat:"needs"},
        {text:"Can I have a snack?",cat:"needs"},
        {text:"Thanks, Mum.",cat:"family"},
        {text:"Thanks, Dad.",cat:"family"},
        {text:"I love you.",cat:"family"},
        {text:"Can we watch something together?",cat:"family"},
        {text:"Can I stay up a bit longer?",cat:"family"},
        {text:"Something happened at school.",cat:"family"},
        {text:"I had a good day today.",cat:"family"},
        {text:"That's not fair.",cat:"feelings"},
        {text:"I don't want to do that right now.",cat:"feelings"},
        {text:"I need some time alone.",cat:"feelings"},
        {text:"I'm feeling happy.",cat:"feelings"},
        {text:"I'm upset about something.",cat:"feelings"},
        {text:"Can I choose what we do?",cat:"requests"},
        {text:"Can we go outside?",cat:"requests"},
        {text:"I want to play a game.",cat:"requests"},
        {text:"Can we go to the shops?",cat:"requests"},
        {text:"I don't feel well.",cat:"requests"},
    ]
},
sensory: {
    label: "⚡ Quick SOS", icon: "⚡",
    categories: ["sensory","overwhelm","needs","explain"],
    cards: [
        // Sensory triggers — smells
        {text:"That smell is really bothering me.",cat:"sensory"},
        {text:"Something smells bad. I need to move.",cat:"sensory"},
        {text:"The smell is making me feel sick.",cat:"sensory"},
        {text:"Can we go somewhere with fresh air?",cat:"sensory"},
        {text:"That perfume/spray is too strong.",cat:"sensory"},
        {text:"The food smell is overwhelming.",cat:"sensory"},
        // Sensory triggers — sound
        {text:"It's too loud in here.",cat:"sensory"},
        {text:"That noise is hurting my ears.",cat:"sensory"},
        {text:"Can we go somewhere quieter?",cat:"sensory"},
        {text:"I need my headphones.",cat:"sensory"},
        {text:"Please stop making that sound.",cat:"sensory"},
        {text:"The background noise is too much.",cat:"sensory"},
        {text:"Can you turn the volume down?",cat:"sensory"},
        {text:"That sudden noise startled me.",cat:"sensory"},
        // Sensory triggers — light/visual
        {text:"The light is too bright.",cat:"sensory"},
        {text:"The flickering light is bothering me.",cat:"sensory"},
        {text:"There's too much going on visually.",cat:"sensory"},
        {text:"I need to close my eyes for a moment.",cat:"sensory"},
        // Sensory triggers — touch/texture
        {text:"This texture is really uncomfortable.",cat:"sensory"},
        {text:"Don't touch me right now, please.",cat:"sensory"},
        {text:"These clothes are bothering me.",cat:"sensory"},
        {text:"The seat feels wrong.",cat:"sensory"},
        // Overwhelm / meltdown
        {text:"I'm starting to feel overwhelmed.",cat:"overwhelm"},
        {text:"I need to leave right now.",cat:"overwhelm"},
        {text:"I'm about to have a meltdown.",cat:"overwhelm"},
        {text:"Everything is too much right now.",cat:"overwhelm"},
        {text:"I can't cope with this.",cat:"overwhelm"},
        {text:"I need space. Please step back.",cat:"overwhelm"},
        {text:"I'm shutting down. Give me time.",cat:"overwhelm"},
        {text:"I feel like I'm going to explode.",cat:"overwhelm"},
        {text:"I can't think clearly right now.",cat:"overwhelm"},
        {text:"Too many people. I need to get out.",cat:"overwhelm"},
        {text:"Please stop talking to me for a moment.",cat:"overwhelm"},
        {text:"I'm trying to calm down. Please wait.",cat:"overwhelm"},
        // Immediate needs
        {text:"I need a quiet space now.",cat:"needs"},
        {text:"I need a break. 5 minutes.",cat:"needs"},
        {text:"I need water.",cat:"needs"},
        {text:"I need to go to the bathroom.",cat:"needs"},
        {text:"I need to sit down.",cat:"needs"},
        {text:"I need to go home.",cat:"needs"},
        {text:"I need my comfort item.",cat:"needs"},
        {text:"I'm not feeling safe here.",cat:"needs"},
        {text:"I need someone I trust.",cat:"needs"},
        {text:"Can I go to a different room?",cat:"needs"},
        {text:"I need to do my calming routine.",cat:"needs"},
        {text:"I need to move around.",cat:"needs"},
        // Explain to others
        {text:"I'm autistic. I process things differently.",cat:"explain"},
        {text:"I'm not being rude, I'm overwhelmed.",cat:"explain"},
        {text:"Loud noises physically hurt me.",cat:"explain"},
        {text:"I need more time to respond.",cat:"explain"},
        {text:"I communicate using this app.",cat:"explain"},
        {text:"Strong smells make me feel sick.",cat:"explain"},
        {text:"I'm having a hard time, but I'll be okay.",cat:"explain"},
        {text:"Please be patient with me.",cat:"explain"},
        {text:"I can hear you, I just can't respond yet.",cat:"explain"},
        {text:"I'm not ignoring you. I'm processing.",cat:"explain"},
    ]
},
malayalam: {
    label: "🇮🇳 Malayalam", icon: "🇮🇳",
    categories: ["greetings","responses","feelings","family"],
    cards: [
        {text:"നമസ്കാരം",cat:"greetings",sub:"Namaskāram — Hello"},
        {text:"ഹലോ",cat:"greetings",sub:"Halō — Hello (casual)"},
        {text:"സുപ്രഭാതം",cat:"greetings",sub:"Suprabhātham — Good morning"},
        {text:"ശുഭ സന്ധ്യ",cat:"greetings",sub:"Shubha sandhya — Good evening"},
        {text:"ശുഭ രാത്രി",cat:"greetings",sub:"Shubha rāthri — Good night"},
        {text:"എന്തൊക്കെയുണ്ട്?",cat:"greetings",sub:"Enthokke undu? — How are you?"},
        {text:"സുഖമാണോ?",cat:"greetings",sub:"Sukhamāno? — Are you well?"},
        {text:"എനിക്ക് സുഖമാണ്",cat:"greetings",sub:"Enikku sukhamānu — I am well"},
        {text:"കണ്ടതിൽ സന്തോഷം",cat:"greetings",sub:"Kandathil santhōsham — Nice to see you"},
        {text:"പിന്നെ കാണാം",cat:"greetings",sub:"Pinne kānām — See you later"},
        {text:"അതെ",cat:"responses",sub:"Athe — Yes"},
        {text:"അല്ല",cat:"responses",sub:"Alla — No"},
        {text:"ശരി",cat:"responses",sub:"Shari — Okay"},
        {text:"നന്ദി",cat:"responses",sub:"Nandi — Thank you"},
        {text:"ക്ഷമിക്കണം",cat:"responses",sub:"Kshamikkanam — Sorry"},
        {text:"സാരമില്ല",cat:"responses",sub:"Sāramilla — No problem"},
        {text:"ശരിയാണ്",cat:"responses",sub:"Shariyānu — That's right"},
        {text:"എനിക്ക് അറിയില്ല",cat:"responses",sub:"Enikku ariyilla — I don't know"},
        {text:"ഒരു നിമിഷം",cat:"responses",sub:"Oru nimisham — One moment"},
        {text:"എനിക്ക് സന്തോഷമുണ്ട്",cat:"feelings",sub:"Enikku santhōsham undu — I am happy"},
        {text:"എനിക്ക് വിഷമമുണ്ട്",cat:"feelings",sub:"Enikku vishamam undu — I am sad"},
        {text:"എനിക്ക് ദേഷ്യം വരുന്നു",cat:"feelings",sub:"Enikku dēshyam varunnu — I am angry"},
        {text:"എനിക്ക് ക്ഷീണമുണ്ട്",cat:"feelings",sub:"Enikku ksheenam undu — I am tired"},
        {text:"എനിക്ക് വിശക്കുന്നു",cat:"feelings",sub:"Enikku vishakkunnu — I am hungry"},
        {text:"എനിക്ക് ദാഹിക്കുന്നു",cat:"feelings",sub:"Enikku dāhikkunnu — I am thirsty"},
        {text:"എനിക്ക് വേണ്ട",cat:"feelings",sub:"Enikku vēnda — I don't want it"},
        {text:"എനിക്ക് ഇഷ്ടമാണ്",cat:"feelings",sub:"Enikku ishtamānu — I like it"},
        {text:"അമ്മ",cat:"family",sub:"Amma — Mother"},
        {text:"അച്ഛൻ",cat:"family",sub:"Achan — Father"},
        {text:"ചേട്ടൻ",cat:"family",sub:"Chēttan — Elder brother"},
        {text:"ചേച്ചി",cat:"family",sub:"Chēchi — Elder sister"},
        {text:"ദയവായി",cat:"family",sub:"Dayavāyi — Please"},
        {text:"എന്നെ സഹായിക്കൂ",cat:"family",sub:"Enne sahāyikkoo — Help me"},
        {text:"എനിക്ക് വെള്ളം വേണം",cat:"family",sub:"Enikku vellam vēnam — I need water"},
    ]
}
};

const CONTEXTS = [
    {id:"sensory",     icon:"⚡", label:"Quick SOS",         group:"urgent"},
    {id:"topicLaunch", icon:"🗣️", label:"Start Talking",     group:"urgent"},
    {id:"conversation",icon:"💬", label:"Talk to Me",        group:"urgent"},
    {id:"school",      icon:"🏫", label:"At School",         group:"life"},
    {id:"home",        icon:"🏡", label:"At Home",           group:"life"},
    {id:"malayalam",   icon:"🇮🇳", label:"Malayalam",         group:"life"},
    {id:"settings",    icon:"⚙️", label:"Settings",          group:"life"},
];

// ============================================================
// PERSISTENCE & ADAPTIVE PREDICTION ENGINE (Phase 2D)
// ============================================================
const STORAGE_KEY = "ryans-aac-data";

function loadData() {
    try {
        const r = localStorage.getItem(STORAGE_KEY);
        const d = r ? JSON.parse(r) : {};
        if (!d.customCards) d.customCards = {};
        if (!d.preferences) d.preferences = {};
        if (!d.usage) d.usage = {};  // { "context:cardtext": { count, lastUsed, timestamps[] } }
        if (!d.totalSpoken) d.totalSpoken = 0;
        if (!d.sessionStart) d.sessionStart = Date.now();
        // Phase 2D additions
        if (!d.sequences) d.sequences = {};
        if (!d.hourBuckets) d.hourBuckets = {};
        if (!d.catPrefs) d.catPrefs = {};
        if (!d.sessions) d.sessions = [];
        if (!d.dailyPatterns) d.dailyPatterns = {};
        // OT Report additions
        if (!d.conversationLog) d.conversationLog = [];    // [{time, heard, topic, questionType, suggestions[], chosen, source, context}]
        if (!d.errorLog) d.errorLog = [];                  // [{time, heard, problem, context, suggestions[]}]
        if (!d.feedback) d.feedback = [];                  // [{time, phrase, rating:'up'|'down', heard, context}]
        if (!d.carerNotes) d.carerNotes = [];              // [{time, note, sessionId}]
        if (!d.topicLauncherLog) d.topicLauncherLog = [];  // [{time, topic, starter}]
        return d;
    } catch { return {customCards:{},hiddenCards:{},preferences:{},usage:{},totalSpoken:0,sessionStart:Date.now(),sequences:{},hourBuckets:{},catPrefs:{},sessions:[],dailyPatterns:{},conversationLog:[],errorLog:[],feedback:[],carerNotes:[],topicLauncherLog:[]}; }
}

function saveData(d) {
    try { localStorage.setItem(STORAGE_KEY, JSON.stringify(d)); } catch {}
}

// ---- FEEDBACK & ERROR LOGGING ----

function logFeedback(rating, phraseText) {
    const d = loadData();
    const lastHeard = conversationTranscript.length > 0 ? conversationTranscript[conversationTranscript.length-1].text : '';
    d.feedback.push({
        time: Date.now(),
        phrase: phraseText,
        rating, // 'up' or 'down'
        heard: lastHeard,
        context: app.currentContext || '',
        topic: detectedTopic || '',
    });
    if (d.feedback.length > 300) d.feedback = d.feedback.slice(-300);

    // If thumbs down, also add to error log
    if (rating === 'down') {
        d.errorLog.push({
            time: Date.now(),
            heard: lastHeard,
            problem: 'wrong_suggestion',
            wrongPhrase: phraseText,
            context: app.currentContext || '',
            topic: detectedTopic || '',
            suggestions: suggestedPhrases.slice(0,6).map(s => s.card?.text || '').filter(Boolean),
        });
        if (d.errorLog.length > 200) d.errorLog = d.errorLog.slice(-200);
    }
    saveData(d);
}

function logError(type, details) {
    const d = loadData();
    const lastHeard = conversationTranscript.length > 0 ? conversationTranscript[conversationTranscript.length-1].text : '';
    d.errorLog.push({
        time: Date.now(),
        heard: lastHeard,
        problem: type, // 'no_suggestions', 'wrong_topic', 'speech_not_recognised'
        details: details || '',
        context: app.currentContext || '',
        topic: detectedTopic || '',
        suggestions: suggestedPhrases.slice(0,6).map(s => s.card?.text || '').filter(Boolean),
    });
    if (d.errorLog.length > 200) d.errorLog = d.errorLog.slice(-200);
    saveData(d);
}

function logTopicLaunch(topicId, starterText) {
    const d = loadData();
    d.topicLauncherLog.push({time: Date.now(), topic: topicId, starter: starterText});
    if (d.topicLauncherLog.length > 200) d.topicLauncherLog = d.topicLauncherLog.slice(-200);
    saveData(d);
}

function addCarerNote(note) {
    const d = loadData();
    d.carerNotes.push({time: Date.now(), note, context: app.currentContext || ''});
    if (d.carerNotes.length > 100) d.carerNotes = d.carerNotes.slice(-100);
    saveData(d);
}

// Last spoken phrase — for sequence tracking
let lastSpokenKey = null;
let lastSpokenTime = 0;

function trackUsage(contextId, cardText, category) {
    const d = loadData();
    const key = contextId + ':' + cardText;
    const now = Date.now();
    const hour = new Date().getHours();
    const day = new Date().getDay();

    // 1. Basic usage (existing)
    if (!d.usage[key]) d.usage[key] = {count:0, lastUsed:0, timestamps:[]};
    d.usage[key].count++;
    d.usage[key].lastUsed = now;
    d.usage[key].timestamps.push(now);
    if (d.usage[key].timestamps.length > 50) d.usage[key].timestamps = d.usage[key].timestamps.slice(-50);
    d.totalSpoken = (d.totalSpoken || 0) + 1;

    // 2. Sequence tracking
    if (lastSpokenKey && (now - lastSpokenTime) < 120000) {
        if (!d.sequences[lastSpokenKey]) d.sequences[lastSpokenKey] = {};
        d.sequences[lastSpokenKey][cardText] = (d.sequences[lastSpokenKey][cardText] || 0) + 1;
    }
    lastSpokenKey = key;
    lastSpokenTime = now;

    // 3. Time-of-day patterns
    const hourKey = contextId + ':' + hour;
    if (!d.hourBuckets[hourKey]) d.hourBuckets[hourKey] = {};
    d.hourBuckets[hourKey][cardText] = (d.hourBuckets[hourKey][cardText] || 0) + 1;

    // 4. Category preference per context
    if (category) {
        if (!d.catPrefs[contextId]) d.catPrefs[contextId] = {};
        d.catPrefs[contextId][category] = (d.catPrefs[contextId][category] || 0) + 1;
    }

    // 5. Day-of-week patterns
    const dayKey = day.toString();
    if (!d.dailyPatterns[dayKey]) d.dailyPatterns[dayKey] = {};
    d.dailyPatterns[dayKey][contextId] = (d.dailyPatterns[dayKey][contextId] || 0) + 1;

    // 6. Session tracking
    const lastSession = d.sessions[d.sessions.length - 1];
    if (lastSession && (now - lastSession.lastActivity) < 300000 && lastSession.context === contextId) {
        lastSession.lastActivity = now;
        lastSession.cardCount++;
        if (lastSession.phrases.length < 100) lastSession.phrases.push(cardText);
    } else {
        d.sessions.push({start:now, lastActivity:now, context:contextId, cardCount:1, phrases:[cardText]});
        if (d.sessions.length > 200) d.sessions = d.sessions.slice(-200);
    }

    // 7. CONVERSATION LOG — what was heard vs what Ryan chose
    const lastHeard = conversationTranscript.length > 0 ? conversationTranscript[conversationTranscript.length-1].text : '';
    const wasSuggested = suggestedPhrases.some(s => s.card && s.card.text === cardText);
    const suggestionTexts = suggestedPhrases.slice(0,6).map(s => s.card?.text || '').filter(Boolean);
    d.conversationLog.push({
        time: now,
        heard: lastHeard,
        topic: detectedTopic || '',
        chosen: cardText,
        context: contextId,
        wasSuggested,
        source: wasSuggested ? (suggestedPhrases.find(s => s.card?.text === cardText)?.source || '') : 'browsed',
        suggestions: suggestionTexts,
    });
    if (d.conversationLog.length > 500) d.conversationLog = d.conversationLog.slice(-500);

    saveData(d);
}

// ---- ADAPTIVE SCORING ENGINE ----

function getCardScore(contextId, cardText) {
    const d = loadData();
    const key = contextId + ':' + cardText;
    const u = d.usage[key];
    if (!u) return 0;
    const hoursSinceUse = (Date.now() - u.lastUsed) / 3600000;
    const recency = Math.max(0, 1 - hoursSinceUse / 168);
    return u.count * (0.5 + 0.5 * recency);
}

function getAdaptiveScore(contextId, cardText, category) {
    const d = loadData();
    const now = Date.now();
    const hour = new Date().getHours();
    let score = 0;

    // 1. Base frequency + recency (existing logic)
    score += getCardScore(contextId, cardText);

    // 2. Sequence bonus — if Ryan just said X, and he often follows X with this card
    if (lastSpokenKey && d.sequences[lastSpokenKey]) {
        const seqCount = d.sequences[lastSpokenKey][cardText] || 0;
        if (seqCount > 0) {
            score += seqCount * 3; // Strong signal — he's done this pattern before
        }
    }

    // 3. Time-of-day bonus — does Ryan use this phrase at this hour?
    const hourKey = contextId + ':' + hour;
    if (d.hourBuckets[hourKey] && d.hourBuckets[hourKey][cardText]) {
        score += d.hourBuckets[hourKey][cardText] * 1.5;
    }
    // Also check adjacent hours (+/- 1)
    const prevHour = contextId + ':' + ((hour + 23) % 24);
    const nextHour = contextId + ':' + ((hour + 1) % 24);
    if (d.hourBuckets[prevHour]?.[cardText]) score += d.hourBuckets[prevHour][cardText] * 0.5;
    if (d.hourBuckets[nextHour]?.[cardText]) score += d.hourBuckets[nextHour][cardText] * 0.5;

    // 4. Category preference bonus — if Ryan prefers this category in this context
    if (category && d.catPrefs[contextId]) {
        const totalCatUse = Object.values(d.catPrefs[contextId]).reduce((s,v) => s+v, 0);
        if (totalCatUse > 5) { // Only after enough data
            const catShare = (d.catPrefs[contextId][category] || 0) / totalCatUse;
            if (catShare > 0.4) score += 2; // Strong preference for this category
            if (catShare > 0.6) score += 3; // Very strong
        }
    }

    // 5. Session fatigue detection — surface "I need a break" after long sessions
    const sessions = d.sessions;
    if (sessions.length > 0) {
        const current = sessions[sessions.length - 1];
        const sessionMinutes = (now - current.start) / 60000;
        if (sessionMinutes > 15) {
            // Boost break/rest cards
            const breakPhrases = ['I need a break','I need a break. 5 minutes.','I\'m feeling overwhelmed.','I need a break right now.','I\'m a bit tired.'];
            if (breakPhrases.some(bp => cardText.toLowerCase().includes(bp.toLowerCase()))) {
                score += 4 + (sessionMinutes - 15) * 0.3; // Gets stronger over time
            }
        }
    }

    return score;
}

// Get sequence predictions — "after Ryan said X, he usually says..."
function getSequencePredictions(contextId, limit) {
    const d = loadData();
    if (!lastSpokenKey || !d.sequences[lastSpokenKey]) return [];
    const seqs = d.sequences[lastSpokenKey];
    return Object.entries(seqs)
        .sort((a,b) => b[1] - a[1])
        .slice(0, limit || 3)
        .map(([text, count]) => ({text, count, type:'sequence'}));
}

// Get time-of-day predictions
function getTimeOfDayPredictions(contextId, limit) {
    const d = loadData();
    const hour = new Date().getHours();
    const hourKey = contextId + ':' + hour;
    if (!d.hourBuckets[hourKey]) return [];
    return Object.entries(d.hourBuckets[hourKey])
        .sort((a,b) => b[1] - a[1])
        .slice(0, limit || 3)
        .map(([text, count]) => ({text, count, type:'timeOfDay'}));
}

// Get preferred category for this context
function getPreferredCategory(contextId) {
    const d = loadData();
    if (!d.catPrefs[contextId]) return null;
    const entries = Object.entries(d.catPrefs[contextId]);
    if (entries.length === 0) return null;
    const total = entries.reduce((s,[,v]) => s+v, 0);
    if (total < 10) return null; // Need enough data
    const top = entries.sort((a,b) => b[1] - a[1])[0];
    const share = top[1] / total;
    if (share > 0.4) return {category:top[0], share:Math.round(share*100)};
    return null;
}

// Get session info
function getSessionInfo() {
    const d = loadData();
    const sessions = d.sessions;
    if (sessions.length === 0) return null;
    const current = sessions[sessions.length - 1];
    const now = Date.now();
    if ((now - current.lastActivity) > 300000) return null; // Session ended >5 min ago
    return {
        minutes: Math.round((now - current.start) / 60000),
        cardCount: current.cardCount,
        context: current.context,
        isLong: (now - current.start) > 900000, // >15 min
    };
}

// Generate prediction summary for the UI
function getPredictionSummary(contextId) {
    const predictions = [];
    
    // Sequence predictions
    const seqs = getSequencePredictions(contextId, 2);
    seqs.forEach(s => predictions.push({text:s.text, score:s.count*3, reason:'🔗 You often say this next'}));

    // Time-of-day predictions
    const timePs = getTimeOfDayPredictions(contextId, 2);
    timePs.forEach(t => predictions.push({text:t.text, score:t.count*1.5, reason:'🕐 Common at this time'}));

    // Category preference
    const catPref = getPreferredCategory(contextId);

    // Session awareness
    const session = getSessionInfo();

    return {predictions, catPref, session};
}

// ---- OT DATA EXPORT ----
function generateOTReport() {
    const d = loadData();
    const now = new Date();
    let report = `RYAN'S AAC USAGE REPORT\nGenerated: ${now.toLocaleDateString('en-AU')} ${now.toLocaleTimeString('en-AU')}\n`;
    report += `${'='.repeat(50)}\n\n`;

    // Overall stats
    report += `OVERALL STATISTICS\n`;
    report += `Total phrases spoken: ${d.totalSpoken}\n`;
    report += `Unique phrases used: ${Object.keys(d.usage).length}\n`;
    report += `Sessions recorded: ${d.sessions.length}\n\n`;

    // Top phrases
    report += `TOP 20 MOST USED PHRASES\n`;
    const topPhrases = Object.entries(d.usage).sort((a,b) => b[1].count - a[1].count).slice(0,20);
    topPhrases.forEach(([key, u], i) => {
        const [ctx, ...textParts] = key.split(':');
        const text = textParts.join(':');
        report += `${i+1}. [${ctx}] "${text}" — ${u.count}× (last: ${new Date(u.lastUsed).toLocaleDateString('en-AU')})\n`;
    });
    report += '\n';

    // Time-of-day patterns
    report += `TIME-OF-DAY PATTERNS\n`;
    const hourTotals = {};
    Object.entries(d.hourBuckets).forEach(([key, phrases]) => {
        const hour = parseInt(key.split(':').pop());
        hourTotals[hour] = (hourTotals[hour] || 0) + Object.values(phrases).reduce((s,v) => s+v, 0);
    });
    for (let h = 6; h <= 22; h++) {
        const count = hourTotals[h] || 0;
        const bar = '█'.repeat(Math.min(count, 30));
        const label = h < 12 ? `${h}am` : h === 12 ? '12pm' : `${h-12}pm`;
        if (count > 0) report += `  ${label.padStart(4)}: ${bar} (${count})\n`;
    }
    report += '\n';

    // Category preferences
    report += `CATEGORY PREFERENCES BY CONTEXT\n`;
    Object.entries(d.catPrefs).forEach(([ctx, cats]) => {
        const total = Object.values(cats).reduce((s,v) => s+v, 0);
        report += `  ${ctx}:\n`;
        Object.entries(cats).sort((a,b) => b[1] - a[1]).forEach(([cat, count]) => {
            const pct = Math.round(count/total*100);
            report += `    ${cat}: ${pct}% (${count}×)\n`;
        });
    });
    report += '\n';

    // Sequence patterns
    report += `COMMON PHRASE SEQUENCES (says A → then B)\n`;
    const seqEntries = Object.entries(d.sequences)
        .map(([key, followers]) => {
            const topFollower = Object.entries(followers).sort((a,b) => b[1] - a[1])[0];
            if (!topFollower || topFollower[1] < 2) return null;
            const [,phraseA] = key.split(':').length > 1 ? [key.split(':')[0], key.split(':').slice(1).join(':')] : ['?', key];
            return {a:phraseA, b:topFollower[0], count:topFollower[1]};
        })
        .filter(Boolean)
        .sort((a,b) => b.count - a.count)
        .slice(0, 15);
    seqEntries.forEach(s => {
        report += `  "${s.a.substring(0,40)}" → "${s.b.substring(0,40)}" (${s.count}×)\n`;
    });
    report += '\n';

    // Session analysis
    report += `SESSION ANALYSIS (last 20 sessions)\n`;
    const recentSessions = d.sessions.slice(-20);
    recentSessions.forEach((s, i) => {
        const duration = Math.round((s.lastActivity - s.start) / 60000);
        const date = new Date(s.start);
        report += `  ${date.toLocaleDateString('en-AU')} ${date.toLocaleTimeString('en-AU',{hour:'2-digit',minute:'2-digit'})}: ${duration} min, ${s.cardCount} phrases [${s.context}]\n`;
    });
    report += '\n';

    // Average session
    if (recentSessions.length > 0) {
        const avgDuration = recentSessions.reduce((s,ss) => s + (ss.lastActivity - ss.start), 0) / recentSessions.length / 60000;
        const avgCards = recentSessions.reduce((s,ss) => s + ss.cardCount, 0) / recentSessions.length;
        report += `  Average session: ${Math.round(avgDuration)} min, ${Math.round(avgCards)} phrases\n\n`;
    }

    // Day-of-week patterns
    report += `DAY-OF-WEEK USAGE\n`;
    const dayNames = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];
    for (let d2 = 0; d2 < 7; d2++) {
        const dayData = d.dailyPatterns[d2.toString()];
        if (dayData) {
            const total = Object.values(dayData).reduce((s,v) => s+v, 0);
            const contexts = Object.entries(dayData).sort((a,b) => b[1] - a[1]).map(([c,n]) => `${c}:${n}`).join(', ');
            report += `  ${dayNames[d2]}: ${total} total (${contexts})\n`;
        }
    }

    return report;
}

function getCardsForContext(contextId) {
    const base = CARD_DATA[contextId];
    if (!base) return [];
    const d = loadData();
    const custom = d.customCards[contextId] || [];
    const hidden = (d.hiddenCards && d.hiddenCards[contextId]) || [];

    // Filter out hidden built-in cards
    let builtIn = base.cards.filter(c => !hidden.includes(c.text));
    // Mark custom cards
    let customMarked = custom.map(c => ({...c, custom:true}));

    let all = [...builtIn, ...customMarked];

    // Smart reorder: use adaptive score (Phase 2D)
    all.sort((a, b) => {
        const sa = getAdaptiveScore(contextId, a.text, a.cat);
        const sb = getAdaptiveScore(contextId, b.text, b.cat);
        return sb - sa;
    });

    return all;
}

function addCustomCard(contextId, text, category) {
    const d = loadData();
    if (!d.customCards[contextId]) d.customCards[contextId] = [];
    d.customCards[contextId].push({text, cat:category, custom:true});
    saveData(d);
}

function getUsageStats() {
    const d = loadData();
    const total = d.totalSpoken || 0;
    const contexts = Object.keys(d.usage).reduce((acc, key) => {
        const ctx = key.split(':')[0];
        acc[ctx] = (acc[ctx] || 0) + d.usage[key].count;
        return acc;
    }, {});
    const topCards = Object.entries(d.usage)
        .sort((a,b) => b[1].count - a[1].count)
        .slice(0, 5);
    return {total, contexts, topCards};
}

// ============================================================
// TTS — Voice picker
// ============================================================
let allVoices = [], preferredVoice = null, speechRate = 0.92;

const VOICE_GENDER = {
    'Daniel':'male','Gordon':'male','James':'male','Aaron':'male','Arthur':'male','Fred':'male','Alex':'male','Tom':'male','Oliver':'male','Rishi':'male','Lee':'male','Ralph':'male','Albert':'male','Eddy':'male','Evan':'male','Liam':'male','Malcolm':'male',
    'Samantha':'female','Karen':'female','Moira':'female','Tessa':'female','Fiona':'female','Victoria':'female','Serena':'female','Kate':'female','Zoe':'female','Nicky':'female','Allison':'female','Ava':'female','Susan':'female','Sandy':'female','Shelley':'female','Martha':'female','Matilda':'female','Catherine':'female','Veena':'female','Reed':'female',
};

function classifyVoice(v) {
    for (const [n,g] of Object.entries(VOICE_GENDER)) { if (v.name.includes(n)) return g; }
    if (/\bMale\b/i.test(v.name)) return 'male';
    if (/\bFemale\b/i.test(v.name)) return 'female';
    return 'unknown';
}

function getEnglishVoices() { return allVoices.filter(v => v.lang.startsWith('en')); }

function initVoices() {
    allVoices = speechSynthesis.getVoices();
    const saved = loadData().preferences;
    if (saved.voiceRate) speechRate = saved.voiceRate;
    const english = getEnglishVoices();
    if (saved.voiceName) {
        const f = english.find(v => v.name === saved.voiceName);
        if (f) { preferredVoice = f; renderVoiceSettings(); return; }
    }
    for (const n of ['Daniel','Gordon','James','Aaron','Arthur','Fred','Alex']) {
        const f = english.find(v => v.name.includes(n));
        if (f) { preferredVoice = f; break; }
    }
    if (!preferredVoice && english.length) preferredVoice = english[0];
    renderVoiceSettings();
}

function renderVoiceSettings() {
    const english = getEnglishVoices();
    const males = english.filter(v => classifyVoice(v)==='male');
    const females = english.filter(v => classifyVoice(v)==='female');
    const unknowns = english.filter(v => classifyVoice(v)==='unknown');
    const maleEl = document.getElementById('maleVoices');
    const femaleEl = document.getElementById('femaleVoices');
    if (!maleEl) return;
    const voiceHTML = (v) => {
        const sel = preferredVoice && preferredVoice.name === v.name;
        const region = {'AU':'Australia','GB':'UK','US':'US','IE':'Ireland','IN':'India','ZA':'South Africa','NZ':'New Zealand'}[v.lang.replace('en-','').toUpperCase()] || v.lang;
        const dn = v.name.replace(/com\.apple\.\w+\./g,'').replace(/Microsoft\s+/g,'');
        const sn = v.name.replace(/'/g,"\\'");
        return `<div class="voice-option${sel?' selected':''}" onclick="app.selectVoice('${sn}')"><div class="voice-radio"><div class="voice-radio-dot"></div></div><div class="voice-info"><div class="voice-name">${dn}</div><div class="voice-detail">${region}</div></div><button class="voice-preview-btn" onclick="event.stopPropagation();app.previewVoice('${sn}')">▶</button></div>`;
    };
    maleEl.innerHTML = [...males,...unknowns].map(voiceHTML).join('') || '<div style="color:var(--text-muted);font-size:12px;padding:8px">No male voices found.</div>';
    femaleEl.innerHTML = females.map(voiceHTML).join('') || '<div style="color:var(--text-muted);font-size:12px;padding:8px">No female voices found.</div>';
    const slider = document.getElementById('speedSlider');
    const val = document.getElementById('speedValue');
    if (slider) slider.value = speechRate;
    if (val) val.textContent = speechRate.toFixed(2) + '×';
}

if ('speechSynthesis' in window) { speechSynthesis.onvoiceschanged = initVoices; initVoices(); }

function speakText(text) {
    if (!('speechSynthesis' in window)) return false;
    speechSynthesis.cancel();
    const utt = new SpeechSynthesisUtterance(text);
    if (preferredVoice) utt.voice = preferredVoice;
    utt.rate = speechRate; utt.pitch = 0.95; utt.volume = 1;
    utt.onend = () => {
        document.getElementById('phraseCard').classList.remove('speaking');
        document.getElementById('speakBtn').classList.remove('speaking');
        document.getElementById('speakBtn').textContent = 'TAP TO SPEAK';
    };
    document.getElementById('phraseCard').classList.add('speaking');
    document.getElementById('speakBtn').classList.add('speaking');
    document.getElementById('speakBtn').textContent = '🔊 Speaking...';
    speechSynthesis.speak(utt);
    return true;
}

// TOAST
let toastTimer = null;
function showToast(msg, type) {
    const t = document.getElementById('toast');
    t.textContent = msg; t.className = 'toast show' + (type ? ' '+type : '');
    clearTimeout(toastTimer);
    toastTimer = setTimeout(() => t.classList.remove('show'), 2200);
}

// INSTALL
function dismissInstall() {
    document.getElementById('installBanner').classList.remove('visible');
    try { localStorage.setItem('ryans-aac-install-dismissed','1'); } catch {}
}
function checkInstallBanner() {
    const standalone = window.matchMedia('(display-mode:standalone)').matches || window.navigator.standalone;
    if (!standalone && !localStorage.getItem('ryans-aac-install-dismissed')) document.getElementById('installBanner').classList.add('visible');
}

// ============================================================
// CONVERSATION LISTENING ENGINE (Phase 2C)
// ============================================================
let recognition = null;
let isListening = false;
let conversationTranscript = [];
let lastTranscriptUpdate = 0;
let detectedTopic = '';
let detectedKeywords = [];
let suggestedPhrases = [];

// ============================================================
// TOPIC STARTERS — conversation initiators for each topic
// Ryan taps a topic → sees these → taps one → speaks it → conversation begins
// ============================================================
const TOPIC_STARTERS = {
    food: [
        {icon:'🍽️', text:"I'm hungry. Can we discuss what to eat?"},
        {icon:'🍕', text:"I'd like pizza for dinner, if possible."},
        {icon:'💭', text:"I have a suggestion for what we could eat."},
        {icon:'❌', text:"I don't feel like eating right now."},
        {icon:'🔄', text:"Can we have something different from yesterday?"},
        {icon:'⭐', text:"Can we have my favourite meal tonight?"},
    ],
    drink: [
        {icon:'🥤', text:"I'm thirsty. Could I have a drink, please?"},
        {icon:'☕', text:"A hot chocolate would be lovely, if that's okay."},
        {icon:'💧', text:"Can I have some water, please?"},
        {icon:'❌', text:"I'm not thirsty at the moment, thanks."},
    ],
    hygiene: [
        {icon:'🚿', text:"I'd like to have a shower, please."},
        {icon:'✅', text:"I've already brushed my teeth."},
        {icon:'🆘', text:"I need help getting ready."},
        {icon:'⏰', text:"Do I need to shower now, or can I do it later?"},
        {icon:'👕', text:"I need clean clothes."},
    ],
    sleep: [
        {icon:'😴', text:"I'm feeling really tired."},
        {icon:'🌙', text:"Can I stay up a bit longer tonight?"},
        {icon:'😟', text:"I didn't sleep well last night."},
        {icon:'💤', text:"I think I need a nap."},
        {icon:'👍', text:"I slept really well, actually."},
    ],
    chores: [
        {icon:'✅', text:"I've finished my chores."},
        {icon:'🆘', text:"I need help with a task."},
        {icon:'⏰', text:"Can I do it later?"},
        {icon:'❓', text:"What do I need to do today?"},
        {icon:'🤝', text:"Can someone help me with this?"},
    ],
    health: [
        {icon:'🤒', text:"I'm not feeling well."},
        {icon:'🤕', text:"Something hurts and I need to tell you where."},
        {icon:'💊', text:"Have I taken my medication?"},
        {icon:'👍', text:"I'm feeling better today."},
        {icon:'🏥', text:"Do I have any appointments coming up?"},
    ],
    cooking: [
        {icon:'👨‍🍳', text:"I'd like to help with the cooking today."},
        {icon:'📖', text:"Can we try a new recipe?"},
        {icon:'👀', text:"I'd prefer to watch, if that's okay."},
        {icon:'🍪', text:"Can we bake something together?"},
    ],
    weather: [
        {icon:'☀️', text:"What's the weather like today?"},
        {icon:'🌧️', text:"I hope it doesn't rain."},
        {icon:'🧥', text:"Do I need a jacket?"},
        {icon:'🏖️', text:"It's a beautiful day — can we go outside?"},
    ],
    transport: [
        {icon:'🚗', text:"When are we leaving?"},
        {icon:'⏰', text:"I need a few more minutes before we go."},
        {icon:'💺', text:"Can I sit in my preferred spot?"},
        {icon:'🚶', text:"I'd rather walk, if possible."},
        {icon:'🎧', text:"Can I use my headphones in the car?"},
    ],
    shopping: [
        {icon:'🛒', text:"I need to buy something."},
        {icon:'👕', text:"I'd like to look at clothes."},
        {icon:'💰', text:"How much money do I have to spend?"},
        {icon:'⏰', text:"How long will we be at the shops?"},
        {icon:'🔊', text:"Can we avoid the busy times? It gets overwhelming."},
    ],
    money: [
        {icon:'💰', text:"How much pocket money do I have?"},
        {icon:'🎯', text:"I'm saving up for something."},
        {icon:'💸', text:"I'd like to buy something with my money."},
        {icon:'❓', text:"Is that expensive?"},
    ],
    time: [
        {icon:'⏰', text:"What time is it?"},
        {icon:'📅', text:"What's happening today?"},
        {icon:'⏳', text:"How long until we need to leave?"},
        {icon:'🏃', text:"Are we running late?"},
        {icon:'📋', text:"What's the plan for tomorrow?"},
    ],
    technology: [
        {icon:'📱', text:"Can I use the iPad, please?"},
        {icon:'🔋', text:"My device needs charging."},
        {icon:'🔧', text:"Something isn't working properly."},
        {icon:'📶', text:"Is the wifi working?"},
        {icon:'🎮', text:"Can I have some screen time?"},
    ],
    appearance: [
        {icon:'👕', text:"I don't know what to wear."},
        {icon:'😣', text:"These clothes don't feel comfortable."},
        {icon:'✅', text:"I'm happy with what I'm wearing."},
        {icon:'🔄', text:"I want to change my outfit."},
    ],
    holidays: [
        {icon:'🎉', text:"I'm looking forward to the holiday."},
        {icon:'🎁', text:"I have an idea for a present."},
        {icon:'🤫', text:"Can we keep the celebration small?"},
        {icon:'📋', text:"What are we doing for the holiday?"},
        {icon:'😰', text:"I'm a bit worried about the event being overwhelming."},
    ],
    math: [
        {icon:'📐', text:"I've been thinking about an interesting maths problem."},
        {icon:'💡', text:"I found a fascinating pattern I'd like to discuss."},
        {icon:'🤔', text:"I'm stuck on something and could use a different perspective."},
        {icon:'🎯', text:"I'd like to try something more challenging."},
        {icon:'📊', text:"Can we explore a new area of mathematics?"},
        {icon:'✨', text:"I discovered something elegant in my working today."},
    ],
    english: [
        {icon:'📖', text:"I'd like to discuss the book I've been reading."},
        {icon:'✍️', text:"I have an idea for a story I want to write."},
        {icon:'🤔', text:"I've been analysing a character and have some thoughts."},
        {icon:'💭', text:"I noticed an interesting literary technique."},
        {icon:'📝', text:"Can we work on my writing today?"},
    ],
    science: [
        {icon:'🔬', text:"I have a question about something scientific."},
        {icon:'💡', text:"I've been thinking about an experiment we could try."},
        {icon:'🌍', text:"I read something fascinating about the natural world."},
        {icon:'🧪', text:"Can we do a hands-on experiment?"},
    ],
    story: [
        {icon:'📚', text:"I'm ready to look at the story."},
        {icon:'🔍', text:"I want to analyse the characters."},
        {icon:'💭', text:"I have observations about the picture."},
        {icon:'🎭', text:"I can see some interesting emotions in this scene."},
        {icon:'🤔', text:"I think I understand what's motivating this character."},
        {icon:'📖', text:"Can we read the next part?"},
    ],
    school: [
        {icon:'📚', text:"I need to talk about something from school."},
        {icon:'📝', text:"I have homework I need help with."},
        {icon:'😊', text:"Something good happened at school today."},
        {icon:'😔', text:"I had a difficult day at school."},
        {icon:'📅', text:"I have a test coming up."},
        {icon:'💬', text:"Something happened with a classmate."},
    ],
    friends: [
        {icon:'👫', text:"I'd like to arrange to see a friend."},
        {icon:'💬', text:"Something happened with my friend that I want to discuss."},
        {icon:'🎉', text:"I've been invited somewhere and want to talk about it."},
        {icon:'😔', text:"I'm feeling a bit lonely."},
        {icon:'💭', text:"I'm thinking about my friendships."},
    ],
    gaming: [
        {icon:'🎮', text:"I want to tell you about my game."},
        {icon:'🏆', text:"I achieved something in my game today!"},
        {icon:'🤔', text:"I've been thinking about game strategy."},
        {icon:'👥', text:"Can I play online with my friends?"},
        {icon:'⏰', text:"Can I have more gaming time today?"},
    ],
    movies_tv: [
        {icon:'🎬', text:"Can we watch something together?"},
        {icon:'💭', text:"I want to discuss what we watched."},
        {icon:'🆕', text:"I heard about something new I'd like to watch."},
        {icon:'⭐', text:"I'd like to rewatch a favourite."},
    ],
    music: [
        {icon:'🎵', text:"Can I listen to some music?"},
        {icon:'🎶', text:"I discovered a song I really like."},
        {icon:'🔊', text:"Can we play music together?"},
        {icon:'🤫', text:"I need quiet right now — no music, please."},
    ],
    sports: [
        {icon:'⚽', text:"I'd like to do something active."},
        {icon:'📺', text:"Can we watch the game?"},
        {icon:'🏃', text:"I want to go for a walk or run."},
        {icon:'🏊', text:"Can we go swimming?"},
    ],
    pets: [
        {icon:'🐕', text:"I'd like to spend time with the pet."},
        {icon:'🦮', text:"Can I walk the dog?"},
        {icon:'🍽️', text:"I think the pet needs feeding."},
        {icon:'💭', text:"I want to talk about getting a pet."},
    ],
    feelings: [
        {icon:'😊', text:"I'm feeling good and wanted to share that."},
        {icon:'😔', text:"I'm not feeling great and I'd like to talk about it."},
        {icon:'😤', text:"I'm frustrated about something."},
        {icon:'😰', text:"I'm feeling anxious and I'm not sure why."},
        {icon:'🤗', text:"I appreciate you being here."},
        {icon:'💭', text:"I have something on my mind."},
        {icon:'😴', text:"I'm feeling overwhelmed and need a break."},
    ],
    sensory: [
        {icon:'🔊', text:"It's too loud. I need it quieter, please."},
        {icon:'💡', text:"The light is bothering me."},
        {icon:'🤢', text:"There's a smell that's making me uncomfortable."},
        {icon:'🧤', text:"Something I'm touching doesn't feel right."},
        {icon:'😵', text:"Everything is too much right now. I need space."},
        {icon:'🎧', text:"Can I use my headphones?"},
    ],
    _default: [
        {icon:'💬', text:"I'd like to talk about something."},
        {icon:'❓', text:"I have a question."},
        {icon:'💭', text:"I've been thinking about something."},
        {icon:'🆘', text:"I need help with something."},
    ],
};

// ============================================================
// CONTEXTUAL PREDICTION ENGINE V2
// Topic Clouds × Question Type → Contextual Responses
// ============================================================

// TOPIC CLOUDS — semantic word groups that trigger topic detection
const TOPIC_CLOUDS = {
    // ===== DAILY LIVING =====
    food:      ['eat','food','dinner','lunch','breakfast','snack','hungry','cook','meal','order','restaurant','menu','recipe','kitchen','fridge','pizza','pasta','chicken','rice','sandwich','noodle','soup','salad','fruit','dessert','cake','chocolate','cereal','toast','egg','cheese','bread','vegetable','meat','fish','curry','roast','bbq','takeaway','delicious','yummy','taste','hot','cold','warm','spicy','mild','sausage','steak','burger','chips','fries','nuggets','taco','sushi','ice cream','biscuit','muffin','pancake','waffle','yoghurt','banana','apple','strawberry','mango','peanut','butter','sauce','gravy','roast','casserole','stir fry','spring roll','fried rice','garlic bread','vegemite','tim tam','lamington','meat pie','pav','pavlova'],
    drink:     ['drink','thirsty','water','juice','tea','coffee','milk','cup','bottle','hot chocolate','smoothie','lemonade','cordial','sip','straw','fizzy','sparkling','warm drink','cold drink','milkshake','iced','milo','poppers'],
    hygiene:   ['shower','bath','teeth','brush','wash','clean','soap','towel','haircut','clothes','dressed','change','deodorant','shampoo','toilet','bathroom','toothbrush','toothpaste','floss','comb','hair','nails','sunscreen','face','hands'],
    transport: ['car','bus','train','drive','ride','walk','pick up','drop off','school bus','seat belt','window','trip','travel','uber','taxi','bike','scooter','tram','ferry','airplane','airport','road','traffic','parking','petrol','station','platform','ticket','fare'],
    shopping:  ['shop','buy','store','money','price','want','need','clothes','shoes','size','colour','try on','expensive','cheap','sale','pay','wallet','card','trolley','basket','aisle','checkout','receipt','online','delivery','amazon','kmart','target','woolworths','coles','aldi'],
    health:    ['doctor','dentist','medicine','pain','sick','appointment','hospital','check up','injection','needle','temperature','headache','stomach','throat','cough','flu','allergy','tablet','pill','pharmacy','nurse','ambulance','bandaid','plaster','blood','swollen','infection','rash','asthma','inhaler','prescription','specialist','therapy','therapist','OT','occupational'],
    sleep:     ['bed','sleep','tired','wake','dream','nightmare','pillow','blanket','alarm','morning','rest','nap','sleepy','yawn','stay up','bedtime','insomnia','snore','doze','drowsy','exhausted','melatonin','night light','weighted blanket','duvet'],
    chores:    ['clean','tidy','room','dishes','laundry','rubbish','vacuum','help','job','task','done','finished','pack','unpack','organise','put away','sweep','mop','wipe','fold','hang','iron','recycle','bin','garbage','dishwasher','washing machine','dryer'],
    weather:   ['rain','sun','weather','umbrella','jacket','coat','wind','storm','cloudy','sunny','forecast','degrees','temperature','humid','hail','thunder','lightning','drizzle','snow','fog','overcast','breeze','cyclone','drought','flood','rainbow','UV'],

    // ===== ROUTINES & DAILY =====
    routine:   ['morning routine','after school','before bed','bedtime routine','get ready','getting ready','next','then','first','after that','schedule','plan','what now','what next','timetable','calendar','diary','reminder','alarm','timer'],
    bathroom:  ['toilet','bathroom','need to go','busting','hurry','emergency','private','door','lock','paper','flush','wash hands','accident'],
    outings:   ['go out','going out','outing','trip','excursion','park','beach','pool','swimming pool','library','museum','zoo','aquarium','cinema','movies','mall','shopping centre','playground','cafe','picnic','bushwalk','drive','road trip','holiday'],
    waiting:   ['wait','waiting','how long','bored','when','soon','almost','nearly','patient','turn','queue','line','next','my turn','hurry up','taking forever'],
    manners:   ['please','thank you','thanks','sorry','excuse me','pardon','welcome','bless you','after you','share','turn','gentle','kind','polite','rude','interrupt'],

    // ===== ACADEMIC =====
    math:      ['math','maths','number','calculate','equation','multiply','divide','add','subtract','algebra','geometry','fraction','decimal','percent','angle','triangle','formula','theorem','proof','pattern','symmetry','graph','function','variable','pi','infinity','statistics','probability','prime','factor','square root','derivative','integral','matrix','vector','ratio','proportion','circumference','diameter','radius','area','volume','perimeter','coordinate','axis','quadratic','polynomial','logarithm','exponent','sequence','series','fibonacci','pythagoras'],
    english:   ['read','write','story','character','plot','essay','paragraph','grammar','vocabulary','sentence','author','book','chapter','poem','metaphor','analyse','theme','setting','narrative','spelling','punctuation','creative writing','describe','imagine','fiction','novel','protagonist','antagonist','conflict','resolution','dialogue','imagery','simile','alliteration','foreshadowing','symbolism','genre','biography','autobiography','memoir','literary'],
    science:   ['experiment','hypothesis','energy','force','chemical','biology','physics','atom','cell','evolution','gravity','temperature','molecule','reaction','lab','microscope','planet','solar','space','ecosystem','DNA','gene','species','habitat','photosynthesis','magnet','electricity','circuit','volcano','earthquake','fossil','dinosaur','climate','atmosphere','oxygen','carbon','periodic table','element','compound'],
    school:    ['school','class','teacher','homework','assignment','test','exam','project','grade','lesson','subject','student','study','learn','lecture','report','presentation','deadline','mark','result','assembly','excursion','canteen','playground','recess','lunchtime','roll call','principal','substitute','relief teacher','library','locker','desk','chair','whiteboard','textbook','worksheet','group work','partner'],
    reading:   ['book','reading','page','chapter','library','borrow','return','bookmark','cover','title','author','series','genre','fiction','non-fiction','comic','graphic novel','ebook','audiobook','read aloud','comprehension','fluency'],
    art:       ['draw','paint','colour','art','craft','create','design','sketch','pencil','brush','canvas','glue','scissors','paper','clay','sculpture','collage','print','stamp','pattern','creative','masterpiece','portrait','landscape','abstract'],
    homework:  ['homework','assignment','due','project','study','revision','notes','research','essay','draft','submit','deadline','extension','marks','grade','feedback','correction','practice','worksheet','textbook','online','google','reference'],

    // ===== ENTERTAINMENT & SOCIAL =====
    gaming:    ['game','play','level','score','minecraft','roblox','fortnite','controller','online','multiplayer','boss','quest','character','mod','server','pvp','build','craft','win','lose','team','strategy','pokemon','mario','zelda','switch','playstation','xbox','steam','app store','download','update','lag','glitch','cheat','hack','speedrun','walkthrough','tutorial','sandbox','RPG','FPS','puzzle game'],
    movies_tv: ['movie','film','show','watch','episode','season','actor','scene','funny','scary','boring','ending','series','netflix','disney','youtube','video','trailer','sequel','animation','cartoon','documentary','superhero','horror','comedy','drama','thriller','streaming','binge','rewatch','subtitle','dub','review','rating','plot twist','cliffhanger','finale','premiere','stan','prime video','ABC kids'],
    music:     ['song','music','listen','singer','band','playlist','lyrics','concert','instrument','guitar','piano','drum','beat','melody','album','spotify','earphones','speakers','volume','bass','rhythm','genre','pop','rock','jazz','classical','hip hop','rap','country','soundtrack','karaoke','tune','hum','sing'],
    friends:   ['friend','mate','play','invite','party','birthday','sleepover','together','hang out','visit','came over','playground','recess','lunch break','best friend','new kid','group','chat','message','facetime','play date','social','lonely','left out','included','excluded','popular','bully','mean','nice','kind'],
    pets:      ['dog','cat','pet','animal','feed','walk','vet','cute','puppy','kitten','bird','fish','hamster','rabbit','guinea pig','turtle','lizard','snake','horse','pony','collar','leash','cage','tank','litter','treat','toy','groom','bark','meow','purr'],
    sports:    ['sport','soccer','football','cricket','swim','run','basketball','tennis','kick','catch','throw','race','goal','point','match','training','coach','practice','fitness','gym','exercise','stretch','warm up','cool down','medal','trophy','competition','tournament','Olympics','AFL','NRL','league','team sport'],

    // ===== EMOTIONAL / SENSORY =====
    sensory:   ['loud','noise','smell','bright','light','touch','hurt','pain','sick','headache','dizzy','uncomfortable','itchy','scratchy','sticky','wet','dry','crowded','busy','overwhelming','flashy','flickering','buzzing','humming','scratching','rough','smooth','soft','hard','vibration','pressure','tight','loose','tag','seam','label'],
    feelings:  ['happy','sad','angry','scared','worried','excited','nervous','calm','frustrated','proud','embarrassed','lonely','bored','confused','anxious','stressed','overwhelmed','grateful','hopeful','disappointed','jealous','guilty','ashamed','surprised','shocked','relieved','content','irritated','furious','terrified','panicked','miserable','cheerful','delighted','ecstatic'],
    emotions_complex: ['conflicted','ambivalent','nostalgic','melancholy','empathetic','compassionate','resentful','insecure','vulnerable','defensive','apathetic','motivated','inspired','determined','resigned','indifferent','suspicious','trusting','regretful','appreciative','contemptuous','admiring','envious','awestruck'],

    // ===== ADDITIONAL TOPICS =====
    holidays:  ['holiday','vacation','christmas','easter','birthday','party','celebrate','present','gift','cake','special','occasion','anniversary','new year','halloween','weekend','camp','trip','adventure','travel','diwali','eid','hanukkah','ramadan','anzac','australia day','queens birthday','school holidays','long weekend','break','countdown'],
    technology:['computer','laptop','phone','tablet','ipad','app','download','internet','wifi','email','website','screen','charge','battery','broken','update','password','headphones','bluetooth','printer','mouse','keyboard','monitor','USB','cable','charger','restart','freeze','crash','slow','storage','cloud','backup','screenshot','notification','settings','dark mode','brightness','volume'],
    money:     ['money','dollar','cost','price','buy','pay','save','spend','expensive','cheap','afford','wallet','pocket money','allowance','change','coin','note','bank','ATM','card','eftpos','budget','earn','reward','gift card','online shopping','receipt','tax','discount','bargain','value'],
    cooking:   ['cook','bake','recipe','ingredient','mix','stir','oven','microwave','fridge','hot','boil','fry','chop','peel','serve','plate','bowl','spoon','fork','knife','pan','pot','saucepan','timer','temperature','degrees','rise','knead','whisk','blend','grate','marinate','season','taste test','measure','cup','tablespoon','teaspoon'],
    time:      ['time','clock','hour','minute','late','early','soon','later','tomorrow','yesterday','today','morning','afternoon','evening','night','weekend','week','month','hurry','wait','schedule','appointment','half past','quarter to','o\'clock','midnight','noon','sunrise','sunset','dawn','dusk','fortnight','term','semester','year'],
    appearance:['look','wear','shirt','pants','shoes','hat','dress','jacket','uniform','hair','glasses','bag','backpack','watch','jewellery','outfit','comfortable','smart','casual','hoodie','trackies','tracksuit','sneakers','runners','boots','thongs','singlet','shorts','skirt','beanie','scarf','gloves','belt','tie','button','zip','laces'],
    body:      ['hand','foot','leg','arm','head','face','eye','ear','nose','mouth','finger','toe','knee','elbow','shoulder','back','chest','tummy','neck','wrist','ankle','thumb','skin','bone','muscle','joint','posture','stretch','relax','tense','cramp','sore','stiff'],
    helping:   ['help','assist','support','together','team','cooperate','share','contribute','volunteer','carry','hold','open','close','reach','pick up','put down','push','pull','lift','move','fix','repair','solve','figure out'],
    choices:   ['choose','pick','decide','option','prefer','rather','instead','alternative','either','or','both','neither','first','second','which','what','compare','favourite','best','worst','better','worse','same','different'],
    learning:  ['understand','learn','know','remember','forget','think','wonder','curious','question','answer','explain','teach','show','demonstrate','example','practice','improve','progress','difficult','easy','hard','simple','complex','challenge','mistake','error','correct','try again','attempt','figure out','work out','solve'],
};

// QUESTION PATTERNS — detect what TYPE of response is needed
const QUESTION_PATTERNS = [
    // Greeting — highest priority
    {pattern:/\b(how are you|how's it going|how you going|how ya going|how've you been)\b/i, type:'greeting'},
    // Specific topic choices — very targeted
    {pattern:/\b(what.{0,15}(food|eat|dinner|lunch|breakfast|snack|hungry|meal|order|want for))\b/i, type:'food_choice'},
    {pattern:/\b(what.{0,15}(drink|thirsty|beverage|water|juice))\b/i, type:'drink_choice'},
    {pattern:/\b(what.{0,15}(want to do|like to do|activity|play|shall we))\b/i, type:'activity_choice'},
    {pattern:/\b(where.{0,15}(want to go|like to go|should we go|shall we))\b/i, type:'place_choice'},
    {pattern:/\b(what.{0,20}(buy|get|purchase|look for|looking for|shop for))\b/i, type:'buy_choice'},
    {pattern:/\b(would you like to (buy|get|shop|purchase))\b/i, type:'buy_choice'},
    {pattern:/\b(do you want to (buy|get|shop|purchase))\b/i, type:'buy_choice'},
    {pattern:/\b(what should we (buy|get|shop for))\b/i, type:'buy_choice'},
    {pattern:/\b(anything you (want|need) to (buy|get))\b/i, type:'buy_choice'},
    {pattern:/\b(what.{0,15}(wear|put on|dressed))\b/i, type:'wear_choice'},
    {pattern:/\b(what.{0,15}(watch|see|look at|movie|show|film))\b/i, type:'watch_choice'},
    {pattern:/\b(what.{0,15}(play|game|playing))\b/i, type:'play_choice'},
    {pattern:/\b(what.{0,15}(read|book|reading))\b/i, type:'read_choice'},
    // Decline / refusal — someone saying no to Ryan's request
    {pattern:/\b(i'm tired|i am tired|i'm exhausted|i'm too tired)\b/i, type:'decline'},
    {pattern:/\b(not (right )?now|maybe later|another time|not today|i can't right now)\b/i, type:'decline'},
    {pattern:/\b(i('m| am) (too )?busy|i don't have time|i('ve| have) got to)\b/i, type:'decline'},
    {pattern:/\b(we can't|we shouldn't|let's not|i'd rather not)\b/i, type:'decline'},
    {pattern:/\b(after (i |my )|when i'm done|once i've|give me a (minute|moment|sec))\b/i, type:'decline_delay'},
    // General question types
    {pattern:/\b(what would you like|what do you want|what do you feel like|what would you prefer)\b/i, type:'choice'},
    {pattern:/\b(which one|which do you|pick one|choose)\b/i, type:'choice'},
    {pattern:/\b(how was|how were|how did|how's your)\b/i, type:'review'},
    {pattern:/\b(are you ready|have you finished|did you finish|did you do)\b/i, type:'status'},
    {pattern:/\b(what do you think|what's your opinion|reckon)\b/i, type:'opinion'},
    {pattern:/\b(did you like|do you like|enjoy|favourite)\b/i, type:'preference'},
    {pattern:/\b(do you need|what do you need)\b/i, type:'need'},
    {pattern:/\b(do you want|would you like|wanna|want to)\b/i, type:'yesno'},
    {pattern:/\b(can you|could you|will you|would you)\b/i, type:'yesno'},
    {pattern:/\b(what happened|what's going on|what's up|tell me about)\b/i, type:'narrative'},
    {pattern:/\b(are you okay|you alright|you right)\b/i, type:'wellbeing'},
    {pattern:/\b(why)\b/i, type:'explanation'},
    {pattern:/\b(where|when|who)\b/i, type:'specific'},
    {pattern:/\b(is it|are they|was it|isn't|aren't|doesn't|don't|have you|has)\b/i, type:'yesno'},
];

// THE MATRIX: Topic × Question Type → Contextual Responses
// When BOTH a topic and question type are detected, this gives precise responses
const CONTEXTUAL_RESPONSES = {
    // ---- FOOD ----
    'food:food_choice':   ["Pizza, please.","Pasta would be good.","Chicken and rice.","I'd like a sandwich.","Can I have noodles?","Something warm.","Something simple.","I'm not fussy, you choose.","Whatever everyone else is having.","I'd like what I had last time.","Can I see what's available?","Soup sounds good.","Something with cheese."],
    'food:choice':        ["Hot, please.","Cold would be good.","Mild, not too spicy.","I like it spicy.","Room temperature is fine.","Warm, please.","Either is fine — I don't mind."],
    'food:choice':        ["Pizza, please.","Pasta would be good.","Something simple.","I'm not fussy, you choose.","Can I see the options?","I'd like what I had last time."],
    'food:review':        ["It was delicious.","Not my favourite.","That was really good.","It was okay.","I didn't like the texture.","Can we have that again?","It needed more flavour.","Best meal ever."],
    'food:yesno':         ["Yes please, I'm hungry.","No thanks, I'm full.","Maybe a little bit.","Just a small amount.","Not right now.","I could eat.","Yes, I'm starving."],
    'food:preference':    ["I love pizza.","I'm not a fan of that.","That's my favourite.","I prefer something different.","I like it when it's warm.","The pasta was better."],
    'food:status':        ["Yes, I've eaten.","No, not yet.","I'm still eating.","Almost finished.","I'm not hungry yet."],
    'food:opinion':       ["I think we should order pizza.","Let's try something new.","I reckon the pasta is best.","The usual would be fine."],

    // ---- DRINK ----
    'drink:drink_choice': ["Water, please.","Juice would be good.","Hot chocolate, please.","Can I have milk?","Something cold.","Something warm.","Lemonade, please."],
    'drink:choice':       ["Water, please.","Juice would be good.","Hot chocolate, please.","Something cold."],
    'drink:yesno':        ["Yes please.","No, I'm not thirsty.","Maybe later.","Just water, thanks."],

    // ---- HYGIENE ----
    'hygiene:yesno':      ["Yes, I've done it.","Not yet, give me a minute.","I need help with that.","I'll do it now.","Already done."],
    'hygiene:status':     ["Done.","Not yet.","I'm doing it now.","I need help.","Almost finished.","I forgot, I'll do it now."],
    'hygiene:choice':     ["I want a shower.","Bath, please.","I'll brush my teeth first.","Can I wash my hands?"],

    // ---- TRANSPORT ----
    'transport:choice':   ["I'd like the window seat.","Front seat, please.","I want to walk.","Can we take the car?","I'd prefer the train."],
    'transport:yesno':    ["Yes, I'm ready to go.","Not yet, give me a minute.","I need my bag first.","I don't want to go.","Can we leave soon?"],
    'transport:status':   ["I'm ready.","Almost ready.","I need five more minutes.","I can't find my shoes.","I've got everything."],
    'transport:preference':["I like the train better.","I prefer walking.","The car is more comfortable.","I don't like the bus, it's too loud."],

    // ---- SHOPPING (expanded for real shopping scenarios) ----
    'shopping:choice':     ["That one, please.","The blue one.","The bigger size.","I like this one better.","Can I try it on?","Neither, let's keep looking.","Both are good.","The one on the left.","Actually, the other one.","I want to compare them first."],
    'shopping:buy_choice': ["New clothes, please.","I need new shoes.","Something for gaming.","A book, maybe.","Art supplies.","Snacks and drinks.","Something I've been wanting for a while.","Can I look around first and decide?","Tech stuff.","I have a list — let me show you.","A present for someone.","I'm not sure yet — can we browse?","Something fun.","Stationery for school."],
    'shopping:yesno':      ["Yes, I like it.","No, it doesn't fit.","Maybe, let me think.","It's too expensive.","Can we look somewhere else?","Yes, let's get it.","No, I changed my mind.","I'm still deciding."],
    'shopping:opinion':    ["I think it looks good.","It's not really my style.","I prefer the other one.","The colour is nice.","It's too plain.","That's exactly what I wanted.","It's a good price.","I'm not convinced yet.","It's really cool, actually."],
    'shopping:preference': ["I like the blue one.","That style is cool.","I prefer something simpler.","I don't like how it feels.","I prefer bigger.","The darker colour is better.","I want the one we saw earlier.","I'd rather get the other brand."],
    'shopping:need':       ["New shoes — mine are worn out.","School supplies.","A new bag.","Clothes that actually fit.","Something for my room.","Headphones.","I need a charger.","Toiletries.","A birthday gift.","Nothing specific, just looking."],
    'shopping:review':     ["I really like what we got.","Good shopping trip.","I wish we'd found what I wanted.","Can we come back another day?","That was fun.","I'm happy with my choices.","Next time I want to try a different store."],
    'shopping:status':     ["I've found what I want.","Still looking.","Not yet, give me more time.","I'm ready to pay.","I can't decide.","I think I'm done.","One more thing to find."],
    'shopping:specific':   ["Over in the electronics section.","I saw it online at Kmart.","It was near the front of the store.","On the top shelf.","In the other aisle.","I think they have it at Target.","Let me check on my phone."],
    'shopping:explanation':["Because the old one is broken.","I've been wanting this for ages.","It's for a school project.","My friend has one and it's really good.","I outgrew the last one.","It's a better quality one.","Because I saved my money for it."],

    // ---- OUTINGS (going places) ----
    'outings:choice':      ["The park.","The beach sounds great.","Can we go to the library?","The shopping centre.","Let's go to the movies.","The pool would be fun.","I'd like to go to the museum.","A cafe would be nice.","Somewhere quiet."],
    'outings:place_choice':["The park.","Beach, definitely.","Can we go shopping?","The library.","I want to go to the movies.","Somewhere new.","The usual place.","Anywhere with food.","Somewhere not too crowded."],
    'outings:yesno':       ["Yes, I'd love to go!","Not today, I'm tired.","Maybe later?","Can we go after lunch?","Definitely, I've been wanting to.","I'm not in the mood.","Only if it's not too crowded."],
    'outings:preference':  ["I prefer indoor places.","I like the beach.","Somewhere with not too many people.","I enjoy going to new places.","I'd rather stay close to home."],
    'outings:opinion':     ["That sounds like fun.","I'm not sure about that.","Great idea!","Can we do something else instead?","I've always wanted to go there."],

    // ---- TECHNOLOGY ----
    'technology:choice':   ["My iPad.","Can I use the computer?","I want to use my phone.","The Switch.","Can I download an app?","I need the laptop for homework."],
    'technology:yesno':    ["Yes, it's working now.","No, it's still broken.","I think so.","Not yet — it needs to update.","It's charging.","The WiFi isn't working."],
    'technology:status':   ["It's charged.","The battery is low.","It's updating.","It crashed.","It's working fine.","I can't log in.","The app won't open."],
    'technology:need':     ["I need a new charger.","The screen is cracked.","I need more storage.","New headphones.","Can I get a case for it?","I need to update the software."],
    'technology:opinion':  ["This app is really good.","It's too slow.","The new update is better.","I prefer the old version.","The graphics are amazing.","It keeps crashing — it's frustrating."],

    // ---- APPEARANCE / CLOTHES ----
    'appearance:choice':    ["The blue shirt.","My hoodie.","Something comfortable.","The new ones.","My favourite outfit.","Whatever's clean.","Something warm."],
    'appearance:wear_choice':["My hoodie.","The blue shirt.","Something comfortable.","The new ones.","Trackies and a t-shirt.","My favourite jumper.","Something warm.","Does it matter?"],
    'appearance:yesno':     ["Yes, I'm dressed.","Not yet.","These are fine.","No, I want to change.","Is this okay?","I need something warmer."],
    'appearance:opinion':   ["I like this outfit.","It's uncomfortable.","The colour's nice.","It doesn't fit properly.","I look good in this.","It's itchy."],
    'appearance:preference':["I prefer comfortable clothes.","I like dark colours.","Hoodies are the best.","I don't like tight things.","Soft fabric is important."],

    // ---- ROUTINE ----
    'routine:status':      ["Done.","Almost.","I haven't started yet.","In progress.","Give me a minute.","I forgot — doing it now.","What's next?"],
    'routine:yesno':       ["Yes, I've done it.","Not yet.","I'm doing it now.","Can I skip it today?","Already done.","Do I have to?"],
    'routine:choice':      ["Shower first.","Breakfast first, please.","Can I check my phone first?","Teeth first.","I want to get dressed first."],
    'routine:specific':    ["After breakfast.","Before school.","I do it every morning.","That's part of my evening routine.","I usually do it after dinner."],

    // ---- WAITING ----
    'waiting:yesno':       ["I can wait.","How much longer?","I'm getting bored.","This is taking forever.","I'm being patient.","Can we do something while we wait?"],
    'waiting:status':      ["Still waiting.","I've been waiting ages.","It shouldn't be much longer.","I'm okay for now.","Getting impatient, honestly."],
    'waiting:opinion':     ["This is boring.","I don't mind waiting.","Can I do something while I wait?","I wish it was faster."],

    // ---- HOMEWORK ----
    'homework:status':     ["Done.","Nearly finished.","I haven't started.","It's hard — I need help.","Halfway through.","I forgot about it.","Submitted already."],
    'homework:yesno':      ["Yes, I've done it.","No, not yet.","I need help first.","Can I do it later?","Almost — just one more question."],
    'homework:opinion':    ["It's too easy.","It's quite challenging.","The topic is interesting.","I don't understand the question.","I'd prefer a harder problem.","This is boring."],
    'homework:need':       ["Help with question 3.","A calculator.","My textbook.","More time.","Someone to explain it.","A quiet space to work."],

    // ---- FRIENDS / SOCIAL ----
    'friends:yesno':       ["Yes, I'd like to see them.","Not today.","Maybe on the weekend?","Can they come here?","I'll message them.","I'm not sure."],
    'friends:review':      ["It was fun.","We had a great time.","It was okay.","I wish we could hang out more.","We played games the whole time.","It was a bit awkward."],
    'friends:opinion':     ["They're really nice.","I like hanging out with them.","We have a lot in common.","I don't know them well yet.","They understand me."],
    'friends:narrative':   ["We played games together.","We talked about school.","They showed me something cool.","We had an argument but it's fine now.","Nothing much happened."],

    // ---- FEELINGS (emotional check-ins) ----
    'feelings:wellbeing':  ["I'm doing okay.","Not the best day.","I'm actually feeling good.","A bit anxious.","I'm happy right now.","Tired but okay.","Frustrated about something.","I'd rather not talk about it."],
    'feelings:yesno':      ["Yes, I'm fine.","Not really.","I think so.","I will be.","Kind of.","Better than yesterday."],
    'feelings:explanation':["I'm not sure why.","Something happened at school.","I'm just tired.","I've been thinking about something.","It's complicated.","I don't want to talk about it right now.","Everything built up."],
    'feelings:narrative':  ["I had a tough day.","Something good happened.","I'm worried about tomorrow.","I've been thinking a lot.","Nothing specific — just a feeling."],

    // ---- PETS ----
    'pets:yesno':          ["Yes, I fed them.","Not yet.","I'll do it now.","They've already been walked.","Can I play with them first?"],
    'pets:status':         ["Fed and happy.","They need walking.","They're being naughty.","They're sleeping.","They need water."],
    'pets:opinion':        ["They're so cute.","I love them.","They're being really funny today.","I think they're hungry.","They seem happy."],

    // ---- HOLIDAYS ----
    'holidays:preference': ["The beach.","Somewhere cold.","Camping would be fun.","A city holiday.","Anywhere with good food.","Somewhere I haven't been."],
    'holidays:choice':     ["Beach holiday.","Theme park.","Camping.","Visiting family.","Road trip.","Staying home is okay too."],
    'holidays:yesno':      ["Yes, I'm excited!","Can't wait.","I'm a bit nervous actually.","I need to pack.","I hope the weather's good."],
    'holidays:opinion':    ["Best holiday ever.","It was relaxing.","I wish we could stay longer.","The food was amazing.","I want to go back."],

    // ---- MONEY ----
    'money:status':        ["I have enough saved.","I'm still saving.","I need more.","I spent it already.","I have some left."],
    'money:yesno':         ["Yes, I can afford it.","No, it's too expensive.","Maybe if I save more.","I have my own money.","Can you help me pay?"],
    'money:opinion':       ["That's a fair price.","Too expensive.","It's a good deal.","Worth saving for.","I should save instead."],

    // ---- COOKING ----
    'cooking:choice':      ["Can I help stir?","I want to measure the ingredients.","Let me crack the eggs.","I'll watch for now.","Can I taste test?"],
    'cooking:yesno':       ["Yes, I want to help.","Not right now.","After I wash my hands.","Can I just watch?","Sure, what do you need me to do?"],
    'cooking:opinion':     ["It smells amazing.","I think it needs more salt.","It looks ready.","Not done yet.","This is fun."],

    // ---- LEARNING ----
    'learning:yesno':      ["Yes, I understand.","Not quite.","Can you explain it differently?","I think so.","Almost — one more time?","That makes sense now."],
    'learning:status':     ["I get it now.","Still confused.","Getting there.","I need more practice.","I've mastered it.","Can we move on?"],
    'learning:opinion':    ["This is interesting.","It's harder than I expected.","I like this approach.","The visual explanation helped.","I prefer working it out myself."],
    'learning:need':       ["A different explanation.","More time.","An example.","A hint, not the answer.","To try it myself.","A quieter space to think."],

    // ---- HEALTH ----
    'health:yesno':       ["Yes, it hurts.","No, I'm feeling okay.","A little bit.","It's getting better.","It's getting worse."],
    'health:specific':    ["My head hurts.","My stomach doesn't feel right.","My throat is sore.","I feel dizzy.","I feel nauseous."],
    'health:status':      ["I took my medicine.","Not yet.","I'm feeling better.","Still not great.","The pain is a 6 out of 10."],
    'health:wellbeing':   ["I'm not feeling well.","I'm okay, just tired.","Something doesn't feel right.","I think I need to rest.","Can I see a doctor?"],

    // ---- SLEEP ----
    'sleep:yesno':        ["Yes, I'm tired.","No, I'm not sleepy yet.","Can I stay up a bit longer?","I'm exhausted.","Five more minutes."],
    'sleep:status':       ["I slept well.","I didn't sleep well.","I had a nightmare.","I woke up early.","I'm still tired."],
    'sleep:review':       ["I slept really well.","It was a rough night.","I had weird dreams.","I couldn't fall asleep.","Best sleep in ages."],

    // ---- CHORES ----
    'chores:status':      ["Done.","Not yet.","I'm working on it.","I need help.","Almost finished.","I forgot.","Do I have to?"],
    'chores:yesno':       ["Yes, it's done.","No, I haven't started.","I'll do it now.","Can I do it later?","I need help with this one."],

    // ---- WEATHER ----
    'weather:opinion':    ["I love this weather.","It's too hot.","It's too cold.","I hope it doesn't rain.","Perfect day to go outside."],

    // ---- MATHS (Ryan's passion — responses reflect advanced understanding) ----
    'math:opinion':       ["That theorem is genuinely fascinating.","I can see an elegant pattern emerging here.","That's a remarkably elegant solution.","This reminds me of a similar problem — there's a connection.","I think there's a more efficient method.","The proof is beautiful in its simplicity.","The symmetry here is extraordinary.","I'd approach it differently, actually."],
    'math:review':        ["I found that problem genuinely stimulating.","It was challenging, which is exactly what I wanted.","I solved it using a different approach entirely.","That was too straightforward — I'd like something harder.","I need more time to fully explore the implications.","The patterns within the solution were fascinating.","I had an insight halfway through that changed my approach."],
    'math:status':        ["I've completed the problems.","Still working through it — the logic is intricate.","I'm stuck on one particular step.","I'd appreciate a hint, if possible.","I've found the solution — and it's elegant.","Let me verify my working first.","Almost there — I can see the pattern forming."],
    'math:explanation':   ["I identified a recurring pattern.","I applied the formula, but then found a shortcut.","I worked backwards from the conclusion.","Let me walk you through my reasoning.","I tried an alternative approach that proved more efficient.","It applies the same principle we explored previously.","The key insight is in the underlying structure."],
    'math:preference':    ["Algebra is my absolute favourite — the patterns are extraordinary.","I find geometry deeply satisfying.","Number theory is endlessly fascinating.","I prefer complex problem-solving over routine calculations.","Pattern recognition is where the real beauty lies.","I'm particularly drawn to proofs."],
    'math:choice':        ["Algebra, definitely.","I'd like to explore geometry today.","Something genuinely challenging, please.","Can we investigate patterns?","I want to attempt something beyond my current level.","Proof-based work would be excellent."],
    'math:yesno':         ["Yes, I understand the concept completely.","Not entirely — could you elaborate on that step?","I think so, but I'd like to verify.","Almost — give me a moment to process.","Yes, that makes perfect sense now.","I understand the principle, but not the application."],

    // ---- ENGLISH / STORIES (Ryan's authorship dreams) ----
    'english:opinion':    ["The character development is remarkably nuanced.","The plot twist was genuinely unexpected — I didn't see it coming.","The writing style is quite engaging.","That metaphor works on multiple levels.","I think the underlying theme is about belonging and identity.","The author's word choice is deliberately evocative.","There's a parallel structure here that's quite sophisticated."],
    'english:review':     ["I thoroughly enjoyed it — the narrative was compelling.","The ending was surprising but satisfying.","It challenged my perspective, which I appreciate.","Some passages were confusing, but deliberately so, I think.","I'd like to read more by this author.","The dialogue felt authentic and revealing.","The imagery was vivid and purposeful."],
    'english:preference': ["I'm drawn to fiction with complex characters.","Stories with unexpected plot twists captivate me.","I appreciate descriptive, evocative writing.","Poetry has an interesting economy of language.","I prefer characters with genuine psychological depth.","I find unreliable narrators fascinating."],
    'english:choice':     ["I'd like to read fiction today.","Can we analyse this particular passage?","I'd like to work on my own writing.","Let's discuss the characters' motivations.","I want to explore the narrative structure."],
    'english:status':     ["I've finished reading it — I have thoughts.","I'm approximately halfway through.","I haven't started yet, but I'm keen to.","I need more time to properly absorb it.","I've drafted the first paragraph.","I'm revising what I've written."],

    // ---- SCIENCE ----
    'science:opinion':    ["That experiment was genuinely fascinating.","The hypothesis is logical and testable.","I think the results reveal an interesting pattern.","The underlying theory is elegant.","I'd like to test a different variable.","The methodology could be more rigorous."],
    'science:review':     ["The experiment yielded unexpected results.","The results were surprising — I need to reconsider my hypothesis.","I learned something that challenged my assumptions.","It was more complex than I initially anticipated.","The data tells an interesting story."],
    'science:yesno':      ["Yes, I grasp the concept.","Not entirely — could you explain the mechanism?","I think I understand the principle.","That's logical, yes.","I understand the theory but I'm uncertain about the application."],

    // ---- SCHOOL (practical but still Ryan's voice) ----
    'school:status':      ["I've completed my homework.","Not yet, I'm afraid.","Almost finished — just one more section.","I could use some help with the last part.","I forgot about it, honestly.","It's due tomorrow — I'll prioritise it.","I've submitted it already."],
    'school:review':      ["It was a productive day, actually.","School was adequate.","I had a challenging day.","The lesson was genuinely engaging.","I learned something fascinating.","It was rather unstimulating today, honestly.","The best part was the discussion."],
    'school:opinion':     ["I thought the teacher explained it quite effectively.","The assignment is actually quite interesting.","I'm not entirely sure about the topic.","I'd rather be working on mathematics.","The project has real potential.","The approach could be more rigorous."],
    'school:yesno':       ["Yes, we have homework due.","No, nothing pending.","I believe so, but I'd need to check.","I'm not entirely certain.","Yes, I feel prepared for the test.","No, I'd benefit from additional study time."],
    'school:preference':  ["Mathematics is undoubtedly my strongest subject.","I find science increasingly interesting.","English is growing on me.","I work more effectively independently.","Collaborative work can be surprisingly productive."],

    // ---- GAMING ----
    'gaming:review':      ["That was an amazing play!","I almost beat the level.","The game is really challenging.","I discovered something new.","That boss was so hard.","My best score ever."],
    'gaming:choice':      ["Minecraft.","Roblox.","Something multiplayer.","I want to try something new.","Let's play what we played last time.","Can I pick?"],
    'gaming:opinion':     ["This game has great strategy.","The graphics are impressive.","The storyline is interesting.","It's too repetitive.","The puzzle design is clever."],
    'gaming:yesno':       ["Yeah, let's play!","Not right now.","Maybe after dinner.","Can I finish this level first?","One more game?","I'm done for now."],
    'gaming:preference':  ["I like strategy games best.","Building games are my favourite.","I prefer single player.","Multiplayer is more fun."],

    // ---- MOVIES/TV ----
    'movies_tv:review':   ["It was brilliant.","A bit boring.","The ending was unexpected.","Really funny.","Too scary for me.","I want to watch the next one.","The special effects were amazing."],
    'movies_tv:choice':   ["Something funny.","Can we watch a documentary?","I want to watch that new one.","Something we haven't seen.","Put on what you want.","Can I pick?"],
    'movies_tv:opinion':  ["The acting was really good.","The story was predictable.","I liked the main character.","The cinematography was beautiful.","It made me think."],
    'movies_tv:yesno':    ["Yeah, let's watch something.","Not right now.","Can we finish the one from yesterday?","Is it appropriate?","I'd rather play a game."],
    'movies_tv:preference':["I like comedies.","Documentaries are fascinating.","Animation is underrated.","I prefer films to shows.","Sci-fi is the best genre."],

    // ---- FRIENDS ----
    'friends:yesno':      ["Yeah, sounds fun!","I'm not sure about that.","Will it be loud?","Who else is going?","Can I think about it?","Maybe another time.","Yes, I'd love to!"],
    'friends:review':     ["It was great seeing everyone.","I had fun.","I got a bit overwhelmed.","I wish we could do it more.","It was nice but tiring.","Best time ever."],
    'friends:choice':     ["Can I invite a few friends?","Just close friends.","I'd rather one-on-one.","Everyone can come."],
    'friends:opinion':    ["They're really nice.","I feel comfortable around them.","I think they understand me.","Sometimes it's hard to keep up."],

    // ---- SPORTS ----
    'sports:review':      ["That was a great game.","I played well today.","We won!","We lost, but it was fun.","I'm tired from training.","I improved my technique."],
    'sports:yesno':       ["Yeah, I want to play.","Not today, I'm tired.","Can I watch instead?","Let me warm up first."],
    'sports:preference':  ["I like swimming best.","Cricket is fun.","I prefer watching to playing.","Individual sports suit me better."],

    // ---- PETS ----
    'pets:yesno':         ["Yes, I fed them.","No, not yet.","Can I walk the dog?","I want to play with them."],
    'pets:review':        ["They were so cute today.","The dog was really energetic.","They seem happy.","I think they need food."],

    // ---- FEELINGS (catch-all for emotional questions) ----
    'feelings:wellbeing': ["I'm doing okay.","Not great today.","I'm feeling a bit off.","I'm happy right now.","I need some space.","I'm working through something."],
    'feelings:review':    ["Today was good.","It's been a tough day.","I'm feeling better now.","Mixed feelings.","Better than yesterday."],
    'feelings:explanation':["I'm not sure why I feel this way.","Something happened earlier.","It's been building up.","I think I'm just tired.","It's hard to explain."],

    // ---- SENSORY ----
    'sensory:wellbeing':  ["The noise level is genuinely uncomfortable.","It's far too bright in here.","I need my headphones, please.","Can we relocate somewhere quieter?","I need a break from this sensory input."],
    'sensory:yesno':      ["Yes, it's quite bothering me.","No, I'm managing.","Somewhat, but it's tolerable.","It's getting progressively worse.","I can cope for now."],

    // ---- HOLIDAYS / EVENTS ----
    'holidays:review':    ["I had a genuinely wonderful time.","It was a bit overwhelming, to be honest.","The best part was being with everyone.","I enjoyed it more than I expected.","I found the crowds a bit much.","It was a memorable experience."],
    'holidays:yesno':     ["Yes, I'm looking forward to it.","I'm a bit nervous, actually.","I hope it won't be too loud.","That sounds like a great plan.","Can we have a quiet space available?"],
    'holidays:choice':    ["I'd like a quiet celebration.","Something special but not too big.","Can we keep it small?","I'd enjoy an outing.","Something at home would be nice."],
    'holidays:preference':["I prefer smaller gatherings.","I enjoy the traditions.","The food is my favourite part.","I like giving presents more than receiving them."],

    // ---- TECHNOLOGY ----
    'technology:status':  ["It's fully charged.","The battery is running low.","It's not working properly.","I need the wifi password.","The app needs updating.","It's frozen — I need help."],
    'technology:yesno':   ["Yes, it's working.","No, there's a problem.","I think so, but I'm not sure.","It was working earlier.","Can you help me fix it?"],
    'technology:choice':  ["I'd like to use the iPad.","Can I use the computer?","I need my headphones.","The tablet, please."],
    'technology:opinion': ["This app is really well-designed.","The interface could be more intuitive.","That's a useful feature.","I think it needs an update."],

    // ---- MONEY ----
    'money:yesno':        ["Yes, I can afford it.","No, it's too expensive.","I'd need to save up for that.","I have enough pocket money.","I'm not sure — how much is it?"],
    'money:opinion':      ["I think that's good value.","It seems overpriced.","I'd rather save my money.","It's worth the investment."],
    'money:choice':       ["The cheaper option is fine.","I'd prefer the better quality one.","Can I think about it?","I'd rather save for something else."],

    // ---- COOKING ----
    'cooking:yesno':      ["Yes, I'd like to help cook.","Not today, thanks.","Can I stir?","I'd prefer to watch.","Is it ready yet?"],
    'cooking:status':     ["It's almost ready.","I've finished my part.","I need help with this step.","The oven is preheated.","I'm still preparing."],
    'cooking:choice':     ["I'd like to make pasta.","Can we bake something?","Something straightforward, please.","I want to try the recipe we saw."],

    // ---- TIME / SCHEDULING ----
    'time:status':        ["I'm ready.","I need more time.","I'm running a bit behind.","I've got plenty of time.","I'll be ready shortly."],
    'time:yesno':         ["Yes, I know what time it is.","No, what time is it?","I think we're running late.","There's still time.","We should leave soon."],
    'time:specific':      ["What time do we need to leave?","How long will it take?","When is it happening?","How much time do I have?"],

    // ---- APPEARANCE / CLOTHES ----
    'appearance:choice':  ["The blue shirt.","Something comfortable.","My favourite outfit.","Whatever's clean.","Can I wear casual clothes?","The hoodie and trackies.","Something warm.","Something cool."],
    'appearance:yesno':   ["Yes, I'm dressed.","Not yet — I'm choosing.","These clothes feel uncomfortable.","I like this outfit.","Does this look okay?"],
    'appearance:opinion': ["I think this looks good.","I'm not comfortable in this.","I prefer something more casual.","The fabric feels strange.","This tag is scratching me."],

    // ---- ROUTINE ----
    'routine:status':     ["I've done everything.","I still need to brush my teeth.","I'm running behind.","Almost ready.","What's next on the list?"],
    'routine:yesno':      ["Yes, I've done it all.","Not yet.","I forgot one thing.","Can I skip that today?","I need a reminder."],
    'routine:specific':   ["What do I need to do next?","What time is my appointment?","When do we need to leave?","What's the plan for today?"],

    // ---- BATHROOM ----
    'bathroom:yesno':     ["Yes, I need the bathroom.","Not right now.","It's urgent.","I'm done.","Can I have some privacy?"],
    'bathroom:status':    ["I need to go now.","I'm finished.","I need help.","Can you wait for me?"],

    // ---- OUTINGS ----
    'outings:choice':     ["The park would be nice.","Can we go to the beach?","I'd like to go to the library.","The pool, please.","Somewhere quiet.","The cinema would be fun."],
    'outings:yesno':      ["Yes, I'd love to go.","I'd rather stay home.","Maybe, if it's not too crowded.","That sounds fun.","Will it be noisy?","Can I bring my headphones?"],
    'outings:review':     ["That was a genuinely enjoyable outing.","It was fun but tiring.","I'd like to go back.","It was a bit overwhelming.","Best outing in a while."],
    'outings:opinion':    ["I think the park is the best option.","The beach might be too crowded.","The library is always a good choice.","I'd prefer somewhere with fewer people."],

    // ---- WAITING ----
    'waiting:status':     ["I'm still waiting.","How much longer?","I'm getting bored.","I can wait a bit more.","Is it my turn yet?"],
    'waiting:yesno':      ["Yes, I can wait.","No, I need it now.","I'm trying to be patient.","How much longer will it be?"],

    // ---- READING ----
    'reading:review':     ["I thoroughly enjoyed it.","The story was compelling.","I couldn't put it down.","The characters felt real.","The ending was unexpected."],
    'reading:preference': ["I prefer fiction with complex plots.","Non-fiction can be genuinely fascinating.","I love a good mystery.","I like books that challenge my thinking."],
    'reading:status':     ["I've finished it.","I'm about halfway through.","Just started — it's promising.","I need to return it to the library."],
    'reading:choice':     ["Something with a good plot.","A series I can get into.","Non-fiction about science or maths.","A classic I haven't read yet."],

    // ---- ART ----
    'art:choice':         ["I'd like to draw.","Can we paint?","I want to work with clay.","Something creative with paper.","Can I design something on the iPad?"],
    'art:review':         ["I'm quite pleased with how it turned out.","It didn't go as planned, but that's alright.","I think the colours work well together."],
    'art:opinion':        ["I think art is genuinely therapeutic.","I find the creative process interesting.","It's harder than it looks."],

    // ---- HOMEWORK ----
    'homework:status':    ["I've finished everything.","Still working on it.","I'm stuck on one question.","I need help with the last part.","Almost done — one more to go."],
    'homework:yesno':     ["Yes, it's all done.","No, I still have more.","I have a deadline tomorrow.","Yes, but I'm not confident about it."],
    'homework:opinion':   ["The assignment is actually interesting.","It's quite challenging.","I think I did well.","I'm not sure about my answer."],
    'homework:explanation':["I used a different method.","The instructions weren't clear.","I based it on what we learned in class.","I approached it from an unusual angle."],

    // ---- BODY ----
    'body:specific':      ["My head hurts.","My legs are sore.","My back is stiff.","My hands are tired.","My eyes feel strained."],
    'body:status':        ["I'm feeling physically okay.","I'm a bit stiff today.","My muscles are tired.","I need to stretch."],

    // ---- HELPING ----
    'helping:yesno':      ["Yes, I'd like to help.","Not right now, thanks.","I can try.","Can someone help me instead?"],
    'helping:choice':     ["I'll carry that.","I can hold the door.","Let me help with the dishes.","I'll tidy up."],

    // ---- CHOICES ----
    'choices:choice':     ["The first option.","The second one, I think.","Can I see both again?","I don't have a strong preference.","Neither — is there a third option?"],
    'choices:opinion':    ["I think option A is better.","Option B has more potential.","They're both reasonable.","It depends on the criteria."],

    // ---- LEARNING ----
    'learning:status':    ["I understand it now.","I'm still processing.","I need it explained differently.","I've grasped the concept.","Can you show me again?"],
    'learning:yesno':     ["Yes, I understand.","Not quite yet.","Almost — one more explanation?","I think so."],
    'learning:opinion':   ["I find this genuinely interesting.","It's more complex than I expected.","I prefer learning by doing.","The visual explanation helped."],
    'learning:explanation':["I worked it out by finding the pattern.","I used a method from a previous lesson.","It clicked when I saw the example.","Let me explain my reasoning."],

    // ---- EMOTIONS COMPLEX ----
    'emotions_complex:wellbeing':  ["I'm feeling conflicted about something.","I have mixed emotions right now.","I'm feeling quite vulnerable today.","I'm inspired and want to channel that."],
    'emotions_complex:explanation':["It's a complicated feeling to articulate.","I think I'm processing multiple emotions simultaneously.","Part of me feels one way, part another.","The feeling is nuanced — not simply good or bad."],
    'emotions_complex:yesno':     ["Yes, I'm feeling a lot right now.","Not really — I'm fairly neutral.","A bit, but I can manage.","I'm not sure how to answer that."],
    'emotions_complex:choice':    ["I'd like to talk about it.","I'd rather process it quietly.","Can we do something to distract me?","I need to write it down."],
    'emotions_complex:preference':["I prefer to work through feelings privately.","Talking helps me process things.","I find writing about emotions easier than speaking.","I'd rather not dwell on it."],
    'emotions_complex:opinion':   ["I think emotions are more complex than people assume.","I believe it's important to acknowledge difficult feelings.","I think there's value in sitting with discomfort.","I reckon most people oversimplify how they feel."],
    'emotions_complex:status':    ["I'm working through it.","I feel better than earlier.","Still processing.","I've reached some clarity, actually.","It comes and goes in waves."],
    'emotions_complex:review':    ["That conversation actually helped.","I feel like I understand myself better now.","It was hard but worthwhile.","I'm glad I expressed that."],

    // ---- MANNERS ----
    'manners:yesno':      ["Yes, please.","No, thank you.","That's very kind of you.","I'd appreciate that.","Excuse me, could I have a moment?"],
    'manners:choice':     ["I'd like that one, please.","Either would be fine, thank you.","May I have the first option?","I'll take whichever is easier."],
    'manners:preference': ["I prefer when people ask before helping.","I appreciate directness.","I value patience.","I prefer to say things in my own time."],
    'manners:opinion':    ["I think kindness costs nothing.","Respect goes both ways.","I believe everyone deserves politeness.","Good manners reflect character."],
    'manners:status':     ["I've said thank you.","I need to apologise for something.","I remembered to ask politely.","I should write a thank-you note."],
    'manners:review':     ["That was a really kind thing to do.","I appreciated how patient they were.","People were very understanding.","That interaction went well."],

    // ---- APPEARANCE (fill gaps) ----
    'appearance:status':  ["I'm dressed and ready.","Still deciding what to wear.","I need to change — this isn't comfortable.","I'm happy with this outfit."],
    'appearance:review':  ["I liked what I wore today.","That outfit wasn't comfortable.","I got compliments on my clothes.","I should have worn something warmer."],
    'appearance:preference':["I prefer comfortable clothes over fashionable.","I like dark colours.","Soft fabrics are important to me.","I don't like tight clothing.","Hoodies are my go-to."],

    // ---- ART (fill gaps) ----
    'art:yesno':          ["Yes, I'd love to do art.","Not right now.","Maybe later — I need the right mood.","Can I choose what to make?"],
    'art:preference':     ["I prefer drawing to painting.","Digital art is fascinating.","I like working with bold colours.","I enjoy detailed, precise work.","Abstract art intrigues me."],
    'art:status':         ["I'm still working on it.","It's finished — what do you think?","I need more time.","I'm happy with how it's going.","I want to start over."],

    // ---- BATHROOM (fill gaps) ----
    'bathroom:choice':    ["I need the bathroom now.","Can I go after this?","I'll be quick.","Is there one nearby?"],
    'bathroom:preference':["I prefer privacy.","I don't need help.","I'd rather use the one that's less busy.","Can I go alone?"],
    'bathroom:opinion':   ["I think I should go now before it's too late.","The bathroom is too far away.","I don't want to interrupt, but I need to go."],
    'bathroom:review':    ["I feel better now.","That took longer than expected.","I'm ready to continue."],

    // ---- BODY (fill gaps) ----
    'body:yesno':         ["Yes, something hurts.","No, I'm physically fine.","A bit — my muscles are stiff.","It's getting better.","I think I need to rest."],
    'body:choice':        ["I need to sit down.","Can I stretch?","I'd like some paracetamol.","A hot water bottle would help.","I need to lie down."],
    'body:preference':    ["I prefer sitting to standing.","I need to move around regularly.","I like stretching.","I'd rather rest than push through."],
    'body:opinion':       ["I think I've been sitting too long.","I reckon I need more exercise.","My body is telling me to rest.","I think the pain is from tension."],
    'body:review':        ["I feel much better after moving.","The rest really helped.","My body feels good today.","Yesterday was rough physically."],

    // ---- CHOICES (fill gaps) ----
    'choices:yesno':      ["Yes, I've decided.","No, I need more time.","I think so, but I'm not 100% sure.","I'm leaning towards yes."],
    'choices:preference': ["I prefer having fewer options.","I like weighing the pros and cons.","I'd rather someone else decide.","I prefer to take my time with decisions."],
    'choices:status':     ["I've made my choice.","Still thinking it through.","I'm torn between two options.","I need more information before deciding."],
    'choices:review':     ["I'm happy with my decision.","I think I chose well.","I might have picked the other one.","No regrets."],

    // ---- CHORES (fill gaps) ----
    'chores:choice':      ["I'll do the dishes.","I can tidy my room.","Can I do the easier one?","I'd prefer to vacuum.","Let me help with cooking instead."],
    'chores:preference':  ["I prefer tidying to cleaning.","I don't mind doing dishes.","I'd rather do it in the morning.","I like having a checklist."],
    'chores:opinion':     ["I think we should take turns fairly.","That chore is harder than it looks.","I reckon a schedule would help.","I don't think that's my responsibility."],
    'chores:review':      ["All done — that was satisfying.","It took longer than expected.","The house looks much better now.","I did a good job, I think."],

    // ---- COOKING (fill gaps) ----
    'cooking:preference': ["I prefer baking to cooking.","I like simple recipes.","I enjoy measuring ingredients precisely.","I prefer sweet over savoury.","I like cooking when there's no time pressure."],
    'cooking:opinion':    ["I think this recipe looks good.","It needs more seasoning.","The presentation matters.","I reckon we should try something new."],
    'cooking:review':     ["That turned out really well.","It didn't taste quite right.","The best thing I've helped make.","We should make that again.","I burned my part — but I learned from it."],

    // ---- DRINK (fill gaps) ----
    'drink:preference':   ["I prefer cold drinks.","Water is my go-to.","I like hot chocolate in winter.","I don't like fizzy drinks much.","Juice is refreshing."],
    'drink:opinion':      ["This tastes really good.","It's a bit too sweet.","I think I prefer the other one.","The temperature is perfect."],
    'drink:status':       ["I've finished my drink.","I need a refill.","I'm still drinking.","I haven't started yet.","Almost done."],
    'drink:review':       ["That was refreshing.","I didn't like the taste.","Best hot chocolate ever.","I should drink more water."],

    // ---- ENGLISH (fill gaps) ----
    'english:yesno':      ["Yes, I've read it.","Not yet — I need more time.","I'm working through it now.","Yes, and I have some thoughts on it.","I understand the main themes."],

    // ---- FEELINGS (fill gaps) ----
    'feelings:choice':    ["I'd like to talk about it.","I'd rather be distracted.","Can we go somewhere quiet?","I want to write about it.","I'd like to be alone for a bit."],
    'feelings:preference':["I prefer to express feelings through writing.","I process emotions better alone.","I like it when people just listen without advice.","I prefer calm environments when I'm emotional."],
    'feelings:opinion':   ["I think feelings deserve to be taken seriously.","I believe everyone processes emotions differently.","I reckon it's healthy to acknowledge how you feel.","Emotions aren't weaknesses — they're information."],
    'feelings:status':    ["I'm feeling okay right now.","I'm in a good mood today.","I've been feeling off all day.","I'm gradually feeling better.","I'm not sure how I feel yet."],

    // ---- FRIENDS (fill gaps) ----
    'friends:preference': ["I prefer one-on-one catchups.","I like friends who understand me.","I'd rather meet somewhere quiet.","I prefer online gaming together to meeting in person sometimes."],
    'friends:status':     ["I've messaged them.","I haven't heard back yet.","We made plans for next week.","I'm looking forward to seeing them.","We haven't talked in a while."],

    // ---- GAMING (fill gaps) ----
    'gaming:status':      ["I'm in the middle of a level.","I'm almost done.","I just started — give me a few minutes.","I've been playing for a while.","Save point reached — I can stop now."],
    'gaming:decline':     ["Okay, can I play by myself then?","What about a quick game?","Maybe we can play something easier?","Can I play on my own?","What if I teach you a simple one?","That's fine — I'll play solo."],
    'gaming:decline_delay':["I'll wait — just let me know.","Can we play after dinner?","I'll set it up while I wait.","No rush — I'll practise on my own."],

    // ---- OUTINGS (decline) ----
    'outings:decline':    ["Okay, maybe another day.","What if we go somewhere closer?","Can we go tomorrow instead?","I understand — I'll find something to do at home.","What about a short walk instead?"],
    'outings:decline_delay':["That's fine — tell me when.","I'll get ready while I wait.","Can we go this afternoon instead?"],

    // ---- FRIENDS (decline) ----
    'friends:decline':    ["Okay, maybe next time.","Can I message them instead?","What about a video call?","I understand.","Can they come here so you don't have to drive?"],

    // ---- ACTIVITY (general decline) ----
    'activity:decline':   ["Okay, what can we do instead?","Is there something easier we could do together?","Can I do it on my own?","What about something quieter?","I'll find something else to do.","That's okay — any other ideas?"],
    'activity:decline_delay':["No worries, I'll wait.","Can you tell me when you're free?","I'll entertain myself until then.","How about in 30 minutes?"],

    // ---- HEALTH (fill gaps) ----
    'health:choice':      ["I'd like to rest.","Can I have some medicine?","A cold pack would help.","I need to lie down.","Can we see the doctor?"],
    'health:preference':  ["I prefer rest to medicine.","I'd rather wait and see if it passes.","I like having a heat pack.","I prefer the liquid medicine."],
    'health:opinion':     ["I think I'm getting a cold.","I reckon it's just tiredness.","It might be from not sleeping well.","I think I need to see a professional."],
    'health:review':      ["I'm feeling much better now.","The medicine helped.","It was worse than I thought.","I'm recovering well.","That was a rough couple of days."],

    // ---- HELPING (fill gaps) ----
    'helping:preference': ["I prefer to help in ways I'm good at.","I like being useful.","I'd rather help with thinking tasks than physical ones.","I prefer to be asked, not told."],
    'helping:opinion':    ["I think everyone should contribute.","I appreciate when people help me too.","It feels good to be helpful.","I think teamwork makes things easier."],
    'helping:status':     ["I've finished helping.","I'm still working on it.","I did my part.","I could do more if needed."],
    'helping:review':     ["That felt good to contribute.","I'm glad I could help.","It was harder than I expected.","We made a good team."],

    // ---- HOLIDAYS (fill gaps) ----
    'holidays:status':    ["I'm packed and ready.","I still need to prepare.","I've been counting down the days.","I'm not sure what to expect.","I need my headphones and comfort items."],

    // ---- HOMEWORK (fill gaps) ----
    'homework:choice':    ["I'll start with maths.","Can I do the easiest one first?","I'd like help choosing where to start.","Let me do the interesting one first."],
    'homework:preference':["I prefer working independently.","I like having background music while studying.","I work better in short bursts.","I prefer maths homework to writing assignments."],
    'homework:review':    ["I did well on that one.","It was harder than I expected.","I feel confident about my answers.","I think I need to review one section.","That was a productive study session."],
    'homework:need':      ["I need help understanding the question.","I need more time.","I need a calculator.","I need a break before continuing.","I need someone to check my work."],

    // ---- HYGIENE (fill gaps) ----
    'hygiene:preference': ["I prefer showers to baths.","I like warm water.","I'd rather do it myself.","I prefer minty toothpaste."],
    'hygiene:opinion':    ["I think I should shower now.","I don't think I need to wash my hair today.","I feel better when I'm clean."],
    'hygiene:review':     ["I feel refreshed now.","That shower was perfect.","I remembered everything on my list."],

    // ---- LEARNING (fill gaps) ----
    'learning:choice':    ["I'd like to learn more about maths.","Can we try a different approach?","I want to explore that concept further.","Show me a practical example."],
    'learning:preference':["I learn best through visual examples.","I prefer to figure things out myself.","Step-by-step explanations work for me.","I prefer hands-on learning."],
    'learning:review':    ["That lesson really clicked.","I didn't quite follow all of it.","I feel like I've made real progress.","The examples made all the difference."],

    // ---- MONEY (fill gaps) ----
    'money:preference':   ["I prefer saving to spending.","I like knowing exactly what things cost.","I'd rather buy quality that lasts.","I prefer to compare prices first."],
    'money:review':       ["That was a good purchase.","I'm glad I saved up for it.","It wasn't worth the money.","I should have waited for a sale."],
    'money:status':       ["I've saved enough.","I need to save more.","I've just spent most of my money.","I'm on budget.","I need to check my balance."],

    // ---- MOVIES/TV (fill gaps) ----
    'movies_tv:status':   ["I'm halfway through the episode.","I just finished it.","I haven't started yet.","Can I watch one more episode?","I need to pause — I'll come back to it."],

    // ---- OUTINGS (fill gaps) ----
    'outings:status':     ["I'm ready to go.","I need a few more minutes.","I've got everything I need.","I need my headphones.","I'm packed."],

    // ---- PETS (fill gaps) ----
    'pets:choice':        ["I want to walk the dog.","Can I feed them?","I'd like to play with them.","Can we get a new toy for them?"],
    'pets:preference':    ["I love dogs.","Cats are wonderful companions.","I prefer animals that are calm.","I like watching fish — it's relaxing."],
    'pets:opinion':       ["I think they need more exercise.","They seem happy today.","I reckon they're hungry.","I think we should take better care of them."],
    'pets:status':        ["I've fed them.","They need a walk.","They've been outside already.","I cleaned their area.","They need fresh water."],

    // ---- READING (fill gaps) ----
    'reading:yesno':      ["Yes, I've been reading.","No, I haven't started yet.","I'm nearly finished.","Yes, and it's excellent.","Not yet — I've been busy."],
    'reading:opinion':    ["I think the author's style is distinctive.","The plot is more complex than I expected.","I find the themes genuinely thought-provoking.","The writing is elegant."],

    // ---- ROUTINE (fill gaps) ----
    'routine:preference': ["I prefer a consistent routine.","I like knowing what's coming next.","I work better with a visual schedule.","I prefer flexibility within structure."],
    'routine:opinion':    ["I think the current routine works well.","I'd like to adjust my morning routine.","I reckon we could be more efficient.","The routine helps me feel in control."],
    'routine:review':     ["Today's routine went smoothly.","I missed a step today.","The new routine is working well.","I think we need to adjust the timing."],

    // ---- SCHOOL (fill gaps) ----
    'school:choice':      ["I'd like to work on maths.","Can we do group work today?","I prefer independent study.","Can I work in a quiet area?","I'd like a challenging task."],

    // ---- SCIENCE (fill gaps) ----
    'science:choice':     ["I'd like to do an experiment.","Can we study physics today?","I want to learn about space.","Let's explore the hypothesis further.","Chemistry experiments are fascinating."],
    'science:preference': ["I prefer experiments to theory.","Physics is my favourite branch.","I find the scientific method elegant.","I like when we can test things ourselves."],
    'science:status':     ["I've finished the experiment.","I'm recording my observations.","I need more data.","The results are interesting.","I'm writing up my conclusion."],

    // ---- SENSORY (fill gaps) ----
    'sensory:choice':     ["I'd like my headphones.","Can we go somewhere quieter?","I need a dim room.","A weighted blanket would help.","Can I use my fidget?"],
    'sensory:preference': ["I prefer quiet environments.","I like soft lighting.","I prefer minimal background noise.","I'm sensitive to sudden sounds.","I like deep pressure."],
    'sensory:opinion':    ["I think this room is too stimulating.","The noise level is manageable.","I reckon the lighting could be softer.","This environment suits me."],
    'sensory:status':     ["I'm coping well right now.","I'm starting to feel overwhelmed.","I need a sensory break soon.","I'm managing with my headphones.","The environment is comfortable."],
    'sensory:review':     ["That break really helped.","The quiet space was exactly what I needed.","I feel much calmer now.","My headphones saved me.","Today was easier than usual."],

    // ---- SLEEP (fill gaps) ----
    'sleep:choice':       ["I want to read before bed.","Can I have some quiet time?","I'd like some warm milk.","Can I listen to music while falling asleep?"],
    'sleep:preference':   ["I prefer a dark, quiet room.","I like sleeping in on weekends.","I sleep better with a weighted blanket.","I prefer a consistent bedtime."],
    'sleep:opinion':      ["I think I need more sleep.","I reckon the early mornings are affecting me.","I slept better when I went to bed earlier.","I think screen time before bed affects my sleep."],
    'sleep:status':       ["I'm ready for bed.","I'm not sleepy yet.","I'm exhausted.","I slept well last night.","I woke up several times."],

    // ---- SPORTS (fill gaps) ----
    'sports:choice':      ["I'd like to try swimming.","Can we play cricket?","I want to go for a walk.","Something low-impact today.","Can I just watch?"],
    'sports:opinion':     ["I think exercise is important.","That was harder than I expected.","I prefer individual sports.","The team played well together."],
    'sports:status':      ["I've done my exercise.","I'm still warming up.","I'm tired from the workout.","I feel energised after that.","I need to cool down."],

    // ---- TECHNOLOGY (fill gaps) ----
    'technology:preference':["I prefer the iPad to the phone.","I like having my own device.","I prefer apps that are well-designed.","I'd rather use it without help."],
    'technology:review':   ["The app worked well.","It crashed, which was frustrating.","I discovered a useful feature.","The update made it better.","I prefer the old version."],
    'technology:need':     ["I need the wifi password.","My device needs charging.","I need to download something.","Can you help me with a setting?","I need more storage."],

    // ---- TIME (fill gaps) ----
    'time:choice':        ["I'd like to do it now.","Can we do it later?","After lunch would be better.","First thing tomorrow.","I need 10 more minutes."],
    'time:preference':    ["I prefer mornings.","I work better in the afternoon.","I like having plenty of time, not rushing.","I prefer to plan ahead."],
    'time:opinion':       ["I think we have enough time.","I reckon we're running late.","I think we should start soon.","Time management is important."],
    'time:review':        ["We timed that well.","We should have started earlier.","That took longer than expected.","Perfect timing."],

    // ---- TRANSPORT (fill gaps) ----
    'transport:opinion':  ["I think driving is faster.","The bus is too noisy for me.","I prefer the train — it's smoother.","Walking is nice when the weather is good."],
    'transport:review':   ["The journey was comfortable.","That ride was too bumpy.","It took longer than usual.","The trip went smoothly.","I prefer the route we took last time."],

    // ---- WAITING (fill gaps) ----
    'waiting:choice':     ["I'll read while I wait.","Can I use my iPad?","I'll listen to music.","I'd like to walk around.","Can we wait somewhere quieter?"],
    'waiting:preference': ["I prefer to know how long I'll be waiting.","I'd rather do something while I wait.","I prefer waiting somewhere comfortable.","I don't mind waiting if I have something to do."],
    'waiting:review':     ["That wasn't as long as I expected.","The wait was worth it.","I managed well while waiting.","Next time, I'll bring something to do."],

    // ---- WEATHER (fill gaps) ----
    'weather:yesno':      ["Yes, it's nice outside.","No, it's miserable weather.","I think so — let me check.","It looks like it might rain."],
    'weather:choice':     ["I'd prefer to stay inside today.","Let's go outside — it's beautiful.","Can we go when it cools down?","I'd rather wait for better weather."],
    'weather:preference': ["I love sunny weather.","I prefer cooler temperatures.","Rain is relaxing to listen to.","I don't like extreme heat.","Overcast days are my favourite."],
    'weather:status':     ["It's sunny right now.","It's raining outside.","It's getting cloudy.","The weather's perfect for going out.","It's too hot to be outside."],
    'weather:review':     ["Today's weather was lovely.","It was too hot for me.","The rain was actually refreshing.","I wish the weather had been better."],
};

// ============================================================
// CONVERSATION MEMORY — maintains topic context across utterances
// ============================================================
const conversationMemory = {
    recentTopics: [],      // [{topic, keywords, time, confidence}] — last 60 seconds
    subjectNouns: [],       // ['beach','homework','pizza'] — detected subject words for slot-filling
    activeTopicDecay: 60000, // 60 seconds — how long a topic stays "active"

    // Add a detected topic to memory
    remember(topic, keywords, confidence) {
        const now = Date.now();
        this.recentTopics.push({topic, keywords, time:now, confidence});
        // Extract subject nouns (nouns that could fill a slot)
        keywords.forEach(kw => {
            if (!this.subjectNouns.includes(kw)) this.subjectNouns.push(kw);
        });
        if (this.subjectNouns.length > 10) this.subjectNouns = this.subjectNouns.slice(-10);
        this.cleanup();
    },

    // Remove topics older than decay window
    cleanup() {
        const cutoff = Date.now() - this.activeTopicDecay;
        this.recentTopics = this.recentTopics.filter(t => t.time > cutoff);
    },

    // Get the best topic from memory (even if current utterance has none)
    getActiveTopic() {
        this.cleanup();
        if (this.recentTopics.length === 0) return null;
        // Score topics by recency × confidence × frequency
        const topicScores = {};
        this.recentTopics.forEach(t => {
            const age = (Date.now() - t.time) / 1000; // seconds ago
            const recencyWeight = Math.max(0, 1 - age / 60); // 1.0 at 0s, 0.0 at 60s
            topicScores[t.topic] = (topicScores[t.topic] || 0) + (t.confidence * recencyWeight);
        });
        const best = Object.entries(topicScores).sort((a,b) => b[1]-a[1])[0];
        return best ? best[0] : null;
    },

    // Get the most recent subject noun for slot-filling
    getSubject() {
        return this.subjectNouns.length > 0 ? this.subjectNouns[this.subjectNouns.length - 1] : null;
    },

    // Get all recent subjects for richer slot-filling
    getRecentSubjects() {
        return [...this.subjectNouns].reverse().slice(0, 5);
    },

    // Clear on context change
    clear() {
        this.recentTopics = [];
        this.subjectNouns = [];
    }
};

// ============================================================
// SLOT-FILLING TEMPLATES — inject subject nouns into responses
// ============================================================
// Template format: {s} = primary subject, {S} = capitalised subject
const SLOT_TEMPLATES = {
    review: [
        "The {s} was quite enjoyable.",
        "I found the {s} rather fascinating.",
        "The {s} wasn't quite what I expected.",
        "I thought the {s} was brilliant.",
        "The {s} could have been better, to be honest.",
        "I was pleasantly surprised by the {s}.",
    ],
    opinion: [
        "I think the {s} is genuinely interesting.",
        "I have mixed feelings about the {s}.",
        "The {s} raises some good points.",
        "I'm not entirely convinced about the {s}.",
    ],
    preference: [
        "I'm quite fond of the {s}.",
        "The {s} isn't really my thing.",
        "I'd choose the {s} over the alternatives.",
    ],
    yesno: [
        "Yes, the {s} was good.",
        "No, I wasn't keen on the {s}.",
        "The {s}? Absolutely.",
        "The {s}? Not particularly.",
    ],
    status: [
        "I've finished the {s}.",
        "I'm still working on the {s}.",
        "I haven't started the {s} yet.",
    ],
    explanation: [
        "The {s} works because of the underlying pattern.",
        "I approached the {s} from a different angle.",
    ],
    choice: [
        "The {s}, please.",
        "I'd like the {s}.",
        "Can I have the {s}?",
        "The {s} sounds good.",
        "Not the {s} — something else.",
    ],
    buy_choice: [
        "I'd like to get some {s}.",
        "Can we look at {s}?",
        "I want {s}, please.",
        "I've been wanting {s} for a while.",
        "New {s} would be great.",
        "Let's check out the {s} section.",
    ],
    wear_choice: [
        "My {s}.",
        "The {s}, please.",
        "Not the {s} — something else.",
    ],
    watch_choice: [
        "I'd like to watch {s}.",
        "Can we watch {s}?",
        "{S} sounds good.",
        "Not {s} — something different.",
    ],
    play_choice: [
        "I want to play {s}.",
        "Can we play {s}?",
        "{S} would be fun.",
        "Not {s} today.",
    ],
    food_choice: [
        "I'd like {s}, please.",
        "{S} sounds good.",
        "Can we have {s}?",
        "Not {s} — something else.",
    ],
    need: [
        "I need {s}.",
        "Can I have {s}?",
        "I could really use {s}.",
    ],
};

function fillSlots(templates, subject) {
    if (!subject || subject.length < 2) return [];
    return templates.map(t => t.replace(/\{s\}/g, subject).replace(/\{S\}/g, subject[0].toUpperCase() + subject.slice(1)));
}

// GENERIC RESPONSES — Ryan's voice: sophisticated, analytical, Australian
const GENERIC_RESPONSES = {
    greeting:   ["I'm doing well, thanks for asking.","I'm a bit tired today, honestly.","Not bad at all. You?","Yeah, going alright.","I'm feeling pretty good.","Can't complain.","I'm a bit frustrated, but I'll manage.","It's been an interesting day."],
    yesno:      ["Yeah, for sure.","No thanks, maybe another time.","I'll need to think about that.","I'm not entirely sure.","Sounds good to me.","Absolutely.","I don't think so, no.","Not at the moment.","That depends on the circumstances."],
    opinion:    ["I think that's a genuinely good idea.","I'm not entirely convinced, to be honest.","Fair enough — that's a reasonable perspective.","I reckon that could work.","It depends on the circumstances.","I'd need to consider it further.","There's more nuance to it than that.","That's an interesting way to look at it."],
    preference: ["That's something I genuinely enjoy.","That's not really my thing, if I'm honest.","That's a fair point, actually.","I hadn't considered it from that angle.","I'd prefer something different.","I can see the appeal."],
    review:     ["I found it quite enjoyable.","It wasn't bad at all.","I genuinely enjoyed that.","It could have been better, to be honest.","It was adequate.","One of the better ones I've experienced.","It exceeded my expectations.","I have mixed feelings about it."],
    narrative:  ["I've been reflecting on something.","Something noteworthy happened.","I had a rather good day, actually.","Tell me more about that — I'm interested.","It's a bit of a long story.","Something's been on my mind."],
    wellbeing:  ["I'm managing, thanks.","Not my best day, honestly.","I'm coping well enough.","I appreciate you asking.","I could be better, but I'm okay.","I'm doing well, actually.","I'm working through some things."],
    status:     ["Done and dusted.","Not yet, I'm afraid.","I'm working on it.","Almost there.","I could use some help with that.","Give me a moment.","I'll get to it shortly."],
    specific:   ["I'm not certain, let me think.","Give me a moment to formulate my answer.","Could you ask me as a yes or no question?","I'd need to check on that.","That's a good question — I'm not sure."],
    explanation:["It depends on the context.","There's more complexity to it than that.","I reckon so, based on what I've observed.","Can we examine it from a different perspective?","It's difficult to articulate, but I'll try.","Let me think about how to express this.","The reasoning is quite logical, actually."],
    choice:     ["The first option, I think.","The second one appeals to me more.","That one, please.","I don't have a strong preference.","You choose — I trust your judgement.","Could I see the options first?","I need a moment to decide.","Both have their merits."],
    food_choice:["Pizza would be excellent.","Pasta sounds good to me.","Something straightforward, please.","I'm not fussy — you decide.","Can I see what's available?","I'd like what I had last time."],
    drink_choice:["Water, please.","Juice would be lovely.","A hot chocolate would be great.","Something cold, please.","I'm alright for now, thanks."],
    activity_choice:["I'd like to play a game.","Can we watch something?","I'd like to use the iPad.","Something engaging would be good.","I'd rather stay in, if that's okay.","Something quieter, perhaps."],
    place_choice:["The park would be nice.","I'd prefer to stay home.","Somewhere quiet.","I don't mind — you pick.","Somewhere with a good atmosphere."],
    buy_choice:["New clothes.","Something for gaming.","A book, maybe.","Snacks.","Can I look around first?","I have something specific in mind.","Art supplies.","Tech stuff.","I'm not sure yet — can we browse?","Something fun."],
    wear_choice:["Something comfortable.","My hoodie.","Whatever's clean.","Something warm.","The new ones.","I don't mind, you pick.","My favourite outfit."],
    watch_choice:["Something funny.","A movie.","YouTube.","Something new.","What we watched last time.","I don't mind — you choose.","An action movie.","Something we can all watch."],
    play_choice:["Minecraft.","Something multiplayer.","A puzzle game.","Something new.","Whatever you want.","Can I pick?","Something we can play together."],
    read_choice:["Something interesting.","Fiction.","A graphic novel.","The one I'm reading now.","Something new.","Can you recommend one?"],
    need:["Help, please.","A minute to think.","Some space.","Something to eat.","Someone to talk to.","More time.","A break.","Nothing right now, thanks."],
    decline:["Okay, that's fine.","Can we do it later then?","What about tomorrow?","I understand.","When would be a good time?","That's okay — I can do something else.","Maybe after you've rested?","Is there something we can do together that's easier?","No worries.","I'll find something else to do.","What if we do something quiet instead?","Can someone else do it with me?"],
    decline_delay:["Okay, I'll wait.","How long do you think?","That's fine — I'll do something else first.","Let me know when you're ready.","No rush.","I'll be patient.","Can I set a timer?","I'll play by myself until then."],
};

function initSpeechRecognition() {
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (!SpeechRecognition) return null;
    const rec = new SpeechRecognition();
    rec.continuous = true;
    rec.interimResults = true;
    rec.lang = 'en-AU';
    rec.maxAlternatives = 3; // Get multiple interpretations for better accuracy

    // ============================================================
    // SPEECH CORRECTION ENGINE
    // ============================================================

    // Level 1: Exact phrase corrections (misheard → intended)
    const PHRASE_CORRECTIONS = {
        // Common mishearings
        'would you kike':'would you like', 'would you lick':'would you like',
        'wood you like':'would you like', 'what would you lie':'what would you like',
        'what would you light':'what would you like',
        'are you hungary':'are you hungry', 'are you hundry':'are you hungry',
        'are you hunger':'are you hungry',
        'how is school':'how was school', 'how a school':'how was school',
        'have you don':'have you done', 'have you dun':'have you done',
        'are you ok':'are you okay', 'you ok':'you okay',
        'did you finnish':'did you finish', 'have you finnish':'have you finish',
        'do you want':'do you want', 'you want':'you want',
        'what do you thing':'what do you think', 'what you think':'what do you think',
        'tell me a boat':'tell me about', 'tell me a bout':'tell me about',
        'how\'s it go in':'how\'s it going',
        'what you doing':'what are you doing', 'whatcha doing':'what are you doing',
        'where you going':'where are you going',
    };

    // Level 2: Word-level corrections (single words commonly misheard)
    const WORD_CORRECTIONS = {
        'kike':'like', 'lick':'like', 'lie':'like', 'light':'like',
        'hungary':'hungry', 'hundry':'hungry', 'hunger':'hungry',
        'finnish':'finish', 'finsh':'finish',
        'hom':'home', 'hone':'home',
        'scool':'school', 'shool':'school',
        'brekfast':'breakfast', 'brekkie':'breakfast',
        'diner':'dinner', 'dinna':'dinner',
        'lnch':'lunch', 'lanch':'lunch',
        'piza':'pizza', 'pitza':'pizza',
        'paster':'pasta', 'parsta':'pasta',
        'chiken':'chicken', 'chickin':'chicken',
        'carry':'curry', 'cary':'curry', 'karee':'curry',
        'wanna':'want to', 'gonna':'going to', 'gotta':'got to',
        'dunno':'don\'t know', 'lemme':'let me', 'gimme':'give me',
        'ya':'you', 'yer':'your', 'ya\'ll':'you all',
        'nah':'no', 'yep':'yes', 'yeah':'yes', 'yea':'yes',
        'cos':'because', 'coz':'because', 'cause':'because',
        'bout':'about', 'em':'them', 'til':'until',
        'reckon':'reckon', 'arvo':'afternoon', 'brekky':'breakfast',
        'heaps':'lots', 'choccy':'chocolate', 'biccy':'biscuit',
        'tomoz':'tomorrow', 'sunnies':'sunglasses',
        'maths':'maths', 'math':'math',
        'telly':'television', 'footy':'football',
    };

    // Level 3: Phonetic pairs — words that SOUND similar and get swapped
    // Used for fuzzy topic matching, not transcript correction
    const PHONETIC_PAIRS = {
        'eat':'eat', 'it':'eat',   // "would you like to it" → might mean "eat"
        'hot':'hot', 'hat':'hot',
        'cold':'cold', 'called':'cold',
        'game':'game', 'gain':'game',
        'book':'book', 'buck':'book',
        'write':'write', 'right':'write',
        'read':'read', 'red':'read',
        'know':'know', 'no':'know',
        'new':'new', 'knew':'new',
        'there':'there', 'their':'there',
        'weather':'weather', 'whether':'weather',
        'where':'where', 'wear':'where',
        'here':'here', 'hear':'here',
    };

    function correctSpeech(text) {
        let corrected = text.toLowerCase();

        // Step 1: Try phrase-level corrections first (more accurate)
        for (const [wrong, right] of Object.entries(PHRASE_CORRECTIONS)) {
            if (corrected.includes(wrong)) {
                corrected = corrected.replace(wrong, right);
            }
        }

        // Step 2: Word-level corrections
        const words = corrected.split(/\s+/);
        const fixed = words.map(w => {
            const clean = w.replace(/[.,!?;:'"]/g, '');
            return WORD_CORRECTIONS[clean] ? corrected.replace(clean, WORD_CORRECTIONS[clean]) && WORD_CORRECTIONS[clean] : w;
        });
        corrected = fixed.join(' ');

        return corrected;
    }

    // Fuzzy topic matching — checks if misheard words are phonetically close to topic keywords
    // This is exported for use in analyseAndSuggest
    window._phoneticPairs = PHONETIC_PAIRS;

    // Pick best transcript from alternatives
    function getBestTranscript(results, index) {
        let bestText = '';
        let bestConfidence = 0;
        for (let a = 0; a < results[index].length; a++) {
            const alt = results[index][a];
            // Prefer higher confidence, but also prefer longer transcripts
            const score = alt.confidence + (alt.transcript.trim().length > 5 ? 0.05 : 0);
            if (score > bestConfidence) {
                bestConfidence = score;
                bestText = alt.transcript;
            }
        }
        return bestText;
    }

    let debounceTimer = null;
    let lastProcessedText = '';

    rec.onresult = (event) => {
        let finalTranscript = '';
        let interimTranscript = '';
        for (let i = event.resultIndex; i < event.results.length; i++) {
            if (event.results[i].isFinal) {
                finalTranscript += getBestTranscript(event.results, i);
            } else {
                interimTranscript += event.results[i][0].transcript;
            }
        }

        // Show what's being heard immediately
        const recent = conversationTranscript.slice(-3).map(u => u.text).join(' … ');
        updateTranscriptDisplay(recent + (interimTranscript ? ' ' + interimTranscript : ''));

        // Process FINAL results immediately — with correction
        if (finalTranscript) {
            clearTimeout(debounceTimer);
            const raw = finalTranscript.trim();
            const text = correctSpeech(raw);
            // Show corrected text in transcript if different
            if (text !== raw.toLowerCase()) {
                updateTranscriptDisplay(recent + ' ✏️ ' + text);
            }
            conversationTranscript.push({text, time:Date.now()});
            if (conversationTranscript.length > 20) conversationTranscript = conversationTranscript.slice(-20);
            lastProcessedText = text;
            analyseAndSuggest(text, true);
        }
        // Process INTERIM results with debounce
        else if (interimTranscript) {
            const raw = interimTranscript.trim();
            const text = correctSpeech(raw);
            if (text.length > 3 && text !== lastProcessedText) {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(() => {
                    lastProcessedText = text;
                    analyseAndSuggest(text, false);
                }, 200);
            }
        }
    };

    rec.onerror = (event) => {
        if (event.error === 'no-speech' || event.error === 'aborted') return;
        if (event.error === 'not-allowed') {
            showToast('Microphone permission needed. Check Settings → Safari.');
            stopListening();
        }
    };

    rec.onend = () => {
        if (isListening) { try { rec.start(); } catch(e) {} }
    };

    return rec;
}

function startListening() {
    if (!recognition) recognition = initSpeechRecognition();
    if (!recognition) {
        showToast('Speech recognition not available on this device');
        return;
    }
    try {
        recognition.start();
        isListening = true;
        document.getElementById('listenToggle').classList.add('active');
        document.getElementById('listenLabel').textContent = 'Listening...';
        document.getElementById('listenTopic').textContent = '🎤 Hearing conversation...';
        document.getElementById('listenTopic').classList.remove('has-topic');
    } catch(e) {
        if (e.name === 'InvalidStateError') {
            isListening = true;
        }
    }
}

function stopListening() {
    isListening = false;
    if (recognition) {
        try { recognition.stop(); } catch(e) {}
    }
    document.getElementById('listenToggle').classList.remove('active');
    document.getElementById('listenLabel').textContent = 'Listen';
    document.getElementById('listenTopic').textContent = 'Tap Listen to hear the conversation';
    document.getElementById('listenTopic').classList.remove('has-topic');
}

// Fuzzy match: true if words are within 1 edit distance (swap, insert, delete, or replace 1 char)
function fuzzyMatch(a, b) {
    if (a === b) return true;
    const lenA = a.length, lenB = b.length;
    if (Math.abs(lenA - lenB) > 1) return false;

    // Quick check: if same length, allow 1 character difference
    if (lenA === lenB) {
        let diffs = 0;
        for (let i = 0; i < lenA; i++) {
            if (a[i] !== b[i]) diffs++;
            if (diffs > 1) return false;
        }
        return diffs === 1;
    }

    // Different lengths: allow 1 insertion/deletion
    const shorter = lenA < lenB ? a : b;
    const longer = lenA < lenB ? b : a;
    let diffs = 0, si = 0;
    for (let li = 0; li < longer.length; li++) {
        if (shorter[si] !== longer[li]) {
            diffs++;
            if (diffs > 1) return false;
        } else {
            si++;
        }
    }
    return true;
}

function analyseAndSuggest(text, isFinal) {
    if (!app.currentContext) return;
    const lower = text.toLowerCase();

    // 1. Detect TOPICS from topic clouds (with fuzzy matching for misheard words)
    detectedKeywords = [];
    const topicScores = {};
    const lowerWords = lower.split(/\s+/).map(w => w.replace(/[.,!?;:'"]/g, ''));

    for (const [topic, words] of Object.entries(TOPIC_CLOUDS)) {
        for (const w of words) {
            // Exact match (standard)
            if (lower.includes(w)) {
                detectedKeywords.push({word:w, topic});
                topicScores[topic] = (topicScores[topic]||0) + 1;
            } else {
                // Fuzzy match: check if any spoken word is within 1 edit distance of topic keyword
                // Only for words 4+ chars (short words have too many false positives)
                if (w.length >= 4) {
                    for (const spoken of lowerWords) {
                        if (spoken.length >= 4 && fuzzyMatch(spoken, w)) {
                            detectedKeywords.push({word:w, topic, fuzzy:true});
                            topicScores[topic] = (topicScores[topic]||0) + 0.7; // Slightly less weight than exact
                            break;
                        }
                    }
                }
            }
        }
    }

    // Get top 2 topics from THIS utterance
    const rankedTopics = Object.entries(topicScores).sort((a,b) => b[1]-a[1]);
    const utteranceTopic = rankedTopics[0]?.[0] || null;
    const utteranceStrength = rankedTopics[0]?.[1] || 0;
    const secondaryTopic = rankedTopics[1]?.[0] || null;

    // 2. CONVERSATION MEMORY — remember topics and extract subject nouns
    if (utteranceTopic) {
        const subjectWords = detectedKeywords
            .filter(k => k.topic === utteranceTopic)
            .map(k => k.word)
            .filter(w => w.length > 2 && !['the','and','was','were','had','have','has','did','does','can','could','will','would','for','but','not','you','your','how','what','why'].includes(w));
        conversationMemory.remember(utteranceTopic, subjectWords, utteranceStrength);
    }

    // MEMORY ANCHORING: If memory has a topic and new detection is weak (1 keyword),
    // prefer the memory topic. Prevents "hot or cold" jumping from food→weather.
    const memoryTopic = conversationMemory.getActiveTopic();
    let primaryTopic;
    if (utteranceTopic && memoryTopic && utteranceTopic !== memoryTopic && utteranceStrength <= 1) {
        // Weak new detection + strong memory = stick with memory
        primaryTopic = memoryTopic;
    } else {
        primaryTopic = utteranceTopic || memoryTopic;
    }
    if (primaryTopic) detectedTopic = primaryTopic;

    // Get subject noun for slot-filling
    const subject = conversationMemory.getSubject();

    // 2b. Detect QUESTION TYPE
    let questionType = null;
    for (const q of QUESTION_PATTERNS) {
        if (q.pattern.test(lower)) { questionType = q.type; break; }
    }

    // 3. Build contextual suggestions
    const scores = [];
    const alreadyAdded = new Set();

    function addResponses(responses, baseScore, source) {
        responses.forEach(text => {
            if (alreadyAdded.has(text)) return;
            alreadyAdded.add(text);
            const existing = (app.cards || []).find(c => c.text === text);
            if (existing) {
                scores.push({card:existing, score:baseScore, source});
            } else {
                let found = null;
                for (const ctxId of Object.keys(CARD_DATA)) {
                    const match = CARD_DATA[ctxId].cards.find(c => c.text === text);
                    if (match) { found = {card:match, ctx:ctxId}; break; }
                }
                if (found) {
                    scores.push({card:found.card, score:baseScore, crossContext:found.ctx, source});
                } else {
                    scores.push({card:{text, cat:'choices'}, score:baseScore, virtual:true, source});
                }
            }
        });
    }

    // Priority 0: SLOT-FILLED responses (most contextual — uses the actual subject word)
    // Only slot-fill with nouns that make sense as objects (not verbs, adjectives, or generic words)
    const SLOT_BLACKLIST = new Set([
        // Verbs/adjectives commonly misextracted as subjects
        'tired','add','chat','want','need','like','have','make','take','get','come','give','let',
        'play','try','help','find','think','know','feel','say','tell','go','put','see','look',
        'buy','eat','drink','watch','read','write','draw','run','walk','sit','stand','wait','stop',
        'start','keep','show','open','close','turn','ask','done','finish','finished','ready',
        'good','bad','nice','cool','great','fine','okay','happy','sad','angry','big','small',
        'hot','cold','warm','new','old','fast','slow','hard','easy','long','short','much','many',
        // Function words that leak through
        'more','just','also','still','even','only','really','very','too','some','any','all',
        'about','after','before','with','from','into','over','under','again','here','there','now',
        'today','tomorrow','yesterday','later','soon','away','back','home','please','thanks',
    ]);
    if (subject && questionType && SLOT_TEMPLATES[questionType] && !SLOT_BLACKLIST.has(subject.toLowerCase()) && subject.length > 2) {
        const slotFilled = fillSlots(SLOT_TEMPLATES[questionType], subject);
        addResponses(slotFilled.slice(0,4), 14, '✨ contextual');
    }

    // Priority 1: EXACT matrix match (topic + question type)
    if (primaryTopic && questionType) {
        const matrixKey = primaryTopic + ':' + questionType;
        if (CONTEXTUAL_RESPONSES[matrixKey]) {
            addResponses(CONTEXTUAL_RESPONSES[matrixKey], 15, '🎯 match');
        }
        if (secondaryTopic) {
            const matrixKey2 = secondaryTopic + ':' + questionType;
            if (CONTEXTUAL_RESPONSES[matrixKey2]) {
                addResponses(CONTEXTUAL_RESPONSES[matrixKey2], 10, '🎯 related');
            }
        }
    }

    // Priority 1b: MEMORY matrix match — use remembered topic if current has none
    if (!utteranceTopic && primaryTopic && questionType) {
        const memKey = primaryTopic + ':' + questionType;
        if (CONTEXTUAL_RESPONSES[memKey]) {
            addResponses(CONTEXTUAL_RESPONSES[memKey], 13, '🧠 remembered');
        }
    }

    // Priority 2: Topic-only match — pull from ALL entries for this topic
    if (primaryTopic) {
        for (const [key, responses] of Object.entries(CONTEXTUAL_RESPONSES)) {
            if (key.startsWith(primaryTopic + ':') && responses.length) {
                addResponses(responses.slice(0, scores.length < 6 ? 5 : 3), 8, '📂 topic');
            }
        }
    }

    // Priority 3: Question-type generic responses
    if (questionType && scores.length < 8) {
        if (GENERIC_RESPONSES[questionType]) {
            addResponses(GENERIC_RESPONSES[questionType], 6, '❓ type');
        }
    }

    // Priority 4: Keyword-matched cards in current context
    const keywordWords = detectedKeywords.map(k => k.word);
    const allCards = (app.cards && app.cards.length) ? app.cards : getCardsForContext(app.currentContext);
    allCards.forEach(card => {
        if (alreadyAdded.has(card.text)) return;
        let score = 0;
        const cardLower = card.text.toLowerCase();
        for (const kw of keywordWords) {
            if (cardLower.includes(kw)) score += 3;
        }
        // IMPROVEMENT 5: Expanded sequence learning — check last 3 phrases, not just 1
        try {
            const d = loadData();
            // Check immediate previous phrase
            if (lastSpokenKey) {
                const seq1 = d.sequences?.[lastSpokenKey]?.[card.text];
                if (seq1) score += seq1 * 2;
            }
            // Check phrase before that (2-back)
            if (conversationTranscript.length >= 2) {
                const twoBack = conversationTranscript[conversationTranscript.length - 2].text;
                const key2 = app.currentContext + ':' + twoBack;
                const seq2 = d.sequences?.[key2]?.[card.text];
                if (seq2) score += seq2 * 1.5;
            }
            // Check 3-back
            if (conversationTranscript.length >= 3) {
                const threeBack = conversationTranscript[conversationTranscript.length - 3].text;
                const key3 = app.currentContext + ':' + threeBack;
                const seq3 = d.sequences?.[key3]?.[card.text];
                if (seq3) score += seq3;
            }

            // IMPROVEMENT 6: Adaptive weighting from 👍/👎 feedback
            const fb = d.feedback || [];
            const ups = fb.filter(f => f.phrase === card.text && f.rating === 'up').length;
            const downs = fb.filter(f => f.phrase === card.text && f.rating === 'down').length;
            score += (ups * 1.5) - (downs * 2); // Boost liked, penalise disliked
        } catch {}
        if (score > 0) {
            alreadyAdded.add(card.text);
            scores.push({card, score});
        }
    });

    // Priority 4b: IMPROVEMENT 4 — N-gram word prediction
    // Simple bigram: if the heard speech ends with specific words, suggest responses containing likely next words
    if (lower.length > 3) {
        const spokenWords = lower.split(/\s+/);
        const lastWord = spokenWords[spokenWords.length - 1]?.replace(/[.,!?]/g, '');
        const secondLastWord = spokenWords.length >= 2 ? spokenWords[spokenWords.length - 2]?.replace(/[.,!?]/g, '') : '';

        // Build bigram predictions from Ryan's own spoken history
        try {
            const d = loadData();
            const convoLog = d.conversationLog || [];
            // Extract word pairs from what Ryan has previously said
            const bigramScores = {};
            convoLog.forEach(entry => {
                if (!entry.chosen) return;
                const words = entry.chosen.toLowerCase().split(/\s+/);
                for (let i = 0; i < words.length - 1; i++) {
                    const w = words[i].replace(/[.,!?'"]/g, '');
                    const next = words[i+1].replace(/[.,!?'"]/g, '');
                    if (w === lastWord && next.length > 2) {
                        bigramScores[next] = (bigramScores[next] || 0) + 1;
                    }
                }
            });

            // Boost cards that contain high-probability next words
            const topBigrams = Object.entries(bigramScores).sort((a,b) => b[1]-a[1]).slice(0,5);
            if (topBigrams.length > 0) {
                allCards.forEach(card => {
                    if (alreadyAdded.has(card.text)) return;
                    const cl = card.text.toLowerCase();
                    let bigramScore = 0;
                    topBigrams.forEach(([word, count]) => {
                        if (cl.includes(word)) bigramScore += count * 0.5;
                    });
                    if (bigramScore > 0) {
                        alreadyAdded.add(card.text);
                        scores.push({card, score: bigramScore, source: '📊 learned'});
                    }
                });
            }
        } catch {}
    }

    // Priority 5: Cross-context cards
    if (primaryTopic && primaryTopic !== app.currentContext && CARD_DATA[primaryTopic]) {
        CARD_DATA[primaryTopic].cards.slice(0,8).forEach(card => {
            if (alreadyAdded.has(card.text)) return;
            let score = 2;
            const cl = card.text.toLowerCase();
            for (const kw of keywordWords) { if (cl.includes(kw)) score += 3; }
            if (score > 2) {
                alreadyAdded.add(card.text);
                scores.push({card, score, crossContext:primaryTopic});
            }
        });
    }

    scores.sort((a,b) => b.score - a.score);
    suggestedPhrases = scores.slice(0,8);

    // 4. Update UI
    updateTopicDisplay();
    updateSuggestedStrip();
    if (isFinal && suggestedPhrases.length > 0) {
        reorderCardsFromSuggestions();
    }
}

function updateTopicDisplay() {
    const topicEl = document.getElementById('listenTopic');
    if (detectedKeywords.length) {
        const topicName = detectedTopic ? (CARD_DATA[detectedTopic]?.label || detectedTopic) : 'General';
        const kws = detectedKeywords.slice(0,3).map(k => k.word).join(', ');
        topicEl.textContent = `Topic: ${topicName} · "${kws}"`;
        topicEl.classList.add('has-topic');
    } else if (conversationMemory.getActiveTopic()) {
        // No keywords in THIS utterance, but memory has a topic
        const memTopic = conversationMemory.getActiveTopic();
        const memSubject = conversationMemory.getSubject();
        const topicName = CARD_DATA[memTopic]?.label || memTopic;
        topicEl.textContent = `🧠 Remembering: ${topicName}${memSubject ? ' · "'+memSubject+'"' : ''}`;
        topicEl.classList.add('has-topic');
    }
}

// ===== BUBBLE DRAG-TO-SPEAK SYSTEM =====

// Gamification state
let bubblePopCount = 0;
let comboCount = 0;
let lastPopTime = 0;
const COMBO_WINDOW = 4000;

// Sentence builder state
let sentencePhrases = [];

function getThemeForSource(source) {
    if (!source) return 'theme-suggestion';
    if (source.includes('match')) return 'theme-match';
    if (source.includes('remembered') || source.includes('🧠')) return 'theme-memory';
    if (source.includes('contextual') || source.includes('✨')) return 'theme-context';
    if (source.includes('learned') || source.includes('📊')) return 'theme-learned';
    return 'theme-suggestion';
}

function getConfidenceClass(score) {
    if (score >= 12) return 'confidence-high';
    if (score >= 6) return 'confidence-med';
    return 'confidence-low';
}

function createSparkles(cx, cy) {
    const colors = ['rgba(108,99,255,0.7)','rgba(78,205,196,0.7)','rgba(255,217,61,0.7)','rgba(255,107,107,0.7)','rgba(255,255,255,0.5)'];
    for (let i = 0; i < 8; i++) {
        const sparkle = document.createElement('div');
        sparkle.style.cssText = `position:fixed; width:${3+Math.random()*4}px; height:${3+Math.random()*4}px; border-radius:50%; background:${colors[i%colors.length]}; pointer-events:none; z-index:1000; left:${cx}px; top:${cy}px; transition:all 0.5s cubic-bezier(0.25,0.46,0.45,0.94);`;
        document.body.appendChild(sparkle);
        const angle = (i/8) * Math.PI * 2 + (Math.random()-0.5)*0.5;
        const dist = 30 + Math.random()*40;
        requestAnimationFrame(() => {
            sparkle.style.left = cx + Math.cos(angle)*dist + 'px';
            sparkle.style.top = cy + Math.sin(angle)*dist + 'px';
            sparkle.style.opacity = '0';
            sparkle.style.transform = 'scale(0)';
        });
        setTimeout(() => sparkle.remove(), 600);
    }
}

function updatePopCounter() {
    let counter = document.getElementById('bubbleCounter');
    if (!counter) {
        counter = document.createElement('div');
        counter.id = 'bubbleCounter';
        counter.className = 'bubble-counter';
        document.body.appendChild(counter);
    }
    counter.innerHTML = `🫧 <span class="counter-num">${bubblePopCount}</span>`;
    counter.classList.add('visible');
    const milestones = {1:'First bubble! 🌅', 10:'10 pops! ⭐', 25:'25 — on a roll! 🔥', 50:'50 pops today! 🏆', 100:'100! Incredible! 🎆'};
    if (milestones[bubblePopCount]) {
        const ms = document.createElement('div');
        ms.className = 'milestone-toast';
        ms.textContent = milestones[bubblePopCount];
        document.body.appendChild(ms);
        setTimeout(() => ms.remove(), 4000);
    }
}

function checkCombo() {
    const now = Date.now();
    if (now - lastPopTime < COMBO_WINDOW) {
        comboCount++;
        if (comboCount >= 3) {
            const badge = document.createElement('div');
            badge.className = 'combo-badge';
            badge.textContent = `🔥 ${comboCount}x Combo!`;
            document.body.appendChild(badge);
            setTimeout(() => badge.remove(), 1500);
        }
    } else { comboCount = 1; }
    lastPopTime = now;
}

function popBubbleAtPosition(el, cx, cy) {
    createSparkles(cx, cy);
    const particles = document.createElement('div');
    particles.className = 'pop-particles';
    el.appendChild(particles);
    el.classList.add('fitting');
    
    const text = el.dataset.text || el.textContent;
    const ghost = document.createElement('div');
    ghost.className = 'pop-ghost';
    ghost.textContent = text.length > 35 ? text.slice(0,35) + '…' : text;
    ghost.style.left = Math.max(10, cx - 80) + 'px';
    ghost.style.top = cy - 20 + 'px';
    document.body.appendChild(ghost);
    setTimeout(() => ghost.remove(), 1300);
    
    bubblePopCount++;
    updatePopCounter();
    checkCombo();
}

// ===== DRAG HANDLER — the core interaction =====
function initBubbleDrag(container) {
    let dragEl = null;
    let dragClone = null;
    let startX = 0, startY = 0;
    let offsetX = 0, offsetY = 0;
    let isDragging = false;
    let holdTimer = null;
    let didLongPress = false;
    let touchHandled = false; // prevents click from also firing after touch

    // === CLICK HANDLER — reliable tap-to-speak fallback ===
    container.addEventListener('click', (e) => {
        if (touchHandled) { touchHandled = false; return; }
        const bubble = e.target.closest('.bubble');
        if (!bubble) return;
        const text = bubble.dataset.text || bubble.textContent.trim();
        if (!text || text === '') return;
        const rect = bubble.getBoundingClientRect();
        popBubbleAtPosition(bubble, rect.left + rect.width/2, rect.top + rect.height/2);
        speakText(text);
        if (app.currentContext) trackUsage(app.currentContext, text);
        app.renderStats();
        // Reinflate
        const origClass = bubble.className.replace(' fitting','');
        const parent = bubble.parentElement;
        setTimeout(() => {
            bubble.remove();
            setTimeout(() => {
                if (parent) {
                    const newB = document.createElement('div');
                    newB.className = origClass;
                    newB.dataset.text = text;
                    newB.textContent = text;
                    parent.appendChild(newB);
                }
            }, 1500);
        }, 400);
    });

    container.addEventListener('touchstart', (e) => {
        const bubble = e.target.closest('.bubble');
        if (!bubble) return;
        
        const touch = e.touches[0];
        const rect = bubble.getBoundingClientRect();
        startX = touch.clientX;
        startY = touch.clientY;
        offsetX = touch.clientX - rect.left - rect.width/2;
        offsetY = touch.clientY - rect.top - rect.height/2;
        dragEl = bubble;
        isDragging = false;
        didLongPress = false;
        
        // Long-press detection — 500ms hold opens edit modal
        bubble.classList.add('hold-active');
        holdTimer = setTimeout(() => {
            if (dragEl === bubble && !isDragging) {
                didLongPress = true;
                bubble.classList.remove('hold-active');
                const text = bubble.dataset.text || bubble.textContent;
                app.openEditPhrase(text);
                dragEl = null;
            }
        }, 500);
        
        // Visual feedback — bubble knows it's being held
        setTimeout(() => {
            if (dragEl === bubble) {
                bubble.classList.add('nearby');
            }
        }, 100);
    }, {passive:true});

    container.addEventListener('touchmove', (e) => {
        if (!dragEl) return;
        const touch = e.touches[0];
        const dx = touch.clientX - startX;
        const dy = touch.clientY - startY;
        
        // Start drag after 8px movement (prevents accidental drags)
        if (!isDragging && Math.sqrt(dx*dx + dy*dy) > 8) {
            isDragging = true;
            clearTimeout(holdTimer);
            dragEl?.classList.remove('hold-active');
            // Create a floating clone to drag
            dragClone = dragEl.cloneNode(true);
            dragClone.className = dragEl.className + ' dragging';
            dragClone.style.position = 'fixed';
            dragClone.style.margin = '0';
            dragClone.style.zIndex = '500';
            dragClone.style.pointerEvents = 'none';
            document.body.appendChild(dragClone);
            // Dim the original
            dragEl.classList.add('dimmed');
            dragEl.classList.remove('nearby');
            // Dim siblings
            container.querySelectorAll('.bubble').forEach(b => {
                if (b !== dragEl) b.classList.add('dimmed');
            });
        }
        
        if (isDragging && dragClone) {
            e.preventDefault();
            const x = touch.clientX - offsetX;
            const y = touch.clientY - offsetY;
            dragClone.style.left = x - dragClone.offsetWidth/2 + 'px';
            dragClone.style.top = y - dragClone.offsetHeight/2 + 'px';
            
            // Check proximity to speak zone
            const speakZone = document.getElementById('speakZone');
            if (speakZone) {
                const zr = speakZone.getBoundingClientRect();
                const withinZone = touch.clientY > zr.top - 30 && touch.clientY < zr.bottom + 10 && touch.clientX > zr.left - 20 && touch.clientX < zr.right + 20;
                speakZone.classList.toggle('drag-hover', withinZone);
            }
        }
    }, {passive:false});

    container.addEventListener('touchend', (e) => {
        clearTimeout(holdTimer);
        dragEl?.classList.remove('hold-active');
        if (!dragEl || didLongPress) { dragEl = null; return; }
        const touch = e.changedTouches[0];
        
        if (isDragging && dragClone) {
            // Check if dropped on speak zone
            const speakZone = document.getElementById('speakZone');
            let landed = false;
            if (speakZone) {
                const zr = speakZone.getBoundingClientRect();
                const withinZone = touch.clientY > zr.top - 30 && touch.clientY < zr.bottom + 10 && touch.clientX > zr.left - 20 && touch.clientX < zr.right + 20;
                speakZone.classList.remove('drag-hover');
                
                if (withinZone) {
                    // SPEAK! — bubble fits into zone
                    touchHandled = true;
                    const text = dragEl.dataset.text || dragEl.textContent.trim();
                    const cx = touch.clientX, cy = touch.clientY;
                    popBubbleAtPosition(dragClone, cx, cy);
                    speakText(text);
                    if (app.currentContext) trackUsage(app.currentContext, text);
                    logFeedback('up', text);
                    app.renderStats();
                    landed = true;
                    
                    // Remove original, reinflate after delay
                    const origText = text;
                    const origClass = dragEl.className.replace(' dimmed','');
                    const parent = dragEl.parentElement;
                    dragEl.remove();
                    setTimeout(() => {
                        if (parent) {
                            const newB = document.createElement('div');
                            newB.className = origClass;
                            newB.dataset.text = origText;
                            newB.textContent = origText;
                            parent.appendChild(newB);
                        }
                    }, 2000);
                    
                    setTimeout(() => dragClone.remove(), 400);
                }
            }
            
            if (!landed) {
                // Not dropped on zone — snap back
                dragClone.remove();
                dragEl.classList.remove('dimmed');
            }
            
            // Un-dim all siblings
            container.querySelectorAll('.bubble').forEach(b => b.classList.remove('dimmed'));
        } else {
            // It was a tap (no drag) — speak via touch
            touchHandled = true; // prevent click from double-firing
            const text = dragEl.dataset.text || dragEl.textContent.trim();
            const rect = dragEl.getBoundingClientRect();
            popBubbleAtPosition(dragEl, rect.left + rect.width/2, rect.top + rect.height/2);
            speakText(text);
            if (app.currentContext) trackUsage(app.currentContext, text);
            app.renderStats();
            
            const origText = text;
            const origClass = dragEl.className.replace(' nearby','');
            const parent = dragEl.parentElement;
            setTimeout(() => {
                dragEl.remove();
                setTimeout(() => {
                    if (parent) {
                        const newB = document.createElement('div');
                        newB.className = origClass;
                        newB.dataset.text = origText;
                        newB.textContent = origText;
                        parent.appendChild(newB);
                    }
                }, 1500);
            }, 400);
        }
        
        dragEl?.classList.remove('nearby');
        dragEl = null;
        dragClone = null;
        isDragging = false;
    }, {passive:true});
}

// Legacy compat — bubblePop for non-drag areas
function bubblePop(el, text, callback) {
    const rect = el.getBoundingClientRect();
    popBubbleAtPosition(el, rect.left + rect.width/2, rect.top + rect.height/2);
    setTimeout(() => { if (callback) callback(el); }, 350);
}

function updateSuggestedStrip() {
    const strip = document.getElementById('suggestedStrip');
    const container = document.getElementById('suggestedCards');
    if (suggestedPhrases.length > 0) {
        strip.classList.add('visible');
        // If we have strong contextual matches (score >= 10), show expanded wrapping view
        const strongMatches = suggestedPhrases.filter(s => s.score >= 10);
        const isExpanded = strongMatches.length >= 2;
        if (isExpanded) {
            container.classList.remove('scroll-horizontal');
            container.style.flexWrap = 'wrap';
            container.style.overflow = 'visible';
            strip.querySelector('.suggested-label').textContent = '✨ CONTEXTUAL SUGGESTIONS — tap to speak';
        } else {
            container.classList.add('scroll-horizontal');
            container.style.flexWrap = '';
            container.style.overflow = '';
            strip.querySelector('.suggested-label').textContent = '✨ SUGGESTIONS';
        }
        container.innerHTML = suggestedPhrases.map((s, i) => {
            const escaped = s.card.text.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            const theme = getThemeForSource(s.source);
            const conf = getConfidenceClass(s.score);
            const isVirtual = s.virtual ? ' virtual' : '';
            return `<div class="suggested-wrap">
                <div class="bubble ${theme} ${conf}${isVirtual}" data-text="${escaped}" onclick="app.tapSuggestion(this,'${escaped}'${s.virtual?',true':''})">${s.card.text}</div>
                <div class="fb-row" id="fb_${i}">
                    <button class="fb-btn fb-up" onclick="event.stopPropagation();logFeedback('up','${escaped}');document.getElementById('fb_${i}').innerHTML='<span class=fb-done>✅</span>';">👍</button>
                    <button class="fb-btn fb-down" onclick="event.stopPropagation();logFeedback('down','${escaped}');document.getElementById('fb_${i}').innerHTML='<span class=fb-done>❌</span>';">👎</button>
                </div>
            </div>`;
        }).join('');
    } else {
        strip.classList.remove('visible');
    }
}

function reorderCardsFromSuggestions() {
    // Inject strong suggestions directly into the bubble field
    const bubbleField = document.getElementById('cardBubbleField');
    if (!bubbleField) return;

    // Get all contextual suggestions (virtual + cross-context + matched)
    const contextualSuggestions = suggestedPhrases
        .filter(s => s.score >= 8)  // Only strong matches (matrix match + topic match)
        .slice(0, 12);  // Up to 12 contextual suggestions

    if (contextualSuggestions.length === 0) return;

    // Build contextual bubble HTML
    const contextBubbles = contextualSuggestions.map(s => {
        const escaped = s.card.text.replace(/'/g, "\\'").replace(/"/g, '&quot;');
        const theme = getThemeForSource(s.source);
        return `<div class="bubble ${theme}" data-text="${escaped}">${s.card.text}</div>`;
    }).join('');

    // Get existing bubbles text to remove dupes
    const suggestionTexts = new Set(contextualSuggestions.map(s => s.card.text));

    // Remove any existing contextual section
    const existingSection = bubbleField.querySelector('.contextual-section');
    if (existingSection) existingSection.remove();

    // Remove duplicates from main bubbles
    bubbleField.querySelectorAll('.bubble').forEach(b => {
        if (suggestionTexts.has(b.dataset.text || b.textContent.trim())) {
            b.remove();
        }
    });

    // Insert contextual section at top
    const section = document.createElement('div');
    section.className = 'contextual-section';
    section.innerHTML = `<div class="contextual-label">💬 Relevant to this conversation</div>
        <div class="bubble-field contextual-bubbles">${contextBubbles}</div>
        <div class="contextual-divider"></div>`;
    bubbleField.insertBefore(section, bubbleField.firstChild);

    // Init drag on the new contextual bubble field
    initBubbleDrag(section.querySelector('.contextual-bubbles'));
}

function updateTranscriptDisplay(text) {
    const el = document.getElementById('transcriptText');
    if (!el) return;
    let html = text;
    detectedKeywords.forEach(kw => {
        const regex = new RegExp(`\\b(${kw.word})\\b`, 'gi');
        html = html.replace(regex, '<span class="keyword">$1</span>');
    });
    el.innerHTML = html || 'Listening...';
}

// ============================================================
// APP CONTROLLER
// ============================================================
const app = {
    currentContext: null,
    currentCategory: 'all',
    cards: [],
    filteredCards: [],
    index: 0,
    touchStartX: 0, touchStartY: 0, swiping: false,
    modalCategory: null,

    init() {
        this.renderHome();
        this.setupSwipe();
        checkInstallBanner();
    },

    // Quick speak — for Yes/No bar, speaks immediately
    quickSpeak(text) {
        speakText(text);
        trackUsage('quick', text);
    },

    // Conversation Listening
    toggleListening() {
        if (isListening) stopListening();
        else startListening();
    },

    toggleTranscript() {
        const panel = document.getElementById('transcriptPanel');
        panel.classList.toggle('open');
    },

    speakBubble(el, text, isVirtual) {
        // Pop the bubble, then speak
        bubblePop(el, text, (poppedEl) => {
            // After pop animation, inflate a new bubble in its place
            const container = poppedEl.parentElement;
            poppedEl.remove();
            
            // Speak the text
            speakText(text);
            if (this.currentContext) trackUsage(this.currentContext, text);
            logFeedback('up', text); // Auto-log as positive since they chose it
            this.renderStats();
            
            // If virtual card, auto-add
            if (isVirtual && this.currentContext) {
                addCustomCard(this.currentContext, text, 'choices');
                this.cards = getCardsForContext(this.currentContext);
                this.filteredCards = this.currentCategory === 'all' ? [...this.cards] : this.cards.filter(c => c.cat === this.currentCategory);
            }
            
            // Inflate a replacement bubble from remaining suggestions or next best
            setTimeout(() => {
                this.inflateReplacementBubble(container, text);
            }, 200);
        });
    },

    inflateReplacementBubble(container, spokenText) {
        // Find a card from the context that isn't already showing
        const showing = new Set([...container.querySelectorAll('.bubble')].map(b => b.dataset.text));
        showing.add(spokenText);
        const allCards = this.filteredCards || this.cards || [];
        const replacement = allCards.find(c => !showing.has(c.text));
        if (replacement) {
            const escaped = replacement.text.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            const div = document.createElement('div');
            div.className = 'bubble theme-suggestion confidence-med';
            div.dataset.text = escaped;
            div.textContent = replacement.text;
            div.onclick = () => this.speakBubble(div, replacement.text);
            container.appendChild(div);
        }
    },

    cardBubbleTap(el, text) {
        bubblePop(el, text, (poppedEl) => {
            const container = poppedEl.parentElement;
            poppedEl.remove();
            speakText(text);
            if (this.currentContext) trackUsage(this.currentContext, text);
            this.renderStats();
            
            // Re-inflate the same bubble after TTS finishes (so Ryan can say it again later)
            setTimeout(() => {
                const escaped = text.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const div = document.createElement('div');
                div.className = 'bubble theme-card';
                div.dataset.text = escaped;
                div.textContent = text;
                div.onclick = () => this.cardBubbleTap(div, text);
                container.appendChild(div);
            }, 2000);
        });
    },

    // Sentence builder
    addToSentence(text) {
        sentencePhrases.push(text);
        const builder = document.getElementById('sentenceBuilder');
        const container = document.getElementById('sentencePhrases');
        builder.classList.add('visible');
        container.innerHTML = sentencePhrases.map((p, i) =>
            `<div class="sentence-phrase" onclick="app.removeSentencePhrase(${i})">${p}</div>`
        ).join('');
    },

    removeSentencePhrase(index) {
        sentencePhrases.splice(index, 1);
        if (sentencePhrases.length === 0) {
            document.getElementById('sentenceBuilder').classList.remove('visible');
        } else {
            document.getElementById('sentencePhrases').innerHTML = sentencePhrases.map((p, i) =>
                `<div class="sentence-phrase" onclick="app.removeSentencePhrase(${i})">${p}</div>`
            ).join('');
        }
    },

    speakSentence() {
        if (sentencePhrases.length === 0) return;
        const full = sentencePhrases.join('. ');
        speakText(full);
        if (this.currentContext) trackUsage(this.currentContext, full);
        showToast(`🔊 Speaking ${sentencePhrases.length} phrases`);
    },

    clearSentence() {
        sentencePhrases = [];
        document.getElementById('sentenceBuilder').classList.remove('visible');
        document.getElementById('sentencePhrases').innerHTML = '';
    },

    tapSuggestion(el, text, isVirtual) {
        // Pop animation on the bubble
        const rect = el.getBoundingClientRect();
        popBubbleAtPosition(el, rect.left + rect.width/2, rect.top + rect.height/2);
        
        // Speak
        speakText(text);
        if (this.currentContext) trackUsage(this.currentContext, text);
        logFeedback('up', text);
        this.renderStats();
        
        // Virtual card — auto-add
        if (isVirtual && this.currentContext) {
            addCustomCard(this.currentContext, text, 'choices');
            this.cards = getCardsForContext(this.currentContext);
            this.filteredCards = this.currentCategory === 'all' ? [...this.cards] : this.cards.filter(c => c.cat === this.currentCategory);
            showToast('✅ Added to your phrases');
        }
        
        // Remove the wrapper after pop
        const wrap = el.closest('.suggested-wrap');
        setTimeout(() => { if (wrap) wrap.remove(); }, 400);
    },

    speakSuggested(text, isVirtual) {
        speakText(text);
        if (this.currentContext) trackUsage(this.currentContext, text);
        this.renderStats();
        if (isVirtual && this.currentContext) {
            addCustomCard(this.currentContext, text, 'choices');
            this.cards = getCardsForContext(this.currentContext);
            this.filteredCards = this.currentCategory === 'all' ? [...this.cards] : this.cards.filter(c => c.cat === this.currentCategory);
            showToast('✅ Added to your phrases');
        }
    },

    // SOS Dashboard
    openSOS() {
        document.getElementById('contextBadge').textContent = '⚡ Quick SOS';
        document.getElementById('backBtn').classList.add('visible');
        this.renderSOSDashboard();
        this.showScreen('sosScreen');
    },

    renderSOSDashboard() {
        const groups = [
            { id:'needs', label:'🎯 I Need', icon:'🎯', color:'needs', phrases:[
                {icon:'🤫',text:'I need a quiet space.',full:true},
                {icon:'⏰',text:'I need a break. 5 minutes.'},
                {icon:'💧',text:'I need water.'},
                {icon:'🚽',text:'I need the bathroom.'},
                {icon:'🏠',text:'I need to go home.'},
                {icon:'🧸',text:'I need my comfort item.'},
                {icon:'💺',text:'I need to sit down.'},
                {icon:'🏃',text:'I need to move around.'},
                {icon:'👤',text:'I need someone I trust.'},
                {icon:'🔄',text:'I need my calming routine.'},
            ]},
            { id:'overwhelm', label:'🌊 Overwhelmed', icon:'🌊', color:'overwhelm', phrases:[
                {icon:'🆘',text:'Everything is too much right now.',full:true},
                {icon:'🚪',text:'I need to leave right now.',full:true},
                {icon:'🛑',text:'I\'m about to have a meltdown.',full:true},
                {icon:'↔️',text:'I need space. Please step back.'},
                {icon:'⏸️',text:'I\'m shutting down. Give me time.'},
                {icon:'🤐',text:'Stop talking to me for a moment.'},
                {icon:'🧘',text:'I\'m trying to calm down.'},
                {icon:'🧠',text:'I can\'t think clearly right now.'},
                {icon:'👥',text:'Too many people.'},
            ]},
            { id:'sound', label:'🔊 Sound', icon:'🔊', color:'sound', phrases:[
                {icon:'🔇',text:'It\'s too loud in here.'},
                {icon:'🎧',text:'I need my headphones.'},
                {icon:'🤫',text:'Please stop that noise.'},
                {icon:'📢',text:'Turn the volume down.'},
                {icon:'😣',text:'That noise hurts my ears.'},
                {icon:'🏃',text:'Can we go somewhere quieter?'},
            ]},
            { id:'smell', label:'👃 Smell', icon:'👃', color:'smell', phrases:[
                {icon:'🤢',text:'That smell is making me sick.'},
                {icon:'💨',text:'I need fresh air.'},
                {icon:'🚫',text:'That perfume is too strong.'},
                {icon:'🍳',text:'The food smell is too much.'},
                {icon:'🏃',text:'Can we move away from here?'},
            ]},
            { id:'light', label:'💡 Light & Visual', icon:'💡', color:'light', phrases:[
                {icon:'😎',text:'The light is too bright.'},
                {icon:'⚡',text:'That flickering is bothering me.'},
                {icon:'🙈',text:'Too much going on visually.'},
                {icon:'👁️',text:'I need to close my eyes.'},
            ]},
            { id:'touch', label:'✋ Touch & Texture', icon:'✋', color:'touch', phrases:[
                {icon:'🚫',text:'Don\'t touch me right now.'},
                {icon:'👕',text:'These clothes are bothering me.'},
                {icon:'💺',text:'The seat feels wrong.'},
                {icon:'😖',text:'This texture is uncomfortable.'},
            ]},
            { id:'explain', label:'💬 Explain to Others', icon:'💬', color:'explain', phrases:[
                {icon:'🧩',text:'I\'m autistic. I process differently.',full:true},
                {icon:'💙',text:'I\'m not rude, I\'m overwhelmed.',full:true},
                {icon:'⏳',text:'I need more time to respond.'},
                {icon:'📱',text:'I communicate using this app.'},
                {icon:'🤝',text:'Please be patient with me.'},
                {icon:'👂',text:'I hear you. I can\'t respond yet.'},
                {icon:'🔇',text:'Loud noises physically hurt me.'},
                {icon:'👃',text:'Strong smells make me feel sick.'},
            ]},
        ];

        let html = '<div class="speak-zone" id="speakZone"><span class="zone-icon">🔊</span><span>Drag here to speak</span></div>';
        groups.forEach(g => {
            html += `<div class="sos-group ${g.color}">`;
            html += `<div class="sos-group-label ${g.color}">${g.label}</div>`;
            html += `<div class="bubble-field" data-sos-group="${g.id}">`;
            g.phrases.forEach(p => {
                const escaped = p.text.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                html += `<div class="bubble theme-sos-${g.id}" data-text="${escaped}">${p.icon} ${p.text}</div>`;
            });
            html += `</div></div>`;
        });
        document.getElementById('sosContent').innerHTML = html;
        // Init drag on each SOS group's bubble field
        document.querySelectorAll('#sosContent .bubble-field').forEach(bf => initBubbleDrag(bf));
    },

    sosBubbleTap(el, text) {
        bubblePop(el, text, (poppedEl) => {
            const container = poppedEl.parentElement;
            poppedEl.remove();
            speakText(text);
            trackUsage('sensory', text);
            // SOS phrases regenerate — re-add after a brief delay
            setTimeout(() => {
                const escaped = text.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                const theme = container.closest('.sos-group')?.classList[1] || 'needs';
                const div = document.createElement('div');
                div.className = `bubble theme-sos-${theme}`;
                div.dataset.text = escaped;
                div.textContent = poppedEl.textContent;
                div.onclick = () => this.sosBubbleTap(div, text);
                container.appendChild(div);
            }, 1500);
        });
    },

    sosTap(el, text) {
        // Legacy fallback
        speakText(text);
        trackUsage('sensory', text);
        setTimeout(() => el.classList.remove('speaking-active'), 2000);
    },

    // ===== TOPIC LAUNCHER =====
    openTopicLauncher() {
        document.getElementById('contextBadge').textContent = '🗣️ Start Talking';
        document.getElementById('backBtn').classList.add('visible');
        this.renderTopicGrid();
        this.showScreen('topicLaunchScreen');
        // Start listening immediately so we don't miss any speech
        startListening();
    },

    renderTopicGrid() {
        const groups = [
            {label:'Daily Living', topics:[
                {id:'food',     icon:'🍕', name:'Food'},
                {id:'drink',    icon:'🥤', name:'Drink'},
                {id:'hygiene',  icon:'🚿', name:'Hygiene'},
                {id:'sleep',    icon:'😴', name:'Sleep'},
                {id:'chores',   icon:'🧹', name:'Chores'},
                {id:'health',   icon:'🏥', name:'Health'},
                {id:'cooking',  icon:'👨‍🍳', name:'Cooking'},
                {id:'weather',  icon:'☀️', name:'Weather'},
            ]},
            {label:'Practical', topics:[
                {id:'transport', icon:'🚗', name:'Transport'},
                {id:'shopping',  icon:'🛒', name:'Shopping'},
                {id:'money',     icon:'💰', name:'Money'},
                {id:'time',      icon:'⏰', name:'Time'},
                {id:'technology',icon:'📱', name:'Tech'},
                {id:'appearance',icon:'👕', name:'Clothes'},
                {id:'holidays',  icon:'🎉', name:'Holidays'},
            ]},
            {label:'Academic', topics:[
                {id:'math',    icon:'📐', name:'Maths'},
                {id:'english', icon:'📖', name:'English'},
                {id:'science', icon:'🔬', name:'Science'},
                {id:'school',  icon:'🏫', name:'School'},
                {id:'story',   icon:'📚', name:'Story'},
            ]},
            {label:'Social', topics:[
                {id:'friends',   icon:'👫', name:'Friends'},
                {id:'gaming',    icon:'🎮', name:'Gaming'},
                {id:'movies_tv', icon:'🎬', name:'Movies'},
                {id:'music',     icon:'🎵', name:'Music'},
                {id:'sports',    icon:'⚽', name:'Sports'},
                {id:'pets',      icon:'🐕', name:'Pets'},
            ]},
            {label:'How I Feel', topics:[
                {id:'feelings', icon:'💭', name:'Feelings'},
                {id:'sensory',  icon:'🔊', name:'Sensory'},
            ]},
        ];

        const grid = document.getElementById('topicGrid');
        let html = '';
        groups.forEach(g => {
            html += `<div class="topic-group-label">${g.label}</div>`;
            g.topics.forEach(t => {
                html += `<div class="topic-tile" data-topic="${t.id}" onclick="app.selectTopic('${t.id}','${t.icon}','${t.name}')"><div class="topic-icon">${t.icon}</div><div class="topic-name">${t.name}</div></div>`;
            });
        });
        grid.innerHTML = html;
        document.getElementById('starterPanel').classList.remove('visible');
    },

    selectTopic(topicId, icon, name) {
        document.querySelectorAll('.topic-tile').forEach(t => t.classList.remove('active'));
        document.querySelector(`.topic-tile[data-topic="${topicId}"]`)?.classList.add('active');

        const starters = TOPIC_STARTERS[topicId] || TOPIC_STARTERS._default;
        const panel = document.getElementById('starterPanel');
        document.getElementById('starterHeader').textContent = `${icon} ${name} — What do you want to say?`;
        document.getElementById('starterCards').innerHTML = `<div class="bubble-field">${starters.map(s => {
            const escaped = s.text.replace(/'/g, "\\'").replace(/"/g, '&quot;');
            return `<div class="bubble theme-starter" data-text="${escaped}" onclick="app.starterBubbleTap(this,'${escaped}','${topicId}')">${s.icon || '💬'} ${s.text}</div>`;
        }).join('')}</div>`;
        panel.classList.add('visible');
        panel.scrollIntoView({behavior:'smooth', block:'nearest'});
    },

    starterBubbleTap(el, text, topicId) {
        bubblePop(el, text, (poppedEl) => {
            poppedEl.remove();
            this.speakStarter(text, topicId);
        });
    },

    speakStarter(text, topicId) {
        // Mute mic briefly while TTS speaks (so it doesn't hear itself)
        const wasListening = isListening;
        if (wasListening) stopListening();
        
        speakText(text);
        conversationMemory.remember(topicId, [topicId], 3);
        trackUsage('conversation', text);
        logTopicLaunch(topicId, text);

        const contextMap = {
            food:'home', drink:'home', hygiene:'home', sleep:'home', chores:'home', cooking:'home',
            transport:'home', shopping:'home', weather:'home', appearance:'home',
            routine:'home', bathroom:'home', body:'home',
            math:'math', english:'story', science:'school', school:'school', story:'story',
            reading:'story', art:'school', homework:'school', learning:'school',
            gaming:'gaming', movies_tv:'gaming', music:'gaming', sports:'gaming',
            friends:'conversation', feelings:'conversation', sensory:'sensory',
            money:'conversation', time:'conversation', technology:'conversation', holidays:'conversation', pets:'conversation',
            outings:'conversation', waiting:'conversation', manners:'conversation', helping:'conversation',
            choices:'conversation', emotions_complex:'conversation',
        };
        const targetContext = contextMap[topicId] || 'conversation';

        // Wait for TTS to finish, then immediately load context and resume listening
        const checkTTS = setInterval(() => {
            if (!speechSynthesis.speaking) {
                clearInterval(checkTTS);
                this.loadContext(targetContext);
                // Resume listening immediately — don't miss the response
                startListening();
            }
        }, 100);
        
        // Safety: if TTS takes too long (>5s), load context anyway
        setTimeout(() => {
            clearInterval(checkTTS);
            if (this.currentContext !== targetContext) {
                this.loadContext(targetContext);
            }
            if (!isListening) startListening();
        }, 5000);
    },

    renderHome() {
        const grid = document.getElementById('contextGrid');
        const groups = {urgent:'', life:''};
        let html = '';
        
        // HERO TILES — full-width, centered text
        const urgentCtxs = CONTEXTS.filter(c => c.group === 'urgent');
        urgentCtxs.forEach(ctx => {
            const count = CARD_DATA[ctx.id]?.cards?.length || 0;
            const customCount = (loadData().customCards[ctx.id] || []).length;
            const total = count + customCount;
            let action, heroClass, sub;
            if (ctx.id === 'sensory') {
                action = `app.openSOS()`;
                heroClass = 'sos-hero';
                sub = `${total} phrases — sensory, overwhelm, needs`;
            } else if (ctx.id === 'topicLaunch') {
                action = `app.openTopicLauncher()`;
                heroClass = 'talk-hero';
                sub = 'Pick a topic and start a conversation';
            } else if (ctx.id === 'conversation') {
                action = `app.loadContext('conversation')`;
                heroClass = 'convo-hero';
                sub = total ? `${total} phrases` : '';
            } else return;
            html += `<div class="${heroClass}" onclick="${action}">
                <div class="hero-icon">${ctx.icon}</div>
                <div class="hero-label">${ctx.label}</div>
                ${sub ? `<div class="hero-sub">${sub}</div>` : ''}
            </div>`;
        });
        
        // GRID TILES — School, Home, Malayalam, Settings in a row
        const lifeCtxs = CONTEXTS.filter(c => c.group === 'life');
        if (lifeCtxs.length) {
            html += `<div class="context-grid">`;
            html += lifeCtxs.map(ctx => {
                const count = CARD_DATA[ctx.id]?.cards?.length || 0;
                const customCount = (loadData().customCards[ctx.id] || []).length;
                const total = count + customCount;
                let action;
                if (ctx.id === 'settings') action = `app.openSettings()`;
                else action = `app.loadContext('${ctx.id}')`;
                return `<div class="context-tile" onclick="${action}"><div class="tile-icon">${ctx.icon}</div><div><div class="tile-label">${ctx.label}</div>${total?`<div class="tile-count">${total} phrases</div>`:''}</div></div>`;
            }).join('');
            html += '</div>';
        }
        
        grid.innerHTML = html;
    },

    loadContext(id) {
        this.currentContext = id;
        this.currentCategory = 'all';
        this.cards = getCardsForContext(id);
        this.filteredCards = [...this.cards];
        this.index = 0;
        const ctx = CARD_DATA[id];
        document.getElementById('contextBadge').textContent = ctx.label;
        document.getElementById('backBtn').classList.add('visible');
        this.renderCategories(ctx.categories);
        this.renderStats();
        this.showScreen('swipeScreen');
        this.updateCard();
        this.updatePredictionHints();

        // Auto-suggest preferred category if strong preference detected
        const pref = getPreferredCategory(id);
        if (pref && pref.share > 55) {
            showToast(`Tip: you often use ${pref.category} (${pref.share}%) here`);
        }
    },

    renderCategories(cats) {
        const bar = document.getElementById('categoryBar');
        bar.innerHTML = `<button class="cat-btn active" data-cat="all" onclick="app.filterCat('all',this)">All</button>` +
            cats.map(c => `<button class="cat-btn" data-cat="${c}" onclick="app.filterCat('${c}',this)">${c[0].toUpperCase()+c.slice(1)}</button>`).join('');
    },

    renderStats() {
        const bar = document.getElementById('statsBar');
        const stats = getUsageStats();
        const ctxCount = stats.contexts[this.currentContext] || 0;
        bar.innerHTML = `<div class="stat-chip">Total spoken: <span class="stat-val">${stats.total}</span></div>` +
            `<div class="stat-chip">This context: <span class="stat-val">${ctxCount}</span></div>` +
            `<div class="stat-chip">Cards: <span class="stat-val">${this.cards.length}</span></div>`;
    },

    filterCat(cat, el) {
        this.currentCategory = cat;
        this.filteredCards = cat === 'all' ? [...this.cards] : this.cards.filter(c => c.cat === cat);
        this.index = 0;
        document.querySelectorAll('.cat-btn').forEach(b => b.classList.remove('active'));
        if (el) el.classList.add('active');
        this.updateCard();
    },

    updateCard() {
        const fc = this.filteredCards;

        // === BUBBLE VIEW: render all cards as bubbles ===
        const bubbleField = document.getElementById('cardBubbleField');
        if (bubbleField) {
            if (!fc.length) {
                bubbleField.innerHTML = '<div style="color:var(--text-muted);text-align:center;padding:40px;">No phrases here yet.</div>';
            } else {
                const d = loadData();
                bubbleField.innerHTML = fc.map(card => {
                    const escaped = card.text.replace(/'/g, "\\'").replace(/"/g, '&quot;');
                    const useCount = getCardScore(this.currentContext, card.text);
                    const levelled = useCount >= 10 ? ' levelled' : '';
                    const customCls = card.custom ? ' custom-phrase' : '';
                    return `<div class="bubble theme-card${levelled}${customCls}" data-text="${escaped}">${card.text}</div>`;
                }).join('');
                initBubbleDrag(bubbleField);
            }
        }

        // === SWIPE VIEW (kept for fallback) ===
        const subEl = document.getElementById('phraseSub');
        const freqEl = document.getElementById('cardFreqBadge');
        subEl.style.display = 'none';
        freqEl.classList.remove('visible');

        if (!fc.length) {
            document.getElementById('phraseText').textContent = "No phrases here yet.";
            document.getElementById('cardCatTag').textContent = "";
            document.getElementById('cardCounter').textContent = "";
            document.getElementById('cardDots').innerHTML = "";
            document.getElementById('prevArrow').disabled = true;
            document.getElementById('nextArrow').disabled = true;
            return;
        }
        const card = fc[this.index];
        document.getElementById('phraseText').textContent = card.text;
        document.getElementById('cardCatTag').textContent = card.cat;
        document.getElementById('cardCounter').textContent = `${this.index+1} of ${fc.length}`;
        document.getElementById('prevArrow').disabled = this.index === 0;
        document.getElementById('nextArrow').disabled = this.index === fc.length - 1;

        // Show transliteration for Malayalam
        if (card.sub) {
            subEl.textContent = card.sub;
            subEl.style.display = 'block';
        }

        // Show adaptive prediction badges (Phase 2D)
        const adaptiveScore = getAdaptiveScore(this.currentContext, card.text, card.cat);
        const seqPredictions = getSequencePredictions(this.currentContext, 5);
        const isSequenceMatch = seqPredictions.some(s => s.text === card.text);
        const timePredictions = getTimeOfDayPredictions(this.currentContext, 5);
        const isTimeMatch = timePredictions.some(t => t.text === card.text);
        const baseScore = getCardScore(this.currentContext, card.text);

        if (isSequenceMatch) {
            freqEl.classList.add('visible');
            freqEl.textContent = '🔗 You usually say this next';
        } else if (isTimeMatch && baseScore < 3) {
            freqEl.classList.add('visible');
            freqEl.textContent = '🕐 Common at this time';
        } else if (baseScore >= 3) {
            freqEl.classList.add('visible');
            freqEl.textContent = '⭐ Favourite';
        } else if (baseScore >= 1) {
            freqEl.classList.add('visible');
            freqEl.textContent = '📊 Used ' + Math.round(baseScore) + '×';
        }

        this.updateDots();
    },

    updateDots() {
        const total = this.filteredCards.length;
        const max = Math.min(total, 9);
        let html = '';
        for (let i = 0; i < max; i++) {
            html += `<div class="dot${i === Math.min(this.index, max-1) ? ' active' : ''}"></div>`;
        }
        document.getElementById('cardDots').innerHTML = html;
    },

    next() {
        if (this.index < this.filteredCards.length - 1) { this.index++; this.animateCard('left'); }
    },
    prev() {
        if (this.index > 0) { this.index--; this.animateCard('right'); }
    },
    animateCard(dir) {
        const c = document.getElementById('phraseCard');
        c.style.transition = 'transform 0.15s ease,opacity 0.15s ease';
        c.style.transform = `translateX(${dir==='left'?'-30':'30'}px)`; c.style.opacity = '0.5';
        setTimeout(() => {
            this.updateCard();
            c.style.transition = 'none';
            c.style.transform = `translateX(${dir==='left'?'30':'-30'}px)`; c.style.opacity = '0.5';
            requestAnimationFrame(() => {
                c.style.transition = 'transform 0.2s ease,opacity 0.2s ease';
                c.style.transform = 'translateX(0)'; c.style.opacity = '1';
            });
        }, 150);
    },

    setupSwipe() {
        const vp = document.getElementById('cardViewport');
        vp.addEventListener('touchstart', e => { this.touchStartX = e.changedTouches[0].clientX; this.touchStartY = e.changedTouches[0].clientY; this.swiping = false; }, {passive:true});
        vp.addEventListener('touchmove', e => { const dx = Math.abs(e.changedTouches[0].clientX - this.touchStartX); const dy = Math.abs(e.changedTouches[0].clientY - this.touchStartY); if (dx > 10 && dx > dy) this.swiping = true; }, {passive:true});
        vp.addEventListener('touchend', e => { if (!this.swiping) return; const dx = this.touchStartX - e.changedTouches[0].clientX; const dy = Math.abs(this.touchStartY - e.changedTouches[0].clientY); if (Math.abs(dx) > 40 && dy < 120) { dx > 0 ? this.next() : this.prev(); } }, {passive:true});
        document.addEventListener('keydown', e => { if (this.currentContext) { if (e.key==='ArrowLeft') this.prev(); if (e.key==='ArrowRight') this.next(); } });
    },

    speak() {
        const fc = this.filteredCards;
        const card = fc[this.index];
        const text = document.getElementById('phraseText').textContent;
        if (text && !['Loading...','No phrases here yet.'].includes(text)) {
            // Track usage with category for Phase 2D adaptive learning
            if (this.currentContext) trackUsage(this.currentContext, text, card?.cat);
            this.renderStats();
            this.updatePredictionHints();

            if (!speakText(text)) showToast('✓ ' + text);
        }
    },

    // ADD PHRASE
    openAddPhrase() {
        if (!this.currentContext) return;
        const cats = CARD_DATA[this.currentContext].categories;
        this.modalCategory = cats[0];
        document.getElementById('modalCategorySelect').innerHTML = cats.map(c =>
            `<button class="modal-cat-opt${c===this.modalCategory?' selected':''}" onclick="app.setModalCat('${c}',this)">${c[0].toUpperCase()+c.slice(1)}</button>`
        ).join('');
        document.getElementById('phraseInput').value = '';
        document.getElementById('addPhraseModal').classList.add('open');
        setTimeout(() => document.getElementById('phraseInput').focus(), 350);
    },
    setModalCat(cat, el) { this.modalCategory = cat; document.querySelectorAll('.modal-cat-opt').forEach(b => b.classList.remove('selected')); el.classList.add('selected'); },
    closeAddPhrase() { document.getElementById('addPhraseModal').classList.remove('open'); },

    // ===== EDIT / DELETE PHRASES =====
    _editOriginalText: '',
    _editIsCustom: false,
    _editCustomIndex: -1,

    openEditPhrase(text) {
        if (!this.currentContext) return;
        const d = loadData();
        const customCards = d.customCards[this.currentContext] || [];
        const customIdx = customCards.findIndex(c => c.text === text);
        const isCustom = customIdx >= 0;
        const builtInCard = CARD_DATA[this.currentContext]?.cards?.find(c => c.text === text);

        this._editOriginalText = text;
        this._editIsCustom = isCustom;
        this._editCustomIndex = customIdx;

        // Populate modal
        document.getElementById('editPhraseInput').value = text;
        if (isCustom) {
            document.getElementById('editModalTitle').textContent = '✎ Edit Your Phrase';
            document.getElementById('editModalDesc').textContent = 'Change the wording or delete this phrase.';
        } else {
            document.getElementById('editModalTitle').textContent = '✎ Personalise Phrase';
            document.getElementById('editModalDesc').textContent = 'Edit to make it sound more like you, or hide it.';
        }

        // Category select
        const cats = CARD_DATA[this.currentContext]?.categories || ['general'];
        const currentCat = isCustom ? customCards[customIdx].cat : (builtInCard?.cat || cats[0]);
        this._editCategory = currentCat;
        document.getElementById('editCategorySelect').innerHTML = cats.map(c =>
            `<button class="modal-cat-opt${c===currentCat?' selected':''}" onclick="app._editCategory='${c}';document.querySelectorAll('#editCategorySelect .modal-cat-opt').forEach(b=>b.classList.remove('selected'));this.classList.add('selected');">${c[0].toUpperCase()+c.slice(1)}</button>`
        ).join('');

        document.getElementById('editPhraseModal').classList.add('open');
        setTimeout(() => document.getElementById('editPhraseInput').focus(), 350);
    },

    closeEditPhrase() { document.getElementById('editPhraseModal').classList.remove('open'); },

    saveEditPhrase() {
        const newText = document.getElementById('editPhraseInput').value.trim();
        if (!newText) { showToast('Phrase cannot be empty'); return; }
        const d = loadData();
        const ctx = this.currentContext;

        if (this._editIsCustom && this._editCustomIndex >= 0) {
            // Edit existing custom card
            d.customCards[ctx][this._editCustomIndex].text = newText;
            d.customCards[ctx][this._editCustomIndex].cat = this._editCategory;
        } else {
            // Built-in card — hide original and add edited version as custom
            if (!d.hiddenCards) d.hiddenCards = {};
            if (!d.hiddenCards[ctx]) d.hiddenCards[ctx] = [];
            if (!d.hiddenCards[ctx].includes(this._editOriginalText)) {
                d.hiddenCards[ctx].push(this._editOriginalText);
            }
            if (!d.customCards[ctx]) d.customCards[ctx] = [];
            d.customCards[ctx].push({text:newText, cat:this._editCategory, custom:true, editedFrom:this._editOriginalText});
        }
        saveData(d);
        this.cards = getCardsForContext(ctx);
        this.filterCat(this.currentCategory, document.querySelector(`.cat-btn[data-cat="${this.currentCategory}"]`));
        this.closeEditPhrase();
        showToast('✓ Phrase updated!', 'success');
    },

    deletePhrase() {
        const d = loadData();
        const ctx = this.currentContext;

        if (this._editIsCustom && this._editCustomIndex >= 0) {
            // Remove custom card
            d.customCards[ctx].splice(this._editCustomIndex, 1);
            showToast('🗑️ Phrase deleted', 'success');
        } else {
            // Hide built-in card
            if (!d.hiddenCards) d.hiddenCards = {};
            if (!d.hiddenCards[ctx]) d.hiddenCards[ctx] = [];
            if (!d.hiddenCards[ctx].includes(this._editOriginalText)) {
                d.hiddenCards[ctx].push(this._editOriginalText);
            }
            showToast('🗑️ Phrase hidden (can restore in Settings)', 'success');
        }
        saveData(d);
        this.cards = getCardsForContext(ctx);
        this.filterCat(this.currentCategory, document.querySelector(`.cat-btn[data-cat="${this.currentCategory}"]`));
        this.closeEditPhrase();
    },
    savePhrase() {
        const text = document.getElementById('phraseInput').value.trim();
        if (!text) { showToast('Please type a phrase first'); return; }
        addCustomCard(this.currentContext, text, this.modalCategory);
        this.cards = getCardsForContext(this.currentContext);
        this.filterCat(this.currentCategory, document.querySelector(`.cat-btn[data-cat="${this.currentCategory}"]`));
        this.closeAddPhrase();
        showToast('✓ Phrase added!', 'success');
        this.renderHome();
    },

    // PREDICTION HINTS — update the stats bar with adaptive insights
    updatePredictionHints() {
        if (!this.currentContext) return;
        const summary = getPredictionSummary(this.currentContext);
        const bar = document.getElementById('statsBar');
        const stats = getUsageStats();
        const ctxCount = stats.contexts[this.currentContext] || 0;
        let html = `<div class="stat-chip">Total: <span class="stat-val">${stats.total}</span></div>`;
        html += `<div class="stat-chip">This context: <span class="stat-val">${ctxCount}</span></div>`;
        
        // Session timer
        if (summary.session) {
            html += `<div class="stat-chip">Session: <span class="stat-val">${summary.session.minutes}m</span>${summary.session.isLong?' ⚠️':''}</div>`;
        }
        
        // Category preference
        if (summary.catPref) {
            html += `<div class="stat-chip">Prefers: <span class="stat-val">${summary.catPref.category} (${summary.catPref.share}%)</span></div>`;
        }

        bar.innerHTML = html;
    },

    // SCREEN NAV
    showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); },
    goHome() {
        this.currentContext = null;
        this.showScreen('homeScreen');
        document.getElementById('contextBadge').textContent = 'Home';
        document.getElementById('backBtn').classList.remove('visible');
        speechSynthesis.cancel();
        stopListening();
        document.getElementById('suggestedStrip').classList.remove('visible');
        document.getElementById('transcriptPanel').classList.remove('open');
        conversationTranscript = [];
        detectedKeywords = [];
        suggestedPhrases = [];
        conversationMemory.clear();
        this.renderHome();
    },

    // SETTINGS
    openSettings() {
        document.getElementById('contextBadge').textContent = '⚙️ Settings';
        document.getElementById('backBtn').classList.add('visible');
        renderVoiceSettings();
        // Render usage stats
        const stats = getUsageStats();
        const el = document.getElementById('usageStatsContent');
        let html = `<p>Total phrases spoken: <strong style="color:var(--accent-gold)">${stats.total}</strong></p>`;
        if (stats.topCards.length) {
            html += '<p style="margin-top:10px">Top phrases:</p>';
            stats.topCards.forEach(([key, u]) => {
                const txt = key.split(':').slice(1).join(':');
                html += `<p style="margin:4px 0;padding:6px 10px;background:var(--bg-elevated);border-radius:8px;font-size:13px">"${txt.substring(0,50)}${txt.length>50?'...':''}" — <span style="color:var(--accent-gold)">${u.count}×</span></p>`;
            });
        }
        el.innerHTML = html;

        // Render prediction insights (Phase 2D)
        const pi = document.getElementById('predictionInsights');
        let piHtml = '';
        const d = loadData();
        
        // Sequence patterns
        const seqCount = Object.keys(d.sequences).length;
        piHtml += `<p>🔗 Sequence patterns learned: <strong style="color:var(--accent-gold)">${seqCount}</strong></p>`;
        
        // Time buckets
        const bucketCount = Object.keys(d.hourBuckets).length;
        piHtml += `<p>🕐 Time-of-day patterns: <strong style="color:var(--accent-gold)">${bucketCount}</strong> data points</p>`;
        
        // Category preferences
        const catContexts = Object.keys(d.catPrefs).length;
        piHtml += `<p>📂 Category preferences tracked: <strong style="color:var(--accent-gold)">${catContexts}</strong> contexts</p>`;
        Object.entries(d.catPrefs).forEach(([ctx, cats]) => {
            const total = Object.values(cats).reduce((s,v) => s+v, 0);
            if (total >= 5) {
                const top = Object.entries(cats).sort((a,b) => b[1]-a[1])[0];
                const pct = Math.round(top[1]/total*100);
                piHtml += `<p style="margin:3px 0 3px 12px;font-size:12px;color:var(--text-muted)">• ${ctx}: prefers <strong>${top[0]}</strong> (${pct}%)</p>`;
            }
        });

        // Sessions
        piHtml += `<p style="margin-top:8px">📊 Sessions tracked: <strong style="color:var(--accent-gold)">${d.sessions.length}</strong></p>`;
        if (d.sessions.length > 0) {
            const avgDuration = d.sessions.reduce((s,ss) => s + (ss.lastActivity - ss.start), 0) / d.sessions.length / 60000;
            piHtml += `<p style="margin:3px 0 3px 12px;font-size:12px;color:var(--text-muted)">• Average session: ${Math.round(avgDuration)} minutes</p>`;
        }

        // Top sequences
        const topSeqs = Object.entries(d.sequences)
            .map(([key, followers]) => {
                const top = Object.entries(followers).sort((a,b) => b[1]-a[1])[0];
                if (!top || top[1] < 2) return null;
                return {a:key.split(':').slice(1).join(':'), b:top[0], count:top[1]};
            })
            .filter(Boolean)
            .sort((a,b) => b.count - a.count)
            .slice(0,5);
        if (topSeqs.length > 0) {
            piHtml += '<p style="margin-top:8px">🔗 Top phrase sequences:</p>';
            topSeqs.forEach(s => {
                piHtml += `<p style="margin:3px 0;padding:5px 10px;background:var(--bg-elevated);border-radius:8px;font-size:12px">"${s.a.substring(0,35)}…" → "${s.b.substring(0,35)}…" <span style="color:var(--accent-gold)">${s.count}×</span></p>`;
            });
        }

        pi.innerHTML = piHtml || '<p>Not enough data yet. Keep using the app!</p>';

        // Render version info
        document.getElementById('versionDisplay').textContent = `v${APP_VERSION.version} (build ${APP_VERSION.build})`;
        document.getElementById('copyrightDisplay').textContent = APP_VERSION.copyright;
        document.getElementById('changelogContent').innerHTML = APP_VERSION.changelog.map(e =>
            `<div class="vlog-entry"><span class="vlog-ver">v${e.ver}</span><span class="vlog-date">${e.date}</span><br>${e.notes}</div>`
        ).join('');

        this.showScreen('settingsScreen');
    },

    // OT Report Export
    exportOTReport() {
        const report = generateOTReport();
        navigator.clipboard.writeText(report).then(() => {
            showToast('📋 Report copied to clipboard!', 'success');
        }).catch(() => {
            // Fallback — show in a prompt
            const ta = document.createElement('textarea');
            ta.value = report; ta.style.position = 'fixed'; ta.style.left = '-9999px';
            document.body.appendChild(ta); ta.select();
            try { document.execCommand('copy'); showToast('📋 Report copied!', 'success'); }
            catch { showToast('Could not copy — try Download instead'); }
            document.body.removeChild(ta);
        });
    },

    downloadOTReport() {
        const report = generateOTReport();
        const blob = new Blob([report], {type:'text/plain'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ryans-aac-report-${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a); a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast('💾 Report downloaded!', 'success');
    },
    selectVoice(name) {
        const v = getEnglishVoices().find(v => v.name === name);
        if (!v) return;
        preferredVoice = v;
        const d = loadData(); d.preferences.voiceName = name; saveData(d);
        renderVoiceSettings();
        showToast('✓ Voice: ' + name.replace(/com\.apple\.\w+\./g,'').replace(/Microsoft\s+/g,''), 'success');
    },
    previewVoice(name) {
        const v = getEnglishVoices().find(v => v.name === name);
        if (!v) return;
        speechSynthesis.cancel();
        const u = new SpeechSynthesisUtterance("Hi, I'm Ryan's voice. This is how I sound.");
        u.voice = v; u.rate = speechRate; u.pitch = 0.95;
        speechSynthesis.speak(u);
    },
    updateSpeed(val) {
        speechRate = parseFloat(val);
        document.getElementById('speedValue').textContent = speechRate.toFixed(2) + '×';
        const d = loadData(); d.preferences.voiceRate = speechRate; saveData(d);
    },

    // ===== OT REPORT SYSTEM =====
    openReport() {
        document.getElementById('contextBadge').textContent = '🛠️ Dev Report';
        document.getElementById('backBtn').classList.add('visible');
        this.renderReport('today');
        this.showScreen('reportScreen');
    },

    renderReport(period, btnEl) {
        // Update period button state
        if (btnEl) {
            document.querySelectorAll('.report-period-btn').forEach(b => b.classList.remove('active'));
            btnEl.classList.add('active');
        }

        const d = loadData();

        const now = Date.now();
        const cutoffs = {
            today: now - 24*60*60*1000,
            week: now - 7*24*60*60*1000,
            all: 0,
        };
        const cutoff = cutoffs[period] || 0;
        const fmt = (ts) => new Date(ts).toLocaleTimeString('en-AU', {hour:'2-digit',minute:'2-digit'});
        const fmtDate = (ts) => new Date(ts).toLocaleDateString('en-AU', {weekday:'short',day:'numeric',month:'short'});

        // Filter data by period
        const sessions = d.sessions.filter(s => s.start > cutoff);
        const convoLog = d.conversationLog.filter(l => l.time > cutoff);
        const errors = d.errorLog.filter(e => e.time > cutoff);
        const fb = d.feedback.filter(f => f.time > cutoff);
        const notes = d.carerNotes.filter(n => n.time > cutoff);
        const launches = d.topicLauncherLog.filter(l => l.time > cutoff);

        let html = '';

        // ---- SUMMARY STATS ----
        const totalSpoken = convoLog.length;
        const suggestedUsed = convoLog.filter(l => l.wasSuggested).length;
        const accuracy = totalSpoken > 0 ? Math.round(suggestedUsed / totalSpoken * 100) : 0;
        const avgSession = sessions.length > 0 ? Math.round(sessions.reduce((sum,s) => sum + (s.lastActivity - s.start), 0) / sessions.length / 60000) : 0;
        const thumbsUp = fb.filter(f => f.rating === 'up').length;
        const thumbsDown = fb.filter(f => f.rating === 'down').length;

        // Topic breakdown
        const topicCounts = {};
        convoLog.forEach(l => { if (l.topic) topicCounts[l.topic] = (topicCounts[l.topic]||0) + 1; });
        const topTopics = Object.entries(topicCounts).sort((a,b) => b[1]-a[1]).slice(0,5);

        html += `<div class="report-section">
            <div class="report-section-title">📊 Summary</div>
            <div class="report-stat"><span class="report-stat-label">Sessions</span><span class="report-stat-value">${sessions.length}</span></div>
            <div class="report-stat"><span class="report-stat-label">Phrases spoken</span><span class="report-stat-value">${totalSpoken}</span></div>
            <div class="report-stat"><span class="report-stat-label">From suggestions</span><span class="report-stat-value">${suggestedUsed} (${accuracy}%)</span></div>
            <div class="report-stat"><span class="report-stat-label">From browsing cards</span><span class="report-stat-value">${totalSpoken - suggestedUsed}</span></div>
            <div class="report-stat"><span class="report-stat-label">Avg session length</span><span class="report-stat-value">${avgSession} min</span></div>
            <div class="report-stat"><span class="report-stat-label">Topic Launcher used</span><span class="report-stat-value">${launches.length} times</span></div>
            <div class="report-stat"><span class="report-stat-label">👍 Good suggestions</span><span class="report-stat-value" style="color:var(--accent-success)">${thumbsUp}</span></div>
            <div class="report-stat"><span class="report-stat-label">👎 Wrong suggestions</span><span class="report-stat-value" style="color:var(--accent-warm)">${thumbsDown}</span></div>
        </div>`;

        // ---- TOP TOPICS ----
        if (topTopics.length > 0) {
            html += `<div class="report-section"><div class="report-section-title">🎯 Top Topics</div>`;
            topTopics.forEach(([topic, count]) => {
                const pct = Math.round(count / totalSpoken * 100);
                html += `<div class="report-stat"><span class="report-stat-label">${topic}</span><span class="report-stat-value">${count} (${pct}%)</span></div>`;
            });
            html += `</div>`;
        }

        // ---- ERROR LOG ----
        if (errors.length > 0) {
            html += `<div class="report-section"><div class="report-section-title" style="color:var(--accent-warm)">❌ Errors & Issues (${errors.length})</div>`;
            errors.slice(-15).reverse().forEach(e => {
                html += `<div class="report-log-entry">
                    <span class="report-log-time">${fmtDate(e.time)} ${fmt(e.time)}</span><br>
                    <span class="report-log-heard">Heard: "${e.heard || 'unknown'}"</span><br>
                    <span class="report-log-error">Problem: ${e.problem}${e.wrongPhrase ? ' — "'+e.wrongPhrase+'"' : ''}${e.details ? ' — '+e.details : ''}</span><br>
                    <span style="color:var(--text-muted);font-size:11px">Topic: ${e.topic || 'none'} | Context: ${e.context || 'none'}</span>
                </div>`;
            });
            html += `</div>`;
        }

        // ---- CONVERSATION LOG ----
        if (convoLog.length > 0) {
            html += `<div class="report-section"><div class="report-section-title">💬 Conversation Log (last 20)</div>`;
            convoLog.slice(-20).reverse().forEach(l => {
                const sourceIcon = l.wasSuggested ? '🎯' : '📋';
                html += `<div class="report-log-entry">
                    <span class="report-log-time">${fmtDate(l.time)} ${fmt(l.time)}</span><br>
                    ${l.heard ? `<span class="report-log-heard">🎤 "${l.heard}"</span><br>` : ''}
                    <span class="report-log-chosen">${sourceIcon} Ryan said: "${l.chosen}"</span>
                    <span style="color:var(--text-muted);font-size:11px"> · ${l.source || 'browsed'} · ${l.topic || 'no topic'}</span>
                </div>`;
            });
            html += `</div>`;
        }

        // ---- FEEDBACK LOG ----
        if (fb.length > 0) {
            html += `<div class="report-section"><div class="report-section-title">👍👎 Suggestion Feedback (${fb.length})</div>`;
            fb.slice(-15).reverse().forEach(f => {
                const icon = f.rating === 'up' ? '👍' : '👎';
                html += `<div class="report-log-entry">
                    <span class="report-log-time">${fmt(f.time)}</span> ${icon}
                    "${f.phrase}"
                    ${f.heard ? `<span style="color:var(--text-muted)"> · heard: "${f.heard}"</span>` : ''}
                </div>`;
            });
            html += `</div>`;
        }

        // ---- CARER NOTES ----
        if (notes.length > 0) {
            html += `<div class="report-section"><div class="report-section-title">📝 Carer Notes</div>`;
            notes.reverse().forEach(n => {
                html += `<div class="report-log-entry"><span class="report-log-time">${fmtDate(n.time)} ${fmt(n.time)}</span><br>${n.note}</div>`;
            });
            html += `</div>`;
        }

        // ---- TOPIC LAUNCHER USAGE ----
        if (launches.length > 0) {
            html += `<div class="report-section"><div class="report-section-title">🗣️ Ryan Initiated (${launches.length})</div>`;
            launches.slice(-10).reverse().forEach(l => {
                html += `<div class="report-log-entry"><span class="report-log-time">${fmt(l.time)}</span> Topic: <strong>${l.topic}</strong> — "${l.starter}"</div>`;
            });
            html += `</div>`;
        }

        if (!totalSpoken && !errors.length && !notes.length) {
            html = `<div class="report-section"><div class="report-section-title">No data yet</div><p style="color:var(--text-secondary);font-size:14px">Start using the app and data will appear here. Conversation logs, errors, and feedback are all tracked automatically.</p></div>`;
        }

        document.getElementById('reportContent').innerHTML = html;
    },

    saveCarerNote() {
        const input = document.getElementById('carerNoteInput');
        const note = input.value.trim();
        if (!note) { showToast('Please type a note'); return; }
        addCarerNote(note);
        input.value = '';
        showToast('📝 Note saved', 'success');
        this.renderReport('today');
    },

    generateReportText(period) {
        const d = loadData();
        const now = Date.now();
        const cutoffs = {today:now-24*60*60*1000, week:now-7*24*60*60*1000, all:0};
        const cutoff = cutoffs[period||'week'] || 0;
        const fmt = (ts) => new Date(ts).toLocaleString('en-AU');

        const sessions = d.sessions.filter(s => s.start > cutoff);
        const convoLog = d.conversationLog.filter(l => l.time > cutoff);
        const errors = d.errorLog.filter(e => e.time > cutoff);
        const fb = d.feedback.filter(f => f.time > cutoff);
        const notes = d.carerNotes.filter(n => n.time > cutoff);
        const launches = d.topicLauncherLog.filter(l => l.time > cutoff);

        const totalSpoken = convoLog.length;
        const suggestedUsed = convoLog.filter(l => l.wasSuggested).length;
        const accuracy = totalSpoken > 0 ? Math.round(suggestedUsed/totalSpoken*100) : 0;
        const thumbsDown = fb.filter(f => f.rating==='down').length;

        const topicCounts = {};
        convoLog.forEach(l => { if (l.topic) topicCounts[l.topic] = (topicCounts[l.topic]||0)+1; });
        const topTopics = Object.entries(topicCounts).sort((a,b)=>b[1]-a[1]).slice(0,5);

        let report = `🛠️ RYAN'S AAC — DEVELOPER REPORT\n`;
        report += `Generated: ${new Date().toLocaleString('en-AU')}\n`;
        report += `Period: ${period === 'today' ? 'Today' : period === 'week' ? 'This Week' : 'All Time'}\n`;
        report += `${'='.repeat(50)}\n\n`;

        report += `📊 USAGE SUMMARY\n`;
        report += `Sessions: ${sessions.length}\n`;
        report += `Phrases spoken: ${totalSpoken}\n`;
        report += `From suggestions: ${suggestedUsed} (${accuracy}%)\n`;
        report += `From browsing: ${totalSpoken - suggestedUsed}\n`;
        report += `Topic Launcher used: ${launches.length} times\n`;
        report += `Wrong suggestions flagged: ${thumbsDown}\n\n`;

        if (topTopics.length) {
            report += `🎯 TOP TOPICS\n`;
            topTopics.forEach(([t,c]) => { report += `  ${t}: ${c} (${Math.round(c/totalSpoken*100)}%)\n`; });
            report += `\n`;
        }

        if (errors.length) {
            report += `❌ ERRORS & ISSUES (${errors.length})\n`;
            errors.slice(-20).forEach(e => {
                report += `  ${fmt(e.time)}\n`;
                report += `    Heard: "${e.heard||'unknown'}"\n`;
                report += `    Problem: ${e.problem}${e.wrongPhrase?' — "'+e.wrongPhrase+'"':''}${e.details?' — '+e.details:''}\n`;
                report += `    Topic: ${e.topic||'none'} | Context: ${e.context||'none'}\n\n`;
            });
        }

        if (convoLog.length) {
            report += `💬 CONVERSATION LOG (last 30)\n`;
            convoLog.slice(-30).forEach(l => {
                report += `  ${fmt(l.time)}\n`;
                if (l.heard) report += `    🎤 Heard: "${l.heard}"\n`;
                report += `    ${l.wasSuggested?'🎯':'📋'} Ryan said: "${l.chosen}" [${l.source||'browsed'}]\n`;
                if (l.suggestions?.length) report += `    Suggestions were: ${l.suggestions.slice(0,4).map(s=>'"'+s+'"').join(', ')}\n`;
                report += `\n`;
            });
        }

        if (launches.length) {
            report += `🗣️ RYAN INITIATED CONVERSATIONS\n`;
            launches.forEach(l => {
                report += `  ${fmt(l.time)} — Topic: ${l.topic} — "${l.starter}"\n`;
            });
            report += `\n`;
        }

        if (notes.length) {
            report += `📝 CARER NOTES\n`;
            notes.forEach(n => {
                report += `  ${fmt(n.time)}: ${n.note}\n`;
            });
            report += `\n`;
        }

        report += `${'='.repeat(50)}\n`;
        report += `Report generated by Ryan's AAC App\n`;
        return report;
    },

    exportReport() {
        const report = this.generateReportText('week');
        navigator.clipboard.writeText(report).then(() => {
            showToast('📋 Report copied!', 'success');
        }).catch(() => {
            const ta = document.createElement('textarea');
            ta.value = report; ta.style.position='fixed'; ta.style.left='-9999px';
            document.body.appendChild(ta); ta.select();
            try { document.execCommand('copy'); showToast('📋 Copied!', 'success'); } catch {}
            document.body.removeChild(ta);
        });
    },

    downloadReport() {
        const report = this.generateReportText('week');
        const blob = new Blob([report], {type:'text/plain'});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `ryans-aac-report-${new Date().toISOString().split('T')[0]}.txt`;
        document.body.appendChild(a); a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast('💾 Downloaded!', 'success');
    },

    emailReport() {
        const report = this.generateReportText('week');
        const toEmail = 'ibvava@gmail.com';
        const subject = encodeURIComponent(`Ryan's AAC Dev Report — ${new Date().toLocaleDateString('en-AU')}`);
        const body = encodeURIComponent(report);
        const mailtoUrl = `mailto:${toEmail}?subject=${subject}&body=${body}`;

        const win = window.open(mailtoUrl, '_blank');
        if (!win) {
            const a = document.createElement('a');
            a.href = mailtoUrl;
            a.target = '_blank';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        navigator.clipboard.writeText(report).catch(()=>{});
        showToast('📧 Opening Mail to ibvava@gmail.com (report also copied)', 'success');
    }
};

if ('serviceWorker' in navigator) navigator.serviceWorker.register('./sw.js').catch(()=>{});
window.addEventListener('DOMContentLoaded', () => app.init());
</script>
</body>
</html>
